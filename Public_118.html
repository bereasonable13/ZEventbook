<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>
        <?= appTitle ?> · Public
    </title>
    <?!= include('Styles'); ?>
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
</head>

<body>
    <main class="container">
        <header>
            <h1 id="title">(event)</h1>
            <div class="meta">
                <span id="date"></span>
                <span> · </span>
                <span id="flow"></span>
                <span> · </span>
                <span id="elim"></span>
                <span> · </span>
                <span id="seed"></span>
                <span id="statusBadge" style="margin-left:8px;"></span>
            </div>
        </header>

        <section>
            <h2>Schedule</h2>
            <table id="scheduleTbl" class="table">
                <thead>
                    <tr>
                        <th>When</th>
                        <th>Home</th>
                        <th>Away</th>
                        <th>Court</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="4" id="schedEmpty">Loading…</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>Standings</h2>
            <table id="standingsTbl" class="table">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Record</th>
                        <th>GB</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="3" id="standEmpty">Loading…</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>Bracket</h2>
            <div id="bracketWrap" class="bracket">Loading…</div>
        </section>
    </main>

    <script>
        /* ================= Public v4.1 ================= */

        /** 0) Config */
        const CONFIG = {
            REFRESH_MS: 20000,
            FIRST_LOAD_SPINNER_MS: 1200
        };

        /** 1) Params */
        const params = new URLSearchParams(location.search);
        const eventKey = params.get('event') || ''; // may be empty; server can default

        /** 2) RPC (hardened) */
        async function rpc(fn, ...args) {
            try {
                return await new Promise((res, rej) =>
                    google.script.run.withSuccessHandler(res).withFailureHandler(e => rej(new Error(e?.message || String(e))))[fn](...args)
                );
            } catch (err) {
                if (!navigator.onLine) throw new Error('offline');
                throw err;
            }
        }

        /** 3) DOM (defensive) */
        const els = {
            title: document.getElementById('title'),
            date: document.getElementById('date'),
            flow: document.getElementById('flow'),
            elim: document.getElementById('elim'),
            seed: document.getElementById('seed'),
            status: document.getElementById('statusBadge'),
            schedBody: document.querySelector('#scheduleTbl tbody'),
            standBody: document.querySelector('#standingsTbl tbody'),
            bracket: document.getElementById('bracketWrap'),
            schedEmpty: document.getElementById('schedEmpty'),
            standEmpty: document.getElementById('standEmpty'),
        };
        function must(el, id) { if (!el) throw new Error('Missing #' + id); return el; }
        ['title', 'date', 'flow', 'elim', 'seed', 'status', 'schedBody', 'standBody', 'bracket'].forEach(k => must(els[k], k));

        /** 4) Render helpers */
        function esc(s) { return String(s ?? '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }
        function renderRows(tbody, rows, tpl, colspan) {
            if (!tbody) return;
            tbody.innerHTML = (rows && rows.length)
                ? rows.map(tpl).join('')
                : `<tr><td colspan="${colspan}">No data yet</td></tr>`;
        }
        function rowSchedule(it) {
            return `<tr>
<td>${esc(it.when || '')}</td>
<td>${esc(it.home || '')}</td>
<td>${esc(it.away || '')}</td>
<td>${esc(it.court || '')}</td>
</tr>`;
        }
        function rowStanding(it) {
            const rec = `${it.w || 0}-${it.l || 0}`;
            return `<tr>
<td>${esc(it.team || '')}</td>
<td>${esc(rec)}</td>
<td>${esc(it.gb || '')}</td>
</tr>`;
        }
        function renderBracket(bundle) {
            // Placeholder; safe until you add real bracket drawing
            const hasRounds = Array.isArray(bundle?.rounds) && bundle.rounds.length;
            els.bracket.textContent = hasRounds ? 'Bracket ready.' : 'Bracket will appear here';
        }

        /** 5) First-load UX */
        let firstPaintDone = false;
        function firstLoadSpinnerOffSoon() {
            setTimeout(() => {
                if (els.schedEmpty) els.schedEmpty.textContent = 'No data yet';
                if (els.standEmpty) els.standEmpty.textContent = 'No data yet';
            }, CONFIG.FIRST_LOAD_SPINNER_MS);
        }

        /** 6) Refresh loop */
        async function refreshOnce() {
            try {
                const r = await rpc('getPublicBundle', eventKey);
                if (!r || !r.ok) throw new Error(r?.error || 'load failed');

                // Meta
                const m = r.eventMeta || {};
                els.title.textContent = m.name || '(event)';
                els.date.textContent = m.dateISO || '';
                els.flow.textContent = m.flow || 'Eventbook';
                els.elim.textContent = m.elimType || '';
                els.seed.textContent = m.seedMode || '';

                // Status badge (only show while not ready)
                if (!m.status || m.status === 'LINKS_READY') {
                    els.status.innerHTML = '';
                } else {
                    const text = (m.status === 'CREATED') ? 'Preparing workbook…' : 'Preparing links…';
                    els.status.innerHTML = `<span class="badge badge-warn">${text}</span>`;
                }

                // Tables + bracket
                renderRows(els.schedBody, r.schedule || [], rowSchedule, 4);
                renderRows(els.standBody, r.standings || [], rowStanding, 3);
                renderBracket(r.bracket || { type: m.elimType || 'single', rounds: [] });

                if (!firstPaintDone) { firstPaintDone = true; firstLoadSpinnerOffSoon(); }
            } catch (e) {
                // Quiet handling: keep last content; show a subtle badge only if offline
                if (String(e || '').includes('offline')) {
                    els.status.innerHTML = `<span class="badge badge-warn">Offline — showing cached view</span>`;
                }
                // Otherwise, no disruptive UI; try again on the next cycle
                // (optional: console.warn(e))
            }
        }

        function startLoop() {
            refreshOnce();
            setInterval(refreshOnce, CONFIG.REFRESH_MS);
        }

        document.addEventListener('DOMContentLoaded', startLoop);
    </script>
</body>

</html>