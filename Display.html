<!--
/************************************************************
* NextUp · Display.html — Suite Index
* [H01] Head / Meta (title, styles, SDK)
* [H02] Inline Styles (TV layout)
* [H03] Layout / DOM (header, stage, diag)
* [H04] State / Params / Refs
* [H05] Diagnostics helpers
* [H06] UI helpers (badges, qr/url render)
* [H07] Data loaders (bundle, links/QR)
* [H08] Polling control (backoff until verified)
* [H09] Boot (DOMContentLoaded)
* [H10] Diagnostics controls & cleanup
************************************************************/
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [H01] Head / Meta -->
  <meta charset="utf-8"/>
  <title><?= appTitle ?> · Display</title>
  <?!= include('Styles'); ?>
  <?!= include('NuSdk'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>

  <!-- [H02] Inline Styles -->
  <style>
    body { /* TV mode sizing */ }
    .tv { max-width: 1280px; margin: 0 auto; padding: 16px; }
    .stage {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 16px;
      align-items: start;
    }
    .qrbox { border:1px solid var(--line); border-radius:12px; background:#fff; padding:16px; }
    .qrbox img { display:block; width:100%; height:auto; }
    .panel { border:1px solid var(--line); border-radius:12px; background:#fff; padding:16px; }
    .msg { border:1px dashed var(--line); border-radius:8px; padding:12px; background:#fff; }
    .msg h3 { margin-top:0; }
    .slug { display:flex; flex-wrap:wrap; gap:.5rem; color:#333; }
    .slug .pill { border:1px solid var(--line); border-radius:999px; padding:2px 10px; font-weight:700; }

    .muted { color: var(--muted); }
    .row { display:flex; align-items:center; gap:8px; }
    .gap { gap:8px; }

    @media (max-width: 860px){
      .stage { grid-template-columns: 1fr; }
    }
    @media print { .diag, .actions { display:none !important; } }
  </style>
</head>
<body data-tv="1">
  <main class="tv container">
    <header>
      <h1 id="title" data-testid="display-title">(event)</h1>
      <div class="meta">
        <div class="slug">
          <span class="pill" id="namePill" data-testid="display-name">(name)</span>
          <span class="pill" id="datePill" data-testid="display-date">(date)</span>
        </div>
        <span id="statusBadge" style="margin-left:8px;" data-testid="display-status"></span>
      </div>
    </header>

    <!-- [H03] Layout / DOM: stage -->
    <section class="stage" aria-label="Display layout">
      <!-- Left: Public access (QR if verified, else URL text) -->
      <div class="qrbox" data-testid="display-public-card">
        <h2 class="row gap">
          Public Access
          <span id="qrState" class="badge" data-testid="display-public-badge">Loading…</span>
        </h2>
        <div id="qr" data-testid="display-public-qr">
          <div class="spinner" aria-label="Loading Public QR"></div>
        </div>
        <small id="url" class="muted" data-testid="display-public-url"></small>
      </div>

      <!-- Right: Info / Messaging (shows signup form link if available) -->
      <div class="panel" data-testid="display-info-card">
        <h2>Info</h2>
        <section class="msg" aria-label="Messaging">
          <h3 class="row gap">
            Messaging
            <span class="muted" id="msgHint" data-testid="display-msg-hint">Short info for attendees</span>
          </h3>
          <div id="msgBody" class="muted" data-testid="display-msg-body">
            Welcome! Scan the QR (when available) or use the link below.
          </div>
          <div id="signupBlock" class="row" style="margin-top:10px;" data-testid="display-signup-block">
            <!-- Filled when we can resolve a Form URL from quicklinks -->
          </div>
        </section>
      </div>
    </section>

    <!-- [H03] Layout / DOM: diagnostics -->
    <section class="diag collapsed" id="diag" aria-labelledby="diag-head" data-testid="diagnostics">
      <div class="diag-head">
        <h2 id="diag-head">Diagnostics</h2>
        <div class="diag-actions">
          <label class="diag-checkbox row">
            <input type="checkbox" id="chkLiveLogs" checked data-testid="diag-live-logs" />
            Live logs
          </label>
          <button class="btn" id="btnClearLogs" data-testid="diag-clear">Clear</button>
          <button class="btn" id="btnToggleDiag" data-testid="diag-toggle">Expand</button>
        </div>
      </div>
      <div class="diag-body" id="diagBody" role="log" aria-live="polite"></div>
    </section>
  </main>

  <script>
  /* =====================================================
   * [H04] State / Params / Refs
   * ===================================================== */
  const SDK = (typeof NUSDK !== 'undefined') ? NUSDK : {
    rpc: (fn, ...args) => new Promise((res, rej)=>{
      if (!google?.script?.run) return rej(new Error('RPC unavailable'));
      google.script.run.withSuccessHandler(res).withFailureHandler(e=>rej(new Error(e?.message||String(e))))[fn](...args);
    }),
    retry: async (fn, times=3, waits=[300,700,1200])=>{
      let last; for (let i=0;i<times;i++){ try{ return await fn(); } catch(e){ last=e; if (i<times-1) await new Promise(r=>setTimeout(r, waits[i]||500)); } } throw last;
    },
    toast: { info:console.log, error:console.error },
    esc: (s)=> String(s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]))
  };
  const { rpc, retry, toast, esc } = SDK;

  const params = new URLSearchParams(location.search);
  const eventKey = params.get('event') || '';

  const STATE = {
    qrVerified: false,
    lastUrl: '',
    pollTimer: null,
    pollMs: 4000,
    pollMaxMs: 20000
  };

  const els = {
    title: document.getElementById('title'),
    namePill: document.getElementById('namePill'),
    datePill: document.getElementById('datePill'),
    badge: document.getElementById('statusBadge'),

    qrState: document.getElementById('qrState'),
    qr: document.getElementById('qr'),
    url: document.getElementById('url'),

    msgBody: document.getElementById('msgBody'),
    signupBlock: document.getElementById('signupBlock'),

    diag: document.getElementById('diag'),
    diagBody: document.getElementById('diagBody'),
    btnClearLogs: document.getElementById('btnClearLogs'),
    btnToggleDiag: document.getElementById('btnToggleDiag'),
    chkLive: document.getElementById('chkLiveLogs')
  };

  /* =====================================================
   * [H05] Diagnostics helpers
   * ===================================================== */
  function log(msg, level){
    if (!els.chkLive.checked) return;
    const row = document.createElement('div');
    row.className = 'lvl-' + (level || 'info');
    row.textContent = new Date().toLocaleTimeString() + ' — ' + String(msg);
    els.diagBody.appendChild(row);
    els.diagBody.scrollTop = els.diagBody.scrollHeight;
  }
  function setDiagExpanded(expanded){
    els.diag.classList.toggle('collapsed', !expanded);
    els.btnToggleDiag.textContent = expanded ? 'Collapse' : 'Expand';
  }

  /* =====================================================
   * [H06] UI helpers (badges, QR/URL render)
   * ===================================================== */
  function setQRState(state){
    // loading | url | qr | absent
    const map = {
      loading:{ cls:'badge', text:'Loading…' },
      url:    { cls:'badge', text:'URL Ready' },
      qr:     { cls:'badge', text:'Verified QR' },
      absent: { cls:'badge badge-warn', text:'Configure' }
    };
    const v = map[state] || map.loading;
    els.qrState.className = v.cls;
    els.qrState.textContent = v.text;
  }
  function renderQrFromUrl(imgUrl, alt){
    if (!imgUrl) return;
    els.qr.innerHTML = `<img alt="${esc(alt||'Public QR')}" src="${esc(imgUrl)}" data-testid="qr-img" />`;
  }
  function renderURL(url){
    els.qr.innerHTML = `<div class="qr-fallback" data-testid="qr-fallback">${esc(url)}</div>`;
  }
  function renderGuidance(txt){
    els.qr.innerHTML = `<div class="qr-fallback" data-testid="qr-guidance">${esc(txt)}</div>`;
  }

  /* =====================================================
   * [H07] Data loaders
   * ===================================================== */
  async function loadBundleAndHeader(){
    // Code.gs getPublicBundle returns: { ok, eventTag, title, datePretty, place, ... }
    const r = await retry(()=> rpc('getPublicBundle', eventKey), 3, [300,700,1200]);
    if (!r?.ok) throw new Error(r?.error || 'bundle failed');

    const title = r.title || '(event)';
    const datePretty = r.datePretty || '';

    els.title.textContent = title;
    els.namePill.textContent = title;
    els.datePill.textContent = datePretty;
    els.badge.innerHTML = ''; // simple — not tracking status phases here

    // Try to surface a signup form link if available via QuickLinks
    try {
      const ql = await rpc('getEventQuickLinks', eventKey);
      const sb = els.signupBlock;
      sb.replaceChildren();
      if (ql && ql.formUrlView) {
        const lbl = document.createElement('div'); lbl.className='muted'; lbl.textContent='Signup form:';
        const a = document.createElement('a'); a.href=ql.formUrlView; a.target='_blank'; a.rel='noopener'; a.textContent=ql.formUrlView;
        sb.appendChild(lbl); sb.appendChild(a);
      } else {
        const hint = document.createElement('div'); hint.className='muted'; hint.textContent='No signup form yet. Enable it in Admin.';
        sb.appendChild(hint);
      }
    } catch (e) {
      log('quicklinks: ' + (e.message||e), 'warn');
    }
  }

  // Strict invariant: only show QR if server verifies a shortlink exists
  async function loadPublicQROnce(){
    setQRState('loading');

    // Preferred endpoint in v4.1.1
    if (google?.script?.run?.getShareQrVerified) {
      const r = await retry(()=> rpc('getShareQrVerified', eventKey), 3, [300,600,1200]);
      if (r?.ok) {
        if (r.qrUrlVerified) {
          renderQrFromUrl(r.qrUrlVerified, 'Public QR');
          els.url.textContent = r.url || '';
          setQRState('qr');
          STATE.qrVerified = true;
          return true;
        } else if (r.url) {
          // URL-only fallback, not yet verified → do NOT display a QR
          if (STATE.lastUrl !== r.url) {
            renderURL(r.url);
            els.url.textContent = r.url || '';
            STATE.lastUrl = r.url;
          }
          setQRState('url');
          STATE.qrVerified = false;
          return false;
        }
      }
      renderGuidance('Public link not ready. Check Admin.');
      els.url.textContent = '';
      setQRState('absent');
      STATE.qrVerified = false;
      return false;
    }

    // Legacy fallback (if verified endpoint not present): never show QR, only URL
    try {
      const ql = await rpc('getEventQuickLinks', eventKey);
      const url = ql?.publicUrl || '';
      if (url) {
        renderURL(url);
        els.url.textContent = url;
        setQRState('url');
        STATE.qrVerified = false;
        return false;
      }
    } catch(e){ /* ignore */ }

    renderGuidance('Public link not ready. Check Admin.');
    setQRState('absent');
    STATE.qrVerified = false;
    return false;
  }

  /* =====================================================
   * [H08] Polling control (backoff until verified)
   * ===================================================== */
  function startPolling(){
    stopPolling();
    STATE.pollTimer = setTimeout(async () => {
      try {
        const ok = await loadPublicQROnce();
        if (!ok) {
          STATE.pollMs = Math.min(STATE.pollMs + 2000, STATE.pollMaxMs);
          startPolling();
        }
      } catch (e) {
        log('poll error: '+(e.message||e), 'error');
        STATE.pollMs = Math.min(STATE.pollMs + 2000, STATE.pollMaxMs);
        startPolling();
      }
    }, STATE.pollMs);
  }
  function stopPolling(){
    if (STATE.pollTimer) { clearTimeout(STATE.pollTimer); STATE.pollTimer = null; }
  }

  /* =====================================================
   * [H09] Boot
   * ===================================================== */
  document.addEventListener('DOMContentLoaded', async ()=>{
    setDiagExpanded(false);

    if (!eventKey){
      els.title.textContent = '(no event)';
      els.namePill.textContent = '(name)';
      els.datePill.textContent = '(date)';
      renderGuidance('Add ?event=<id-or-slug> to the URL.');
      setQRState('absent');
      return;
    }

    try {
      await loadBundleAndHeader();
    } catch(e){
      log('loadBundle: ' + (e.message || e), 'error');
      toast.error('Failed to load event');
    }

    try {
      const verified = await loadPublicQROnce();
      if (!verified) startPolling(); else stopPolling();
    } catch(e){
      log('loadPublicQROnce: ' + (e.message || e), 'error');
      renderGuidance('Error loading Public link.');
      setQRState('absent');
      startPolling();
    }

    if (toast?.info) toast.info('Display ready');
  });

  /* =====================================================
   * [H10] Diagnostics controls & cleanup
   * ===================================================== */
  document.getElementById('btnClearLogs').onclick = ()=> els.diagBody.replaceChildren();
  document.getElementById('btnToggleDiag').onclick = ()=> setDiagExpanded(els.diag.classList.contains('collapsed'));
  window.addEventListener('beforeunload', stopPolling);
  </script>
</body>
</html>