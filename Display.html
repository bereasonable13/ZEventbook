<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>
        <?= appTitle ?> ¬∑ Display
    </title>
    <?!= include('Styles'); ?>
    <style>
        /* TV-first layout; toggled by body.is-tv */
        header.appbar {
            display: none;
        }

        body:not(.is-tv) header.appbar {
            display: block;
        }

        .board {
            display: grid;
            gap: 14px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 980px) {
            .board {
                grid-template-columns: 1.2fr .8fr;
            }
        }

        .panel {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
        }

        .panel h2 {
            margin: 0 0 8px;
            font-size: 1.25rem;
        }

        .big {
            font-size: clamp(1.1rem, 2.2vw, 1.6rem);
            line-height: 1.25;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            border-top: 1px solid var(--border);
            padding: 8px 6px;
            text-align: left;
        }

        .table th {
            font-weight: 700;
        }

        .small {
            color: var(--muted);
            font-size: .95rem;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border: 1px solid var(--border);
            border-radius: 999px;
            font-size: .8rem
        }

        header.tvbar {
            display: flex;
            gap: 12px;
            align-items: baseline;
            justify-content: space-between;
            margin: 8px 0 12px;
        }

        #evName {
            font-weight: 900;
            font-size: clamp(1.2rem, 3.2vw, 2rem);
            letter-spacing: -.02em;
        }

        #meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <header class="appbar">
        <div class="appbar__title">
            <?= appTitle ?> ¬∑ Display
        </div>
    </header>

    <main class="container">

        <!-- Toast + Busy -->
        <div id="toast" class="toast" style="display:none;" role="status" aria-live="polite"></div>
        <div id="busy"
            style="position:fixed; inset:0; display:none; place-items:center; z-index:3000; background:rgba(0,0,0,.45);">
            <div class="card"
                style="background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px 16px; display:flex; gap:10px; align-items:center;">
                <div style="font-size:1.6rem; display:flex; gap:8px;"><span>üèÉ‚Äç‚ôÇÔ∏è</span><span>ü•é</span><span>üß∂</span>
                </div>
                <div class="msg" style="font-weight:800;">Refreshing‚Ä¶</div>
            </div>
        </div>

        <!-- TV header -->
        <header class="tvbar">
            <div id="evName">Event</div>
            <div id="meta" class="small">
                <span id="evDate"></span>
                <span>‚Ä¢</span>
                <span id="evFlow"></span>
                <span>‚Ä¢</span>
                <span>Signups: <b id="evSignups">0</b></span>
                <span>‚Ä¢</span>
                <span id="lastUpdated"></span>
            </div>
        </header>

        <div class="board">

            <!-- Standings -->
            <section class="panel" id="standingsSec" style="display:none;">
                <h2>Standings</h2>
                <table class="table big" id="standingsTbl" aria-label="Standings">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Team</th>
                            <th>W</th>
                            <th>L</th>
                            <th>Pct</th>
                            <th>PF</th>
                            <th>PA</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="small">Order from server (Win% ‚Üí point diff ‚Üí PF)</div>
            </section>

            <!-- Upcoming / Live -->
            <section class="panel" id="upcomingSec" style="display:none;">
                <h2>Upcoming & Live</h2>
                <table class="table big" id="upcomingTbl" aria-label="Upcoming">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Court</th>
                            <th>Match</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>

            <!-- Bracket (compact) -->
            <section class="panel" id="bracketSec" style="display:none;">
                <h2>Bracket</h2>
                <div id="bracketWrap" class="big"></div>
            </section>

        </div>
    </main>

    <script>
        // ---------- Utilities ----------
        const $ = (s, p = document) => p.querySelector(s);
        function toast(msg, ok = true) { const t = $('#toast'); if (!t) return; t.textContent = msg; t.style.display = 'block'; t.className = 'toast ' + (ok ? 'ok' : 'danger'); setTimeout(() => t.style.display = 'none', 2000); }
        function setBusy(on, message) { const b = $('#busy'); if (!b) return; const m = b.querySelector('.msg'); if (m && message) m.textContent = message; b.style.display = on ? 'grid' : 'none'; }

        // ---------- Boot identity + tv mode ----------
        const URLQ = new URLSearchParams(location.search);
        const SERVER_SLUG = "<?= slug ?>";
        const BOOT_ID = 
        (window.eventId && String(window.eventId).trim()) || 
        URLQ.get('eventId') ||
        URLQ.get('event') ||
        URLQ.get('slug') ||
        (SERVER_SLUG) || '');
        const TVMODE = URLQ.get('tv') === '1';
        document.addEventListener('DOMContentLoaded', () => document.body.classList.toggle('is-tv', TVMODE));

        let _poll = null;
        function startPoll() { if (_poll) return; _poll = setInterval(fetchBundle, 20000); }
        function stopPoll() { if (_poll) { clearInterval(_poll); _poll = null; } }
        document.addEventListener('visibilitychange', () => { document.hidden ? stopPoll() : startPoll(); });

        // ---------- Renderers ----------
        function renderHeader(b) {
            const meta = b?.eventMeta || {};
            $('#evName').textContent = meta.name || 'Event';
            $('#evDate').textContent = meta.date || '';
            const flowMap = { SEASON_TOURNEY: 'Season ‚Üí Tournament', SEASON_ONLY: 'Season only', TOURNEY_ONLY: 'Tournament only', REGISTRATION: 'Signups only' };
            $('#evFlow').textContent = flowMap[meta.flow] || (meta.flow || '');
            $('#evSignups').textContent = (b?.counts?.signups ?? 0);
            $('#lastUpdated').textContent = b?.lastUpdated ? new Date(b.lastUpdated).toLocaleTimeString() : '';
        }

        function renderStandings(list) {
            const sec = $('#standingsSec'), tb = $('#standingsTbl tbody');
            tb.innerHTML = '';
            if (!Array.isArray(list) || !list.length) { sec.style.display = 'none'; return; }
            // IMPORTANT: Keep server order
            list.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.Rank ?? ''}</td><td>${r.Team ?? ''}</td><td>${r.W ?? 0}</td><td>${r.L ?? 0}</td>
<td>${(r.Pct != null) ? (r.Pct * 100).toFixed(1) + '%' : ''}</td><td>${r.PointsFor ?? 0}</td><td>${r.PointsAgainst ?? 0}</td>`;
                tb.appendChild(tr);
            });
            sec.style.display = '';
        }

        function renderUpcoming(rows) {
            const sec = $('#upcomingSec'), tb = $('#upcomingTbl tbody'); tb.innerHTML = '';
            if (!Array.isArray(rows) || !rows.length) { sec.style.display = 'none'; return; }
            // Show non-final first; then most recent finals (few)
            const nonFinal = rows.filter(r => String(r.Status || '').toLowerCase() !== 'final');
            const finals = rows.filter(r => String(r.Status || '').toLowerCase() === 'final').slice(-4); // last few
            const show = nonFinal.concat(finals);
            if (!show.length) { sec.style.display = 'none'; return; }
            show.forEach(r => {
                const status = String(r.Status || '');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.Time || ''}</td><td>${r.Court || ''}</td><td>${r['Team A'] || ''} vs ${r['Team B'] || ''}</td>
<td>${status.toLowerCase() === 'final' ? '<span class="badge">final</span>' : status}</td>`;
                tb.appendChild(tr);
            });
            sec.style.display = '';
        }

        function renderBracket(br) {
            const sec = $('#bracketSec'), wrap = $('#bracketWrap'); wrap.innerHTML = '';
            const rounds = br?.rounds || [];
            if (!rounds.length) { sec.style.display = 'none'; return; }
            // Compact list per round
            rounds.forEach(r => {
                const div = document.createElement('div');
                div.style.marginBottom = '12px';
                const title = document.createElement('div'); title.style.fontWeight = '800'; title.textContent = r.name;
                div.appendChild(title);
                (r.matches || []).forEach(m => {
                    const line = document.createElement('div');
                    const a = m.slots?.find(s => s.slot === 1), b = m.slots?.find(s => s.slot === 2);
                    const tA = a ? (a.team || `Seed ${a.seed || ''}`) : '‚Äî';
                    const tB = b ? (b.team || `Seed ${b.seed || ''}`) : '‚Äî';
                    const scA = a?.score || '', scB = b?.score || '';
                    const st = a?.status || b?.status || '';
                    line.textContent = `M${m.match}: ${tA} ${scA ? `(${scA})` : ''} vs ${tB} ${scB ? `(${scB})` : ''} ${st ? `¬∑ ${st}` : ''}`;
                    div.appendChild(line);
                });
                wrap.appendChild(div);
            });
            sec.style.display = '';
        }

        function renderBundle(b) {
            renderHeader(b);
            renderStandings(b?.standings || []);
            renderUpcoming(b?.schedule || []);
            renderBracket(b?.bracket || { rounds: [] });
        }

        // ---------- Data fetch ----------
        function fetchBundle(id = BOOT_ID) {
            if (!id) { toast('No event specified', false); return; }
            setBusy(true, 'Refreshing‚Ä¶');
            google.script.run
                .withSuccessHandler(b => { try { renderBundle(b); } finally { setBusy(false); } })
                .withFailureHandler(err => { console.error(err); toast('Failed to refresh', false); setBusy(false); })
                .getPublicBundle(id);
        }

        // ---------- Boot ----------
        document.addEventListener('DOMContentLoaded', () => { if (BOOT_ID) { fetchBundle(); startPoll(); } else { toast('No event specified', false); } });
    </script>
</body>

</html>
