<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title><?= appTitle ?> · Poster</title>
  <?!= include('Styles'); ?>
  <?!= include('NuSdk'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    .poster { max-width: 840px; margin: 0 auto; padding: 16px; }
    .qrgrid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:start; }
    .qrbox { border:1px solid var(--line); border-radius:8px; padding:12px; background:#fff; }
    .qrbox img { display:block; width:240px; max-width:100%; height:auto; margin:auto; }
    .row { display:flex; align-items:center; gap:8px; }
    .gap { gap:8px; }
    .muted { color: var(--muted); }
    .qr-fallback { padding:10px; border:1px dashed var(--line); border-radius:6px; word-break:break-all; }
    @media (max-width: 760px){ .qrgrid { grid-template-columns: 1fr; } }
    @media print { .pfbar, .diag, .actions { display:none !important; } }
  </style>
</head>
<body>
  <main class="poster">
    <header>
      <h1 id="posterTitle" data-testid="poster-title">(event)</h1>
      <div class="meta">
        <small id="eventDate" data-testid="poster-date"></small>
        <span id="statusBadge" style="margin-left:8px;" data-testid="poster-status"></span>
        <small id="posterModeBadge" style="margin-left:8px;" class="muted" data-testid="poster-mode"></small>
      </div>
    </header>

    <!-- Optional compact preflight/status mount -->
    <div id="pfMount"></div>

    <section class="qrgrid" aria-label="Poster QRs/Links">
      <!-- Public -->
      <div class="qrbox" data-testid="qrbox-public">
        <h3 class="row gap">
          Public Page
          <span class="badge" id="publicBadge" data-testid="public-badge">Loading…</span>
        </h3>
        <div id="qrPublic" data-testid="public-qr">
          <div class="spinner" aria-label="Loading Public QR"></div>
        </div>
        <small id="publicUrlLabel" class="muted" data-testid="public-url"></small>
      </div>

      <!-- Signup -->
      <div class="qrbox" data-testid="qrbox-signup">
        <h3 class="row gap">
          Signups (Form)
          <span class="badge" id="signupBadge" data-testid="signup-badge">Loading…</span>
        </h3>
        <div id="qrSignup" data-testid="signup-qr">
          <div class="spinner" aria-label="Loading Signup QR"></div>
        </div>
        <small id="signupUrlLabel" class="muted" data-testid="signup-url"></small>
      </div>
    </section>

    <section aria-label="Poster Tips">
      <p class="muted" data-testid="poster-tip">
        We only show a QR code once its link is <strong>verified</strong>. Until then you’ll see the URL as a fallback so you can still share it.
      </p>
    </section>

    <!-- Diagnostics -->
    <section class="diag collapsed" id="diag" aria-labelledby="diag-head" data-testid="diagnostics">
      <div class="diag-head">
        <h2 id="diag-head">Diagnostics</h2>
        <div class="diag-actions">
          <label class="diag-checkbox row">
            <input type="checkbox" id="chkLiveLogs" checked data-testid="diag-live-logs" />
            Live logs
          </label>
          <button class="btn" id="btnClearLogs" data-testid="diag-clear">Clear</button>
          <button class="btn" id="btnToggleDiag" data-testid="diag-toggle">Expand</button>
        </div>
      </div>
      <div class="diag-body" id="diagBody" role="log" aria-live="polite"></div>
    </section>
  </main>

  <script>
  /* ===== Poster v4.1.1a (strict QR invariant + resilient backoff) ===== */
  const { rpc, retry, toast, esc } = NUSDK;

  // Params
  const params = new URLSearchParams(location.search);
  const eventKey = params.get('event') || '';
  const mode = (params.get('mode') || 'image').toLowerCase(); // 'image' | 'text' (label only)

  // Elements
  const els = {
    title: document.getElementById('posterTitle'),
    date: document.getElementById('eventDate'),
    badge: document.getElementById('statusBadge'),
    modeBadge: document.getElementById('posterModeBadge'),
    pfMount: document.getElementById('pfMount'),

    qrPublic: document.getElementById('qrPublic'),
    publicUrlLabel: document.getElementById('publicUrlLabel'),
    publicBadge: document.getElementById('publicBadge'),

    qrSignup: document.getElementById('qrSignup'),
    signupUrlLabel: document.getElementById('signupUrlLabel'),
    signupBadge: document.getElementById('signupBadge'),

    diag: document.getElementById('diag'),
    diagBody: document.getElementById('diagBody'),
    btnClearLogs: document.getElementById('btnClearLogs'),
    btnToggleDiag: document.getElementById('btnToggleDiag'),
    chkLive: document.getElementById('chkLiveLogs')
  };

  /* --------------- Diagnostics helpers --------------- */
  function log(msg, level){
    if (!els.chkLive.checked) return;
    const row = document.createElement('div');
    row.className = 'lvl-' + (level || 'info');
    row.textContent = new Date().toLocaleTimeString() + ' — ' + String(msg);
    els.diagBody.appendChild(row);
    els.diagBody.scrollTop = els.diagBody.scrollHeight;
  }
  function setDiagExpanded(expanded){
    els.diag.classList.toggle('collapsed', !expanded);
    els.btnToggleDiag.textContent = expanded ? 'Collapse' : 'Expand';
  }
  document.getElementById('btnClearLogs').onclick = ()=> els.diagBody.replaceChildren();
  document.getElementById('btnToggleDiag').onclick = ()=> setDiagExpanded(els.diag.classList.contains('collapsed'));

  /* --------------- UI helpers --------------- */
  function setBadge(el, state){
    // state: loading | absent | url | qr
    const map = {
      loading: { cls:'badge', text:'Loading…' },
      absent:  { cls:'badge badge-warn', text:'Configure' },
      url:     { cls:'badge', text:'URL Ready' },
      qr:      { cls:'badge', text:'Verified QR' }
    };
    const b = map[state] || map.loading;
    el.className = b.cls;
    el.textContent = b.text;
  }
  function renderQR(container, b64, alt){
    if (!b64) return;
    container.innerHTML = `<img alt="${esc(alt||'QR')}" src="data:image/png;base64,${b64}" data-testid="qr-img" />`;
  }
  function renderURLFallback(container, url){
    container.innerHTML = `<div class="qr-fallback" data-testid="qr-fallback">${esc(url)}</div>`;
  }
  function renderGuidance(container, text){
    container.innerHTML = `<div class="qr-fallback" data-testid="qr-guidance">${esc(text)}</div>`;
  }

  /* --------------- Meta --------------- */
  async function loadMeta(){
    const r = await retry(()=> rpc('getPublicBundle', eventKey), 3, [300,700,1200]);
    if (!r?.ok) throw new Error(r?.error || 'bundle failed');
    const m = r.eventMeta || {};
    els.title.textContent = m.name || '(event)';
    els.date.textContent = m.dateISO || '';
    els.modeBadge.textContent = mode === 'text' ? 'Poster: Text mode' : 'Poster: Image mode';
    if (!m.status || m.status === 'LINKS_READY') {
      els.badge.innerHTML = '';
    } else {
      const text = (m.status === 'CREATED') ? 'Preparing workbook…' : 'Preparing links…';
      els.badge.innerHTML = `<span class="badge badge-warn">${esc(text)}</span>`;
    }
  }

  /* --------------- Public (strict QR invariant) --------------- */
  const POLL = { publicMs: 4000, signupMs: 4000, maxMs: 20000, tPub: null, tSign: null };

  async function loadPublicOnce(){
    setBadge(els.publicBadge, 'loading');
    const r = await retry(()=> rpc('getShareQr', eventKey), 3, [300,600,1200]);
    if (r?.ok === true) {
      if (r.qrB64) {
        renderQR(els.qrPublic, r.qrB64, 'Public QR');
        els.publicUrlLabel.textContent = r.url || '';
        setBadge(els.publicBadge, 'qr');
        return true; // verified
      } else if (r.url) {
        renderURLFallback(els.qrPublic, r.url);
        els.publicUrlLabel.textContent = r.url || '';
        setBadge(els.publicBadge, 'url');
        return false; // not yet verified
      }
    }
    renderGuidance(els.qrPublic, 'Public link not ready. Configure in Admin.');
    els.publicUrlLabel.textContent = '';
    setBadge(els.publicBadge, 'absent');
    return false;
  }

  function schedulePublicPoll(){
    clearTimeout(POLL.tPub);
    POLL.publicMs = Math.min(POLL.publicMs + 2000, POLL.maxMs);
    POLL.tPub = setTimeout(async () => {
      try {
        const ok = await loadPublicOnce();
        if (!ok) schedulePublicPoll();
      } catch (e) {
        log('public poll error: ' + (e.message||e), 'error');
        schedulePublicPoll();
      }
    }, POLL.publicMs);
  }

  /* --------------- Signup (URL first, QR when verified) --------------- */
  async function loadSignupOnce(){
    setBadge(els.signupBadge, 'loading');
    const r = await rpc('getSignupQr', eventKey);
    if (r?.ok === true) {
      if (r.qrB64) {
        renderQR(els.qrSignup, r.qrB64, 'Signup QR');
        els.signupUrlLabel.textContent = r.url || '';
        setBadge(els.signupBadge, 'qr');
        return true; // verified
      } else if (r.url) {
        renderURLFallback(els.qrSignup, r.url);
        els.signupUrlLabel.textContent = r.url || '';
        setBadge(els.signupBadge, 'url');
        return false; // not yet verified
      }
    }
    renderGuidance(els.qrSignup, 'Enable “Include signup” in Admin, then create/verify.');
    els.signupUrlLabel.textContent = '';
    setBadge(els.signupBadge, 'absent');
    return false;
  }

  function scheduleSignupPoll(){
    clearTimeout(POLL.tSign);
    POLL.signupMs = Math.min(POLL.signupMs + 2000, POLL.maxMs);
    POLL.tSign = setTimeout(async () => {
      try {
        const ok = await loadSignupOnce();
        if (!ok) scheduleSignupPoll();
      } catch (e) {
        log('signup poll error: ' + (e.message||e), 'error');
        scheduleSignupPoll();
      }
    }, POLL.signupMs);
  }

  function stopPolling(){
    clearTimeout(POLL.tPub); clearTimeout(POLL.tSign);
    POLL.tPub = POLL.tSign = null;
  }

  /* --------------- Boot --------------- */
  document.addEventListener('DOMContentLoaded', async ()=>{
    setDiagExpanded(false);

    if (!eventKey) {
      els.title.textContent = '(no event)';
      els.date.textContent = '';
      els.modeBadge.textContent = '';
      renderGuidance(els.qrPublic, 'Add ?event=<id-or-slug> to the URL.');
      renderGuidance(els.qrSignup, 'Add ?event=<id-or-slug> to the URL.');
      setBadge(els.publicBadge, 'absent');
      setBadge(els.signupBadge, 'absent');
      return;
    }

    try { await loadMeta(); } catch(e){ log('loadMeta: '+(e.message||e), 'error'); toast.error('Failed to load event'); }

    try {
      const pubOk = await loadPublicOnce();
      if (!pubOk) schedulePublicPoll();
    } catch(e){ log('public first-load: '+(e.message||e), 'error'); schedulePublicPoll(); }

    try {
      const signOk = await loadSignupOnce();
      if (!signOk) scheduleSignupPoll();
    } catch(e){ log('signup first-load: '+(e.message||e), 'error'); scheduleSignupPoll(); }

    toast.info('Poster ready');
  });

  window.addEventListener('beforeunload', stopPolling);
  </script>
</body>
</html>