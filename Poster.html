<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>
        <?= appTitle ?> ¬∑ Poster
    </title>
    <?!= include('Styles'); ?>
    <style>
        /* Poster-specific quick styles (builds on global tokens) */
        :root {
            --poster-max: 980px;
        }

        body {
            background: var(--bg);
        }

        header.appbar {
            display: none;
        }

        /* chrome-free poster */
        main.poster {
            max-width: var(--poster-max);
            margin: 24px auto 48px;
            padding: 0 16px;
            text-align: center;
        }

        #pTitle {
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: -0.02em;
            margin: 8px 0 4px;
            font-size: clamp(2rem, 4vw + 1rem, 3.5rem);
        }

        #pDate {
            font-size: clamp(1.1rem, 1.2rem + 0.5vw, 1.6rem);
            color: var(--muted);
            margin-bottom: 18px;
        }

        #metaRow {
            display: flex;
            justify-content: center;
            gap: 18px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .tile--soft {
            background: var(--surface);
        }

        #qrRow {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            align-items: start;
            justify-items: center;
        }

        .qr-block {
            display: grid;
            gap: 8px;
            justify-items: center;
        }

        .qr .qr-img {
            width: 280px;
            height: 280px;
        }

        .section-caption {
            font-weight: 700;
        }

        #publicUrl,
        #formUrl {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 0.98rem;
            word-break: break-all;
            max-width: 680px;
        }

        @media (min-width: 760px) {
            #qrRow {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media print {
            body {
                background: #fff;
            }

            main.poster {
                margin: 0;
                padding: 0;
                max-width: 100%;
            }

            #pTitle {
                font-size: 3.6rem;
            }

            #pDate {
                font-size: 1.6rem;
            }

            #qrRow {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .qr .qr-img {
                width: 320px;
                height: 320px;
            }

            .toast,
            #busy {
                display: none !important;
            }
        }
    </style>
</head>

<body>

    <main class="poster">
        <!-- Busy overlay (shares tokens with other views) -->
        <div id="busy"
            style="display:none; position:fixed; inset:0; display:none; place-items:center; z-index:4000; background:rgba(0,0,0,.45);">
            <div class="card"
                style="background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px 16px; display:flex; gap:10px; align-items:center;">
                <div class="spinner" style="font-size:1.6rem; line-height:1; display:flex; gap:8px;">
                    <span>üèÉ‚Äç‚ôÇÔ∏è</span><span>ü•é</span><span>üß∂</span>
                </div>
                <div class="msg" style="font-weight:800;">Preparing poster‚Ä¶</div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="toast" style="display:none;" role="status" aria-live="polite"></div>

        <!-- Title + date -->
        <h1 id="pTitle">Event</h1>
        <div id="pDate" aria-label="Event date"></div>

        <!-- Optional mini stats row -->
        <div id="metaRow" aria-label="Quick stats" style="display:none;">
            <div class="tile tile--soft" id="mSignups" style="display:none;">0 signups</div>
            <div class="tile tile--soft" id="mFlow" style="display:none;"></div>
        </div>

        <!-- QR blocks -->
        <section id="qrRow" aria-label="QR codes">
            <div class="qr-block" id="blockPublic">
                <div class="qr" id="qrPublic"><!-- img injected --></div>
                <div class="section-caption">Public link</div>
                <div id="publicUrl" class="hint"></div>
            </div>
            <div class="qr-block" id="blockForm" style="display:none;">
                <div class="qr" id="qrForm"><!-- img injected --></div>
                <div class="section-caption">Signup form</div>
                <div id="formUrl" class="hint"></div>
            </div>
        </section>

        <!-- Footer hint -->
        <p class="hint" style="margin-top:18px;">Tip: print and post this near courts/entrances ‚Äî the QR updates as
            links change.</p>
    </main>

    <script>
        // ---------- Utilities ----------
        const $ = (s, p = document) => p.querySelector(s);
        function toast(msg, ok = true) {
            const t = $('#toast'); if (!t) return;
            t.textContent = msg;
            t.style.display = 'block';
            t.className = 'toast ' + (ok ? 'ok' : 'danger');
            setTimeout(() => t.style.display = 'none', 2400);
        }
        function setBusy(on, message) {
            const ov = $('#busy'); if (!ov) return;
            const m = ov.querySelector('.msg'); if (m && message) m.textContent = message;
            ov.style.display = on ? 'grid' : 'none';
        }
        function setQR(el, url, size = 280) {
            if (!el) return;
            el.innerHTML = '';
            if (!url) { el.classList.add('muted'); return; }
            const img = new Image();
            img.alt = 'QR';
            img.width = size; img.height = size;
            img.className = 'qr-img';
            img.src = 'https://chart.googleapis.com/chart?cht=qr&chs=' + size + 'x' + size + '&chl=' + encodeURIComponent(url);
            el.appendChild(img);
        }

        // ---------- Boot identity (eventId or slug) ----------
        const URLQ = new URLSearchParams(location.search);
        const SERVER_SLUG = "<?= slug ?>";
        const BOOT_ID = 
        (window.eventId && String(window.eventId).trim()) || 
        URLQ.get('eventId') ||
        URLQ.get('event') ||
        URLQ.get('slug') ||
        SERVER_SLUG || '');

        // ---------- Renderers ----------
        function renderMeta(bundle) {
            const name = bundle?.eventMeta?.name || 'Event';
            const date = bundle?.eventMeta?.date || '';
            const flow = bundle?.eventMeta?.flow || '';
            const signups = Number(bundle?.counts?.signups || 0);

            $('#pTitle').textContent = name;
            $('#pDate').textContent = date;

            // optional stat chips
            let any = false;
            if ($('#mSignups')) {
                $('#mSignups').style.display = '';
                $('#mSignups').textContent = `${signups} signup${signups === 1 ? '' : 's'}`;
                any = true;
            }
            if (flow && $('#mFlow')) {
                const map = { 'SEASON_TOURNEY': 'Season ‚Üí Tournament', 'SEASON_ONLY': 'Season only', 'TOURNEY_ONLY': 'Tournament only', 'REGISTRATION': 'Signups only' };
                $('#mFlow').style.display = '';
                $('#mFlow').textContent = map[flow] || flow;
                any = true;
            }
            if (any) $('#metaRow').style.display = 'flex';
        }

        function renderLinks(links) {
            const pUrl = links?.publicUrl || '';
            const fUrl = links?.formUrl || '';

            // Public
            setQR($('#qrPublic'), pUrl, 280);
            $('#publicUrl').textContent = pUrl || '';

            // Form (optional)
            if (fUrl) {
                $('#blockForm').style.display = 'grid';
                setQR($('#qrForm'), fUrl, 280);
                $('#formUrl').textContent = fUrl || '';
            } else {
                $('#blockForm').style.display = 'none';
            }
        }

        function boot() {
            if (!BOOT_ID) { toast('No event specified', false); return; }
            setBusy(true, 'Loading‚Ä¶');
            google.script.run
                .withSuccessHandler(bundle => {
                    try {
                        renderMeta(bundle);
                        // Use server canonical links (handles UTMs/shape)
                        google.script.run
                            .withSuccessHandler(renderLinks)
                            .withFailureHandler(err => { console.error(err); toast('Link prep failed', false); })
                            .getShareLinks(bundle?.eventMeta?.eventId || BOOT_ID);
                    } finally {
                        setBusy(false);
                    }
                })
                .withFailureHandler(err => { console.error(err); toast('Load failed', false); setBusy(false); })
                .getPublicBundle(BOOT_ID);
        }

        document.addEventListener('DOMContentLoaded', boot);
    </script>
</body>

</html>
