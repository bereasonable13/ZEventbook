<!--
/************************************************************
* NextUp · Poster.html — Multi-Config Analytics Suite
* [H01] Head / Meta (title, styles, SDK)
* [H02] Inline Styles (responsive grid layout)
* [H03] Layout / DOM (header, poster image, qr grid, diagnostics)
* [H04] Params / State / Refs (poster ID, geo tracking)
* [H05] Diagnostics helpers (live log, expand/collapse)
* [H06] UI helpers (badges, QR/URL render, guidance)
* [H07] Data loaders (poster config, QR verification)
* [H08] Analytics tracking (scan events, geo logging)
* [H09] One-shot verification (no polling)
* [H10] Boot (DOMContentLoaded)
* [H11] Cleanup + diag controls
************************************************************/
-->

<!DOCTYPE html>

<html lang="en">
<head>
  <!-- [H01] Head / Meta -->
  <meta charset="utf-8" />
  <title><?= appTitle ?> · Poster</title>
  <?!= include('Styles'); ?>
  <?!= include('NuSdk'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- [H02] Inline Styles -->

  <style>
    .poster { max-width: 1200px; margin: 0 auto; padding: 16px; }
    
    /* Poster image section */
    .poster-image-section {
      margin: 24px 0;
      border-radius: 12px;
      overflow: hidden;
      background: var(--card);
      border: 1px solid var(--line);
    }
    .poster-image-section img {
      width: 100%;
      height: auto;
      display: block;
    }
    .no-poster-image {
      padding: 40px;
      text-align: center;
      color: var(--muted);
    }
    
    /* QR grid - responsive for up to 3 QR codes */
    .qrgrid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px; 
      align-items: start; 
    }
    
    .qrbox { 
      border: 2px solid var(--line); 
      border-radius: 12px; 
      padding: 16px; 
      background: var(--card);
      transition: border-color 0.2s;
    }
    
    .qrbox.verified {
      border-color: var(--ok);
    }
    
    .qrbox img { 
      display: block; 
      width: 100%; 
      max-width: 280px; 
      height: auto; 
      margin: 12px auto;
      image-rendering: crisp-edges;
    }
    
    .qrbox h3 {
      margin-top: 0;
      font-size: 1.1rem;
    }
    
    .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .gap { gap: 8px; }
    .muted { color: var(--muted); }
    
    .qr-fallback { 
      padding: 12px; 
      border: 1px dashed var(--line); 
      border-radius: 8px; 
      word-break: break-all;
      font-size: 0.9rem;
      background: var(--bg);
    }
    
    /* Analytics info */
    .analytics-info {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--line);
      font-size: 0.85rem;
    }
    
    .analytics-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }
    
    /* Poster metadata */
    .poster-meta {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 12px;
      margin: 16px 0;
      font-size: 0.9rem;
    }
    
    @media (max-width: 760px) { 
      .qrgrid { grid-template-columns: 1fr; } 
    }
    
    @media print { 
      .pfbar, .diag, .actions, .poster-meta { display: none !important; } 
    }
  </style>

</head>
<body>
  <main class="poster">
    <!-- [H03] Layout / DOM: Header -->
    <header>
      <h1 id="posterTitle" data-testid="poster-title">(event)</h1>
      <div class="meta">
        <small id="eventDate" data-testid="poster-date"></small>
        <span id="statusBadge" style="margin-left:8px;" data-testid="poster-status"></span>
      </div>
    </header>

```
<!-- [H03] Layout / DOM: Poster metadata -->
<div class="poster-meta" id="posterMetaSection" style="display:none;">
  <div class="row" style="justify-content: space-between;">
    <div>
      <strong>Poster ID:</strong> <code id="posterId"></code>
    </div>
    <div>
      <strong>Location:</strong> <span id="posterLocation"></span>
    </div>
  </div>
  <div style="margin-top: 8px;">
    <strong>Active QR Codes:</strong> <span id="activeQrCount">0</span> of <span id="totalQrCount">0</span>
  </div>
</div>

<!-- [H03] Layout / DOM: Poster image (configurable) -->
<section class="poster-image-section" id="posterImageSection" style="display:none;">
  <img id="posterImage" alt="Event Poster" data-testid="poster-image" />
</section>

<!-- [H03] Layout / DOM: QR grid (up to 3 configurable) -->
<section class="qrgrid" id="qrGrid" aria-label="Poster QR Codes">
  <!-- Dynamically populated based on configuration -->
</section>

<section aria-label="Poster Information">
  <p class="muted" data-testid="poster-tip">
    QR codes appear only when verified and working. Each code includes analytics tracking for performance monitoring.
  </p>
</section>

<!-- [H03] Layout / DOM: Diagnostics -->
<section class="diag collapsed" id="diag" aria-labelledby="diag-head" data-testid="diagnostics">
  <div class="diag-head">
    <h2 id="diag-head">Diagnostics</h2>
    <div class="diag-actions">
      <label class="diag-checkbox row">
        <input type="checkbox" id="chkLiveLogs" checked data-testid="diag-live-logs" />
        Live logs
      </label>
      <button class="btn" id="btnClearLogs" data-testid="diag-clear">Clear</button>
      <button class="btn" id="btnToggleDiag" data-testid="diag-toggle">Expand</button>
    </div>
  </div>
  <div class="diag-body" id="diagBody" role="log" aria-live="polite"></div>
</section>
```

  </main>

  <script>
  /* =====================================================
   * [H04] Params / State / Refs (poster ID, geo tracking)
   * ===================================================== */
  const SDK = (typeof NUSDK !== 'undefined') ? NUSDK : {
    rpc: (fn, ...args) => new Promise((res, rej)=>{
      if (!google?.script?.run) return rej(new Error('RPC unavailable'));
      google.script.run.withSuccessHandler(res).withFailureHandler(e=>rej(new Error(e?.message||String(e))))[fn](...args);
    }),
    retry: async (fn, times=3, waits=[300,700,1200])=>{
      let last; for (let i=0;i<times;i++){ try{ return await fn(); } catch(e){ last=e; if (i<times-1) await new Promise(r=>setTimeout(r, waits[i]||500)); } } throw last;
    },
    toast: { info:console.log, error:console.error },
    esc: (s)=> String(s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]))
  };
  const { rpc, retry, toast, esc } = SDK;

  const params = new URLSearchParams(location.search);
  const eventKey = params.get('event') || '';
  const posterId = params.get('poster') || 'default'; // Unique poster identifier
  
  const STATE = {
    posterId,
    posterConfig: null,
    qrConfigs: [],
    geoLocation: null,
    sessionId: generateSessionId(),
    pageLoadTime: Date.now()
  };

  const els = {
    title: document.getElementById('posterTitle'),
    date: document.getElementById('eventDate'),
    badge: document.getElementById('statusBadge'),
    posterMetaSection: document.getElementById('posterMetaSection'),
    posterId: document.getElementById('posterId'),
    posterLocation: document.getElementById('posterLocation'),
    activeQrCount: document.getElementById('activeQrCount'),
    totalQrCount: document.getElementById('totalQrCount'),
    posterImageSection: document.getElementById('posterImageSection'),
    posterImage: document.getElementById('posterImage'),
    qrGrid: document.getElementById('qrGrid'),
    diag: document.getElementById('diag'),
    diagBody: document.getElementById('diagBody'),
    btnClearLogs: document.getElementById('btnClearLogs'),
    btnToggleDiag: document.getElementById('btnToggleDiag'),
    chkLive: document.getElementById('chkLiveLogs')
  };

  function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  /* =====================================================
   * [H05] Diagnostics helpers
   * ===================================================== */
  function log(msg, level){
    if (!els.chkLive.checked) return;
    const row = document.createElement('div');
    row.className = 'lvl-' + (level || 'info');
    row.textContent = new Date().toLocaleTimeString() + ' — ' + String(msg);
    els.diagBody.appendChild(row);
    while (els.diagBody.children.length > 100) {
      els.diagBody.removeChild(els.diagBody.firstChild);
    }
    els.diagBody.scrollTop = els.diagBody.scrollHeight;
  }
  
  function setDiagExpanded(expanded){
    els.diag.classList.toggle('collapsed', !expanded);
    els.btnToggleDiag.textContent = expanded ? 'Collapse' : 'Expand';
  }

  /* =====================================================
   * [H06] UI helpers (badges, QR/URL render, guidance)
   * ===================================================== */
  function createQRBox(config) {
    const box = document.createElement('div');
    box.className = 'qrbox';
    box.id = `qrbox-${config.id}`;
    box.dataset.qrId = config.id;
    
    box.innerHTML = `
      <h3 class="row gap">
        ${esc(config.label)}
        <span class="badge" id="badge-${config.id}">Loading…</span>
      </h3>
      <div id="qr-${config.id}" class="qr-container">
        <div class="spinner" aria-label="Loading ${esc(config.label)} QR"></div>
      </div>
      <small id="url-${config.id}" class="muted"></small>
      <div class="analytics-info" id="analytics-${config.id}" style="display:none;">
        <div class="analytics-row">
          <span class="muted">QR ID:</span>
          <code>${config.id}</code>
        </div>
        <div class="analytics-row">
          <span class="muted">Type:</span>
          <span>${config.type}</span>
        </div>
      </div>
    `;
    
    return box;
  }

  function setBadge(qrId, state){
    const badgeEl = document.getElementById(`badge-${qrId}`);
    if (!badgeEl) return;
    
    const map = {
      loading: { cls:'badge', text:'Loading…' },
      absent:  { cls:'badge badge-warn', text:'Not Configured' },
      url:     { cls:'badge', text:'URL Only' },
      qr:      { cls:'badge', text:'Active' },
      error:   { cls:'badge badge-warn', text:'Error' }
    };
    const b = map[state] || map.loading;
    badgeEl.className = b.cls;
    badgeEl.textContent = b.text;
  }
  
  function renderQR(qrId, imgUrl, alt){
    const container = document.getElementById(`qr-${qrId}`);
    if (!container || !imgUrl) return;
    container.innerHTML = `<img alt="${esc(alt||'QR Code')}" src="${esc(imgUrl)}" />`;
    
    // Mark parent box as verified
    const box = document.getElementById(`qrbox-${qrId}`);
    if (box) box.classList.add('verified');
    
    // Show analytics
    const analytics = document.getElementById(`analytics-${qrId}`);
    if (analytics) analytics.style.display = 'block';
  }
  
  function renderURL(qrId, url){
    const container = document.getElementById(`qr-${qrId}`);
    const urlLabel = document.getElementById(`url-${qrId}`);
    if (!container) return;
    
    container.innerHTML = `<div class="qr-fallback">${esc(url)}</div>`;
    if (urlLabel) urlLabel.textContent = url;
  }
  
  function renderGuidance(qrId, text){
    const container = document.getElementById(`qr-${qrId}`);
    if (!container) return;
    container.innerHTML = `<div class="qr-fallback">${esc(text)}</div>`;
  }

  /* =====================================================
   * [H07] Data loaders (poster config, QR verification)
   * ===================================================== */
  async function loadPosterConfig(){
    try {
      const config = await retry(()=> rpc('getPosterConfig', eventKey, posterId), 3, [300,700,1200]);
      if (!config?.ok) throw new Error(config?.error || 'config load failed');
      
      STATE.posterConfig = config;
      
      // Update header
      els.title.textContent = config.title || '(event)';
      els.date.textContent = config.datePretty || '';
      
      // Update poster metadata
      if (config.posterMeta) {
        els.posterMetaSection.style.display = 'block';
        els.posterId.textContent = posterId;
        els.posterLocation.textContent = config.posterMeta.location || 'Not specified';
      }
      
      // Load poster image if configured
      if (config.posterImageUrl) {
        els.posterImageSection.style.display = 'block';
        els.posterImage.src = config.posterImageUrl;
        log(`Poster image loaded: ${config.posterImageUrl}`, 'info');
      }
      
      // Store QR configurations (up to 3)
      STATE.qrConfigs = config.qrCodes || [];
      els.totalQrCount.textContent = STATE.qrConfigs.length;
      
      log(`Poster config loaded: ${STATE.qrConfigs.length} QR codes configured`, 'info');
      return config;
      
    } catch (e) {
      log(`Config load error: ${e.message}`, 'error');
      throw e;
    }
  }

  async function verifyQRCode(qrConfig) {
    const qrId = qrConfig.id;
    setBadge(qrId, 'loading');
    
    try {
      // Call appropriate verification endpoint based on QR type
      let result;
      
      if (qrConfig.type === 'public') {
        result = await retry(()=> rpc('getShareQrVerified', eventKey), 3, [300,600,1200]);
      } else if (qrConfig.type === 'signup') {
        const ql = await retry(()=> rpc('getEventQuickLinks', eventKey), 3, [300,600,1200]);
        result = {
          ok: !!ql?.formUrlView,
          url: ql?.formUrlView || '',
          qrUrlVerified: (ql?.short?.form && ql?.qr?.form) ? ql.qr.form : ''
        };
      } else if (qrConfig.type === 'custom') {
        // Custom QR type - verify via generic endpoint
        result = await retry(()=> rpc('verifyCustomQR', eventKey, qrId), 3, [300,600,1200]);
      }
      
      if (result?.ok && result.qrUrlVerified) {
        // QR verified and ready
        renderQR(qrId, result.qrUrlVerified, qrConfig.label);
        const urlLabel = document.getElementById(`url-${qrId}`);
        if (urlLabel) urlLabel.textContent = result.url || '';
        setBadge(qrId, 'qr');
        
        // Track successful display
        await trackQRDisplay(qrId, 'verified', result.url);
        
        log(`QR ${qrId} verified and displayed`, 'info');
        return true;
        
      } else if (result?.url) {
        // URL available but QR not verified
        renderURL(qrId, result.url);
        setBadge(qrId, 'url');
        
        await trackQRDisplay(qrId, 'url_only', result.url);
        
        log(`QR ${qrId} showing URL fallback`, 'warn');
        return false;
        
      } else {
        // Not configured or error
        renderGuidance(qrId, qrConfig.notConfiguredMessage || 'Not configured');
        setBadge(qrId, 'absent');
        
        await trackQRDisplay(qrId, 'not_configured', null);
        
        log(`QR ${qrId} not configured`, 'warn');
        return false;
      }
      
    } catch (e) {
      renderGuidance(qrId, 'Error loading QR code');
      setBadge(qrId, 'error');
      log(`QR ${qrId} verification error: ${e.message}`, 'error');
      return false;
    }
  }

  /* =====================================================
   * [H08] Analytics tracking (scan events, geo logging)
   * ===================================================== */
  async function initializeGeolocation() {
    if (!navigator.geolocation) {
      log('Geolocation not supported', 'warn');
      return null;
    }
    
    return new Promise((resolve) => {
      const options = {
        enableHighAccuracy: false,
        timeout: 5000,
        maximumAge: 300000 // Cache for 5 minutes
      };
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          STATE.geoLocation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy,
            timestamp: position.timestamp
          };
          log(`Geolocation acquired: ${STATE.geoLocation.latitude}, ${STATE.geoLocation.longitude}`, 'info');
          resolve(STATE.geoLocation);
        },
        (error) => {
          log(`Geolocation error: ${error.message}`, 'warn');
          resolve(null);
        },
        options
      );
    });
  }

  async function trackQRDisplay(qrId, displayState, url) {
    const event = {
      eventType: 'qr_display',
      posterId: STATE.posterId,
      qrId,
      displayState,
      url,
      sessionId: STATE.sessionId,
      timestamp: new Date().toISOString(),
      geo: STATE.geoLocation,
      userAgent: navigator.userAgent,
      screenSize: {
        width: window.screen.width,
        height: window.screen.height
      },
      viewport: {
        width: window.innerWidth,
        height: window.innerHeight
      }
    };
    
    try {
      await rpc('logPosterAnalytics', eventKey, event);
      log(`Analytics tracked: ${qrId} - ${displayState}`, 'info');
    } catch (e) {
      log(`Analytics tracking failed: ${e.message}`, 'warn');
      // Don't fail the display if analytics fail
    }
  }

  async function trackPageView() {
    const event = {
      eventType: 'poster_view',
      posterId: STATE.posterId,
      sessionId: STATE.sessionId,
      timestamp: new Date().toISOString(),
      geo: STATE.geoLocation,
      referrer: document.referrer,
      loadTime: Date.now() - STATE.pageLoadTime
    };
    
    try {
      await rpc('logPosterAnalytics', eventKey, event);
      log('Page view tracked', 'info');
    } catch (e) {
      log(`Page view tracking failed: ${e.message}`, 'warn');
    }
  }

  /* =====================================================
   * [H09] One-shot verification (no polling)
   * ===================================================== */
  async function verifyAllQRCodes() {
    if (!STATE.qrConfigs.length) {
      log('No QR codes configured', 'warn');
      return;
    }
    
    // Render QR boxes
    els.qrGrid.innerHTML = '';
    STATE.qrConfigs.forEach(config => {
      const box = createQRBox(config);
      els.qrGrid.appendChild(box);
    });
    
    // Verify all QR codes in parallel
    const results = await Promise.all(
      STATE.qrConfigs.map(config => 
        verifyQRCode(config).catch(e => {
          log(`QR ${config.id} verification exception: ${e.message}`, 'error');
          return false;
        })
      )
    );
    
    // Update active count
    const activeCount = results.filter(r => r === true).length;
    els.activeQrCount.textContent = activeCount;
    
    log(`QR verification complete: ${activeCount} of ${STATE.qrConfigs.length} active`, 'info');
  }

  /* =====================================================
   * [H10] Boot (DOMContentLoaded)
   * ===================================================== */
  document.addEventListener('DOMContentLoaded', async ()=>{
    setDiagExpanded(false);

    if (!eventKey) {
      els.title.textContent = '(no event)';
      els.date.textContent = '';
      log('No event key provided in URL', 'error');
      return;
    }

    log(`Poster initialized: ${posterId}`, 'info');
    
    // Initialize geolocation (async, non-blocking)
    initializeGeolocation();

    try {
      // Load poster configuration
      await loadPosterConfig();
      
      // Verify and display QR codes
      await verifyAllQRCodes();
      
      // Track page view
      await trackPageView();
      
      log('Poster ready', 'info');
      
    } catch(e) {
      log(`Poster initialization failed: ${e.message}`, 'error');
      toast?.error?.('Failed to load poster configuration');
    }
  });

  /* =====================================================
   * [H11] Cleanup + diag controls
   * ===================================================== */
  document.getElementById('btnClearLogs').onclick = ()=> els.diagBody.replaceChildren();
  document.getElementById('btnToggleDiag').onclick = ()=> setDiagExpanded(els.diag.classList.contains('collapsed'));
  
  // Track page unload
  window.addEventListener('beforeunload', async () => {
    const sessionDuration = Date.now() - STATE.pageLoadTime;
    try {
      await rpc('logPosterAnalytics', eventKey, {
        eventType: 'poster_unload',
        posterId: STATE.posterId,
        sessionId: STATE.sessionId,
        sessionDuration,
        timestamp: new Date().toISOString()
      });
    } catch (e) {
      // Silent fail on unload
    }
  });
  </script>

</body>
</html>