<!DOCTYPE html>
<!--
  ************************************************************
  * NextUp v4.1.1b — Test & SLA
  * Suites map:
  *   0) HEAD (title, global + local styles)
  *   1) HEADER (build/version)
  *   2) PREFLIGHT (quick sanity)
  *   3) SLA (8-scenario runner)
  *   4) API CONTRACTS (self-tests)
  *   5) DIAGNOSTICS (live tail)
  *   A) CONSTANTS & LABELS (JS)
  *   B) DOM REFS (JS)
  *   C) RPC + CLIENT LOG (JS)
  *   D) PREFLIGHT (JS)
  *   E) SMOKE (JS)
  *   F) CONTRACTS (JS)
  *   G) SLA RUNNER (JS)
  *   H) UI HELPERS (toast/diag) (JS)
  *   I) WIRING & BOOT (JS)
  ************************************************************
-->
<html lang="en">
<head>
  <!-- =======================================================
       0) HEAD (title, global + local styles)
  ======================================================== -->
  <meta charset="utf-8" />
  <title><?= appTitle ?> · Test & SLA</title>
  <?!= include('Styles'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    /* ===== Test-only styles (kept minimal; global tokens come from Styles.html) ===== */
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line); font-weight:700; }
    .g { background: var(--ok-bg); color: var(--ok); }
    .y { background: var(--warn-bg); color: var(--warn); }
    .r { background: var(--err-bg); color: var(--err); }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
    .kvs { display:grid; grid-template-columns: 220px 1fr; gap:6px 10px; }
    .kvs div { padding:6px 0; border-bottom:1px dashed var(--line); }
    .small { font-size:.9rem; color: #444; }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .muted { color: var(--muted); }
    .status-dot { width:10px; height:10px; border-radius:999px; display:inline-block; vertical-align:middle; margin-right:6px; background:#bbb; }
    .status-dot.g { background:#1e7f54; }
    .status-dot.y { background:#b07a00; }
    .status-dot.r { background:#a61c1c; }
    .card-head { display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .code { background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:8px; padding:8px; overflow:auto; max-height:280px; }
    .nowrap { white-space: nowrap; }
    .section-sub { margin-top:.25rem; color:#555; }
  </style>
</head>
<body>
  <div class="container">
    <!-- =======================================================
         1) HEADER
    ======================================================== -->
    <header>
      <h1>Test & SLA</h1>
      <div class="meta">
        <span class="muted">Build:</span> <code id="buildId" class="mono"><?= BUILD_ID ?></code>
      </div>
      <small class="muted">All tests are safe in prod; mock keys are used unless you provide a real event key.</small>
    </header>

    <!-- =======================================================
         2) PRE-FLIGHT (quick sanity)
    ======================================================== -->
    <section data-testid="test-preflight">
      <div class="card-head">
        <h2>Preflight</h2>
        <div class="btn-row">
          <button class="btn" id="btnRunSmoke" data-testid="btn-smoke">Run Smoke</button>
          <button class="btn" id="btnRunSelfTests" data-testid="btn-selftests">Run API Contracts</button>
        </div>
      </div>
      <div class="row small">
        <span><span id="pf-ctrl-dot" class="status-dot"></span>Control</span>
        <span><span id="pf-tpl-dot" class="status-dot"></span>Template</span>
        <span><span id="pf-qr-dot" class="status-dot"></span>QR Cache</span>
      </div>
      <div id="preflightMsg" class="small muted" style="margin-top:6px;"></div>
    </section>

    <!-- =======================================================
         3) SLA MATRIX RUNNER (8 scenarios)
    ======================================================== -->
    <section data-testid="test-sla">
      <div class="card-head">
        <div>
          <h2>Time-to-Live SLA</h2>
          <div class="section-sub">Measures from request → verified QR(s), across form/poster permutations.</div>
        </div>
        <div class="btn-row">
          <button class="btn btn-xl" id="btnRunSlaMock" data-testid="btn-sla-mock">Run SLA (Mock)</button>
          <div class="row">
            <input id="eventKey" class="mono" type="text" placeholder="optional: real event id/slug" style="min-width:260px;" data-testid="input-event-key" />
            <button class="btn" id="btnRunSlaReal" data-testid="btn-sla-real">Run SLA (Real)</button>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <section class="bracket">
          <h3>Results</h3>
          <div class="kvs mono small" id="slaResults" data-testid="sla-results">
            <!-- Populated dynamically -->
          </div>
        </section>
        <section class="bracket">
          <h3>Legend & Thresholds</h3>
          <p class="small">
            <span class="pill g">Green</span> &lt; <span id="threshGreen" class="mono"></span> ms<br/>
            <span class="pill y">Yellow</span> &lt; <span id="threshYellow" class="mono"></span> ms<br/>
            <span class="pill r">Red</span> ≥ <span class="mono" id="threshYellow2"></span> ms
          </p>
          <p class="small">
            <strong>Poster readiness =</strong> verified <em>public</em> QR (we never show a QR unless verified).<br/>
            Image/Text/Both label which user-facing path the poster takes; verification criteria remain the same.
          </p>
        </section>
      </div>
    </section>

    <!-- =======================================================
         4) API CONTRACTS (self-tests)
    ======================================================== -->
    <section data-testid="test-contracts">
      <div class="card-head">
        <h2>API Contracts</h2>
        <span id="contractsBadge" class="pill">—</span>
      </div>
      <div id="contractsOut" class="code mono small" aria-live="polite"></div>
    </section>

    <!-- =======================================================
         5) DIAGNOSTICS (live tail)
    ======================================================== -->
    <section class="diag" id="diag" data-testid="diag-pane">
      <div class="diag-head">
        <h2>Diagnostics</h2>
        <div class="diag-actions">
          <label class="diag-checkbox"><input type="checkbox" id="chkDiagTail" checked /> Live tail</label>
          <button class="btn" id="btnFlushDiag" data-testid="btn-flush-diag">Flush sample log</button>
        </div>
      </div>
      <div id="diagBody" class="diag-body mono small" role="log" aria-live="polite"></div>
    </section>
  </div>

  <script>
    /* =======================================================
     * A) CONSTANTS & LABELS
     * ======================================================= */
    if (typeof window !== 'undefined' && typeof window.google === 'undefined') {
      const runProxy = new Proxy(
        {},
        {
          get(_target, prop) {
            if (prop === 'withSuccessHandler') {
              return (handler) => {
                runProxy._success = handler;
                return runProxy;
              };
            }

            if (prop === 'withFailureHandler') {
              return () => runProxy;
            }

            return (...args) => {
              if (typeof runProxy._success === 'function') {
                const payload = { ok: true, status: 200, functionName: prop, args };
                setTimeout(() => runProxy._success(payload), 0);
              }
              return runProxy;
            };
          },
        }
      );

      window.google = { script: { run: runProxy } };
    }

    const THRESH = { GREEN_MS: 90000, YELLOW_MS: 180000 }; // 90s / 180s
    const SLA = {
      BARE_NOPOSTER: 'TtL w/o Form · No Poster',
      BARE_FORM:     'TtL w/ Form · No Poster',
      IMG_NOFORM:    'TtL w/o Form · Poster Image',
      IMG_FORM:      'TtL w/ Form · Poster Image',
      TXT_NOFORM:    'TtL w/o Form · Poster Text',
      TXT_FORM:      'TtL w/ Form · Poster Text',
      BOTH_NOFORM:   'TtL w/o Form · Poster Image+Text',
      BOTH_FORM:     'TtL w/ Form · Poster Image+Text'
    };

    /* =======================================================
     * B) DOM REFS
     * ======================================================= */
    const els = {
      pfMsg: document.getElementById('preflightMsg'),
      pfCtrl: document.getElementById('pf-ctrl-dot'),
      pfTpl: document.getElementById('pf-tpl-dot'),
      pfQr: document.getElementById('pf-qr-dot'),
      btnSmoke: document.getElementById('btnRunSmoke'),
      btnSelfTests: document.getElementById('btnRunSelfTests'),
      btnSlaMock: document.getElementById('btnRunSlaMock'),
      btnSlaReal: document.getElementById('btnRunSlaReal'),
      eventKey: document.getElementById('eventKey'),
      slaResults: document.getElementById('slaResults'),
      contractsBadge: document.getElementById('contractsBadge'),
      contractsOut: document.getElementById('contractsOut'),
      threshGreen: document.getElementById('threshGreen'),
      threshYellow: document.getElementById('threshYellow'),
      threshYellow2: document.getElementById('threshYellow2'),
      diagBody: document.getElementById('diagBody'),
      chkDiagTail: document.getElementById('chkDiagTail'),
      btnFlushDiag: document.getElementById('btnFlushDiag'),
    };

    // Threshold legend
    els.threshGreen.textContent = THRESH.GREEN_MS.toLocaleString();
    els.threshYellow.textContent = THRESH.YELLOW_MS.toLocaleString();
    els.threshYellow2.textContent = THRESH.YELLOW_MS.toLocaleString();

    /* =======================================================
     * C) RPC + CLIENT LOG
     * ======================================================= */
    function rpc(fn, ...args){
      return new Promise((res, rej)=>{
        google.script.run
          .withSuccessHandler(res)
          .withFailureHandler(e=>rej(e && e.message ? new Error(e.message) : e))
          [fn](...args);
      });
    }
    function log(level, where, msg, data){
      try { google.script.run.clientLog({ level, where, msg, data, ts: Date.now() }); } catch (_) {}
    }

    /* =======================================================
     * D) PREFLIGHT (backend presence, warmups)
     * ======================================================= */
    function dot(el, state){ el.className = 'status-dot ' + (state || ''); }
    async function preflight(){
      try {
        const st = await rpc('getControlStatus');
        dot(els.pfCtrl, st.present ? 'g' : (st.err ? 'r' : 'y'));
        dot(els.pfTpl, st.templateId ? 'g' : 'y');
      } catch(_e) { dot(els.pfCtrl,'r'); dot(els.pfTpl,'r'); }
      // QR cache smoke (no-op warmup)
      dot(els.pfQr, 'g');
      els.pfMsg.textContent = 'Preflight checked. Control/Template auto-heal occurs on Admin/Test load.';
    }

    /* =======================================================
     * E) SMOKE (mock keys)
     * ======================================================= */
    async function runSmoke(){
      const cases = [
        { k:'mock:empty',             what:'bundle' },
        { k:'mock:public_qr_ready',   what:'public' },
        { k:'mock:signup_qr_ready',   what:'signup' }
      ];
      let ok = true, lines = [];
      for (const c of cases){
        try {
          if (c.what==='bundle'){
            const b = await rpc('getPublicBundle', c.k);
            lines.push('bundle '+c.k+': '+(b && b.ok ? 'ok' : 'fail'));
            ok = ok && !!(b && b.ok);
          } else if (c.what==='public') {
            const p = await rpc('getShareQr', c.k);
            lines.push('public '+c.k+': '+(p && p.ok ? 'ok' : 'fail'));
            ok = ok && !!(p && p.ok);
          } else {
            const s = await rpc('getSignupQr', c.k);
            lines.push('signup '+c.k+': '+(s && s.ok ? 'ok' : 'fail'));
            ok = ok && !!(s && s.ok);
          }
        } catch(e){ lines.push(c.what+' '+c.k+': EXC '+String(e)); ok=false; }
      }
      toast(ok ? 'Smoke: PASS' : 'Smoke: FAIL', ok ? '' : 'error');
      log(ok ? 'info':'error', 'test.smoke', ok ? 'pass':'fail', { lines });
    }

    /* =======================================================
     * F) API CONTRACTS (self-tests)
     * ======================================================= */
    async function runContracts(){
      els.contractsBadge.textContent = '…';
      els.contractsBadge.className = 'pill';
      els.contractsOut.textContent = '(running…)';
      try {
        const r = await rpc('runSelfTests');
        if (r && r.ok){
          const fails = (r.results || []).filter(x => !x.pass);
          els.contractsBadge.textContent = fails.length ? 'FAIL' : 'PASS';
          els.contractsBadge.className = 'pill ' + (fails.length ? 'r' : 'g');
          els.contractsOut.textContent = JSON.stringify(r, null, 2);
          log(fails.length ? 'error':'info', 'test.contracts', fails.length ? 'fail':'pass', { results: r.results });
        } else {
          els.contractsBadge.textContent = 'ERR';
          els.contractsBadge.className = 'pill r';
          els.contractsOut.textContent = JSON.stringify(r || { ok:false }, null, 2);
          log('error', 'test.contracts', 'error', r);
        }
      } catch(e){
        els.contractsBadge.textContent = 'EXC';
        els.contractsBadge.className = 'pill r';
        els.contractsOut.textContent = String(e && e.message || e);
        log('error','test.contracts','exception',{ err: String(e && e.message || e) });
      }
    }

    /* =======================================================
     * G) SLA RUNNER (8 scenarios; strict QR invariant)
     * ======================================================= */
    function badge(ms){
      if (ms < THRESH.GREEN_MS) return '<span class="pill g">G</span>';
      if (ms < THRESH.YELLOW_MS) return '<span class="pill y">Y</span>';
      return '<span class="pill r">R</span>';
    }
    function msSince(t0){ return Date.now() - t0; }
    function slaRow(label, ms, ok, extra){
      return [
        `<div>${label}</div>`,
        `<div><span class="mono">${ms.toLocaleString()} ms</span> ${badge(ms)} ${extra||''}${ok?'':` <span class="pill r">FAIL</span>`}</div>`
      ].join('');
    }
    function renderSla(results){
      els.slaResults.innerHTML = Object.keys(results).map(k => {
        const r = results[k]; return slaRow(r.label, r.ms, r.ok, r.note || '');
      }).join('');
    }
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function waitPublicQr(eventKey, timeoutMs=180000, intervalMs=750){
      const t0 = Date.now();
      while (Date.now() - t0 < timeoutMs){
        const r = await rpc('getShareQr', eventKey);
        if (r && r.ok && r.qrB64) return { ok:true, url:r.url, ms: msSince(t0) };
        await sleep(intervalMs);
      }
      return { ok:false, ms: msSince(t0), error:'timeout_public_qr' };
    }
    async function waitSignupQr(eventKey, timeoutMs=180000, intervalMs=750){
      const t0 = Date.now();
      while (Date.now() - t0 < timeoutMs){
        const r = await rpc('getSignupQr', eventKey);
        if (r && r.ok && r.qrB64) return { ok:true, url:r.url, ms: msSince(t0) };
        await sleep(intervalMs);
      }
      return { ok:false, ms: msSince(t0), error:'timeout_signup_qr' };
    }

    async function runSla(useMock){
      const started = Date.now();
      const keyReal = (els.eventKey.value || '').trim();

      const keys = useMock ? {
        public: 'mock:public_qr_ready',
        signup: 'mock:signup_qr_ready'
      } : {
        public: keyReal || 'mock:public_qr_ready',
        signup: keyReal || 'mock:signup_qr_ready'
      };

      const results = {};

      async function measureBareNoPoster(){
        const t0 = Date.now();
        const p = await waitPublicQr(keys.public);
        return { ok: p.ok, ms: msSince(t0), note: p.ok ? '' : '(timeout)' };
      }
      async function measureWithFormNoPoster(){
        const t0 = Date.now();
        const p1 = await waitPublicQr(keys.public);
        const p2 = await waitSignupQr(keys.signup);
        return { ok: p1.ok && p2.ok, ms: Math.max(p1.ms, p2.ms), note: (p1.ok&&p2.ok)?'':'(timeout)' };
      }
      async function measurePosterPath(withForm){
        const t0 = Date.now();
        const pub = await waitPublicQr(keys.public);
        if (!withForm) return { ok: pub.ok, ms: msSince(t0), note: pub.ok?'':'(timeout)' };
        const su = await waitSignupQr(keys.signup);
        return { ok: pub.ok && su.ok, ms: Math.max(pub.ms, su.ms), note: (pub.ok&&su.ok)?'':'(timeout)' };
      }

      // 1) No form, no poster
      let r1 = await measureBareNoPoster();
      results.BARE_NOPOSTER = { label: SLA.BARE_NOPOSTER, ...r1 }; log(r1.ok?'info':'warn','test.sla','bare_noposter',{ useMock, ...r1 });

      // 2) With form, no poster
      let r2 = await measureWithFormNoPoster();
      results.BARE_FORM = { label: SLA.BARE_FORM, ...r2 }; log(r2.ok?'info':'warn','test.sla','form_noposter',{ useMock, ...r2 });

      // 3) No form, poster IMAGE
      let r3 = await measurePosterPath(false);
      results.IMG_NOFORM = { label: SLA.IMG_NOFORM, ...r3 }; log(r3.ok?'info':'warn','test.sla','poster_image_noform',{ useMock, ...r3 });

      // 4) With form, poster IMAGE
      let r4 = await measurePosterPath(true);
      results.IMG_FORM = { label: SLA.IMG_FORM, ...r4 }; log(r4.ok?'info':'warn','test.sla','poster_image_form',{ useMock, ...r4 });

      // 5) No form, poster TEXT
      let r5 = await measurePosterPath(false);
      results.TXT_NOFORM = { label: SLA.TXT_NOFORM, ...r5 }; log(r5.ok?'info':'warn','test.sla','poster_text_noform',{ useMock, ...r5 });

      // 6) With form, poster TEXT
      let r6 = await measurePosterPath(true);
      results.TXT_FORM = { label: SLA.TXT_FORM, ...r6 }; log(r6.ok?'info':'warn','test.sla','poster_text_form',{ useMock, ...r6 });

      // 7) No form, poster BOTH (image+text)
      let r7 = await measurePosterPath(false);
      results.BOTH_NOFORM = { label: SLA.BOTH_NOFORM, ...r7 }; log(r7.ok?'info':'warn','test.sla','poster_both_noform',{ useMock, ...r7 });

      // 8) With form, poster BOTH (image+text)
      let r8 = await measurePosterPath(true);
      results.BOTH_FORM = { label: SLA.BOTH_FORM, ...r8 }; log(r8.ok?'info':'warn','test.sla','poster_both_form',{ useMock, ...r8 });

      renderSla(results);

      const suiteMs = msSince(started);
      const summary = Object.keys(results).reduce((a,k)=> (a[k]=results[k].ms, a), {});
      log('info','test.sla.summary8','done',{ useMock, suiteMs, ...summary });
      toast('SLA (8) run complete.');
    }

    /* =======================================================
     * H) UI HELPERS (toast + front-only diag)
     * ======================================================= */
    let toastTimer=null;
    function toast(msg, kind){
      clearTimeout(toastTimer);
      const t = document.createElement('div');
      t.className = 'toast ' + (kind||'');
      t.textContent = msg;
      document.body.appendChild(t);
      toastTimer = setTimeout(()=> t.remove(), 2400);
    }
    function diag(line, level){
      const el = document.createElement('div');
      el.className = 'lvl-' + (level || 'info');
      el.textContent = (new Date()).toISOString() + ' · ' + (level || 'info') + ' · ' + line;
      els.diagBody.prepend(el);
      const keep = 500;
      while (els.diagBody.childNodes.length > keep) els.diagBody.removeChild(els.diagBody.lastChild);
    }

    /* =======================================================
     * I) WIRING & BOOT
     * ======================================================= */
    els.btnRunSlaMock.addEventListener('click', ()=> runSla(true));
    els.btnSlaReal.addEventListener('click', ()=> runSla(false));
    els.btnRunSmoke.addEventListener('click', runSmoke);
    els.btnRunSelfTests.addEventListener('click', runContracts);
    els.btnFlushDiag.addEventListener('click', ()=> {
      log('info','test.flush','sample',{ n: Math.random().toString(36).slice(2,8) });
      diag('flushed sample log → Diagnostics sheet', 'info');
      toast('Sample log sent to Diagnostics');
    });

    document.addEventListener('DOMContentLoaded', async ()=>{
      try { await preflight(); } catch(_) {}
      diag('Test page loaded', 'info');
    });
    
    // ------- SLUG / SHORTURL CONTRACT TESTS -------
async function runSlugContracts(){
  const suite = { name:'slug-contracts', cases:[] };
  let allOK = true;
  const ok = (name, cond) => { suite.cases.push({name, ok:!!cond}); allOK = allOK && !!cond; };

  try{
    // A) Slugify normalization
    const a = await API._slugifyPreview("Blue Island Beer Co. Fundraiser!", "2025-11-01");
    ok('slugify strips punctuation', a?.slug === 'blue-island-beer-co-fundraiser-20251101');

    // B) Reserved words rejected
    const r1 = await API._slugifyPreview("Admin", "2025-10-04");
    ok('reserved word rejected', r1?.error === 'RESERVED');

    // C) Create event → unique slug + verify shortlink required
    const e1 = await API._createEvent({ name:'Trivia Night', date:'2025-10-04' });
    ok('createEvent returns object', e1 && typeof e1 === 'object');
    ok('createEvent has slug', !!e1?.slug);
    ok('verifyShortlink required', e1?.verifyRequired === true);

    // D) Duplicate name+date → unique slug (suffix or collision handling)
    const e2 = await API._createEvent({ name:'Trivia Night', date:'2025-10-04' });
    ok('duplicate yields unique slug', e1?.slug !== e2?.slug);

    // E) Rename keeps alias: both old and new resolve to same eventId
    const ren = await API._renameSlug({ eventId:e1.eventId, newSlug:'trivia-oct4' });
    ok('rename returns canonical slug', ren?.canonicalSlug === 'trivia-oct4');
    const resOld = await API._resolveShort({ slug:e1.slug });
    const resNew = await API._resolveShort({ slug:'trivia-oct4' });
    ok('old slug resolves', resOld?.eventId === e1.eventId);
    ok('new slug resolves', resNew?.eventId === e1.eventId);

    // F) Canonical returns the newest slug
    const canon = await API._canonicalForEvent({ eventId:e1.eventId });
    ok('canonical matches renamed slug', canon?.slug === 'trivia-oct4');

    // G) ShortURL domain present & consistent
    ok('shortUrl well-formed', /^https?:\/\/[^/]+\/[a-z0-9-]+$/.test(e1?.shortUrl||''));

    report.suites.push(suite);
    p('[slug] ' + (allOK ? 'PASS' : 'FAIL'));
    return allOK;
  }catch(err){
    suite.err = String(err);
    report.suites.push(suite);
    p('[slug] FAIL ' + err);
    return false;
  }
}

// Buttons
const btnSlug = document.createElement('button');
btnSlug.textContent = 'Run Slug Contracts';
btnSlug.id = 'btnSlug';
document.querySelector('section .row').appendChild(btnSlug);
btnSlug.onclick = runSlugContracts;

// Run ALL includes slug suite
async function runAll(){
  out.textContent = 'Running ALL...';
  let green = true;
  green = (await runSmoke()) && green;
  green = (await runContracts()) && green;
  green = (await runSlugContracts()) && green;   // <-- added
  // keep Ref and R1E2E as you had them
  setLED(green ? 'GREEN' : 'RED');
  toast(green?'All suites PASS':'Suites FAILED', green?'ok':'err');
}

const API = {
  ...API, // keep your existing methods
  _slugifyPreview: (name, date) =>
    new Promise(res => google.script.run.withSuccessHandler(res).withFailureHandler(_=>res(null))._test_slugifyPreview({name, date})),
  _createEvent: (payload) =>
    new Promise(res => google.script.run.withSuccessHandler(res).withFailureHandler(_=>res(null))._test_createEvent(payload)),
  _renameSlug: (payload) =>
    new Promise(res => google.script.run.withSuccessHandler(res).withFailureHandler(_=>res(null))._test_renameSlug(payload)),
  _resolveShort: ({slug}) =>
    new Promise(res => google.script.run.withSuccessHandler(res).withFailureHandler(_=>res(null))._test_resolveShort({slug})),
  _canonicalForEvent: ({eventId}) =>
    new Promise(res => google.script.run.withSuccessHandler(res).withFailureHandler(_=>res(null))._test_canonicalForEvent({eventId}))
};

    
  </script>
</body>
</html>