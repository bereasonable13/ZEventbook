<!--
/************************************************************
* NextUp · Admin.html — Suite Index
* [H01] Head / Meta (title, viewport, styles)
* [H02] Inline Styles (light UI)
* [H03] Layout / DOM (header, create, manage, diagnostics)
* [H04] Manage Actions (links, QR, hygiene buttons)
* [H05] Toasts (UI feedback)
* [H06] State & DOM Refs
* [H07] RPC Wrapper
* [H08] Bootstrap & Wiring
* [H09] Events List (SWR dropdown)
* [H10] Create Eventbook flow
* [H11] Manage Actions (default, archive, form)
* [H12] Links & QR (strict verified only)
* [H13] Diagnostics (smoke, logs)
* [H14] Shortlink Hygiene (repair one / repair all)
* [H15] Utilities (enable/disable, clear, copy links)
************************************************************/
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [H01] Head / Meta -->
  <meta charset="utf-8"/>
  <title><?= appTitle ?> · Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <?!= include('Styles'); ?>

  <!-- [H02] Inline Styles -->
  <style>
    :root { --gap:12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 14px; }
    header h1 { margin: 0 0 2px; }
    small#build { color:#666 }
    .row { display:flex; gap: var(--gap); flex-wrap: wrap; align-items: flex-end; }
    .card { border:1px solid #ddd; border-radius:10px; padding:14px; margin:10px 0; background:#fff; }
    .muted { color:#666; }
    label { display:block; font-size:.9rem; margin:.2rem 0; }
    input, select, button { font-size:1rem; padding:.55rem .7rem; }
    button { cursor:pointer; }
    .links a { margin-right:10px; }
    .qrwrap{ display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .toast { position:fixed; right:10px; bottom:10px; background:#222; color:#fff; padding:10px 12px; border-radius:8px; display:none; z-index:9999; }
    .toast.show{ display:block; }
    pre.json { background:#f7f7f7; border:1px solid #e3e3e3; border-radius:8px; padding:10px; max-height:320px; overflow:auto; }
    .btn-subtle { background:#f6f6f6; border:1px solid #ddd; border-radius:8px; }
  </style>
</head>
<body>
  <main>
    <!-- [H03] Layout / DOM: HEADER -->
    <header>
      <h1 data-testid="admin-title">NextUp Admin</h1>
      <small id="build">BUILD: <?= BUILD_ID ?></small>
    </header>

    <!-- [H03] Layout / DOM: CREATE EVENTBOOK -->
    <section class="card" aria-label="Create Eventbook">
      <h3>Create Eventbook</h3>
      <div class="row">
        <div>
          <label for="evName">Name</label>
          <input id="evName" data-testid="ev-name" placeholder="e.g., Southside Bocce Weeklies"/>
        </div>
        <div>
          <label for="evDate">Start Date (ISO)</label>
          <input id="evDate" data-testid="ev-date" type="date"/>
        </div>
        <div>
          <label for="seedMode">Seeding</label>
          <select id="seedMode" data-testid="ev-seedmode">
            <option value="random">Random</option>
            <option value="seeded">Seeded</option>
          </select>
        </div>
        <div>
          <label for="elimType">Elimination</label>
          <select id="elimType" data-testid="ev-elimtype">
            <option value="single">Single</option>
            <option value="double">Double</option>
          </select>
        </div>
        <div>
          <button id="btnCreate" data-testid="btn-create">Create</button>
        </div>
      </div>
      <small class="muted">Idempotent on <em>slug + start date</em>.</small>
    </section>

    <!-- [H03] Layout / DOM: MANAGE EVENTBOOKS -->
    <section class="card" aria-label="Manage Eventbooks">
      <h3>Manage Eventbooks</h3>
      <div class="row">
        <div style="min-width:280px">
          <label for="chooseEvent">Choose</label>
          <select id="chooseEvent" data-testid="select-event">
            <option value="">No events yet — create above</option>
          </select>
        </div>
        <div>
          <button id="btnMakeDefault" data-testid="btn-make-default" disabled>Make Default</button>
          <button id="btnArchive" data-testid="btn-archive" disabled>Archive</button>
        </div>
      </div>

      <!-- [H04] Manage Actions: Links + Hygiene -->
      <div class="row" style="margin-top:10px">
        <div class="links">
          <a id="openPublic"  data-testid="link-public"  target="_blank" rel="noopener">Open Public</a>
          <a id="openDisplay" data-testid="link-display" target="_blank" rel="noopener">Open TV</a>
          <a id="openPoster"  data-testid="link-poster"  target="_blank" rel="noopener">Open Poster</a>
          <button id="btnCopyLinks" class="btn-subtle" data-testid="btn-copy-links" disabled>Copy Links</button>
          <button id="btnRepairShort" class="btn-subtle" data-testid="btn-repair-short" disabled title="Recreate and re-point shortlinks for this event to the current deployment base">Repair Shortlinks</button>
        </div>
      </div>

      <!-- [H04] Manage Actions: QR -->
      <div class="qrwrap" style="margin-top:14px">
        <div><strong>Public QR</strong> <small class="muted">(shown only when verified)</small></div>
        <img id="qrImg" data-testid="img-qr" alt="QR" width="110" height="110" style="display:none;border:1px solid #ddd;border-radius:6px;"/>
        <a id="qrLink" data-testid="link-qr" target="_blank" rel="noopener"></a>
      </div>
    </section>

    <!-- [H03] Layout / DOM: DIAGNOSTICS -->
    <section class="card" aria-label="Diagnostics">
      <h3>Diagnostics</h3>
      <div class="row">
        <button id="btnSmoke" data-testid="btn-smoke">Run Smoke</button>
        <button id="btnViewLogs" data-testid="btn-view-logs">View Logs</button>
        <button id="btnClearLogs" data-testid="btn-clear-logs">Clear Logs</button>
        <button id="btnRepairAllShort" class="btn-subtle" data-testid="btn-repair-all-short" title="Repair standard shortlinks for all events">Repair All Shortlinks</button>
      </div>
      <div style="margin-top:10px">
        <pre id="diagOut" class="json" role="status" aria-live="polite" data-testid="diag-output">{}</pre>
      </div>
    </section>

    <div id="toast" class="toast" aria-live="polite" data-testid="toast"></div>
  </main>

  <script>
/* [H05] Toasts */
const TOAST = {
  show(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2300); },
  info(msg){ this.show(msg); console.log('[INFO]', msg); },
  error(msg){ this.show(msg); console.error('[ERR]', msg); }
};

/* [H06] State & DOM Refs */
const STATE = { etag:null, events:[], selected:null, links:null, optimisticId:null };

const DOM = {
  evName:         ()=>document.getElementById('evName'),
  evDate:         ()=>document.getElementById('evDate'),
  seedMode:       ()=>document.getElementById('seedMode'),
  elimType:       ()=>document.getElementById('elimType'),
  btnCreate:      ()=>document.getElementById('btnCreate'),
  chooseEvent:    ()=>document.getElementById('chooseEvent'),
  btnMakeDefault: ()=>document.getElementById('btnMakeDefault'),
  btnArchive:     ()=>document.getElementById('btnArchive'),
  btnCopyLinks:   ()=>document.getElementById('btnCopyLinks'),
  btnRepairShort: ()=>document.getElementById('btnRepairShort'),
  btnRepairAllShort: ()=>document.getElementById('btnRepairAllShort'),
  btnConfigureForm:()=>document.getElementById('btnConfigureForm'), // reserved if you add it back
  openPublic:     ()=>document.getElementById('openPublic'),
  openDisplay:    ()=>document.getElementById('openDisplay'),
  openPoster:     ()=>document.getElementById('openPoster'),
  qrImg:          ()=>document.getElementById('qrImg'),
  qrLink:         ()=>document.getElementById('qrLink'),
  diagOut:        ()=>document.getElementById('diagOut')
};

/* [H07] RPC Wrapper */
function rpc(fn, ...args){
  return new Promise((res, rej)=>{
    if(!window.google || !google.script || !google.script.run){
      const msg='google.script.run unavailable — open the deployed Web App URL';
      TOAST.error(msg); return rej(new Error(msg));
    }
    google.script.run
      .withSuccessHandler(res)
      .withFailureHandler(e=>rej(new Error(e?.message||String(e))))
      [fn](...args);
  });
}

/* [H08] Bootstrap & Wiring */
window.addEventListener('DOMContentLoaded', async () => {
  wireHandlers();
  await bootstrap();
  await swrEventsOnce();
});

function wireHandlers(){
  DOM.btnCreate().addEventListener('click', onCreate);
  DOM.chooseEvent().addEventListener('change', onChoose);
  DOM.btnMakeDefault().addEventListener('click', onMakeDefault);
  DOM.btnArchive().addEventListener('click', onArchive);
  DOM.btnCopyLinks().addEventListener('click', onCopyLinks);
  DOM.btnRepairShort().addEventListener('click', onRepairShortlinks);
  DOM.btnRepairAllShort().addEventListener('click', onRepairAllShortlinks);

  document.getElementById('btnSmoke').addEventListener('click', onSmoke);
  document.getElementById('btnViewLogs').addEventListener('click', onViewLogs);
  document.getElementById('btnClearLogs').addEventListener('click', onClearLogs);
}

async function bootstrap(){
  try {
    // If you add a dedicated bootstrap server fn, call it; else noop
    if (google?.script?.run?.ensureAll_) await rpc('ensureAll_');
  } catch (e) {
    TOAST.error('Bootstrap failed: ' + (e.message || e));
  }
}

/* [H09] Events List (SWR dropdown) */
async function swrEventsOnce(_retried){
  try {
    const res = await rpc('getEventsSafe', STATE.etag);
    if (!res || typeof res !== 'object') {
      if (!_retried) return swrEventsOnce(true);
      throw new Error('invalid response');
    }
    if (res.ok === false) throw new Error('events error');
    if (res.status === 304 || res.notModified) return;
    STATE.events = Array.isArray(res.items) ? res.items : [];
    STATE.etag   = res.etag || null;
    paintDropdown(STATE.events);
  } catch (err) {
    TOAST.error('Events load failed'); console.error(err);
  }
}
function paintDropdown(items){
  const sel = DOM.chooseEvent();
  const keep = STATE.optimisticId || sel.value;
  sel.innerHTML = '';
  if (!items.length){
    sel.innerHTML = '<option value="">No events yet — create above</option>';
    setManageDisabled(true); clearLinks(); clearQr(); STATE.optimisticId=null; return;
  }
  for (const ev of items){
    const label = (ev.name && String(ev.name).trim()) || ev.slug || ev.id || '(unnamed)';
    const txt = label + (ev.startDateISO ? ` (${ev.startDateISO})` : '') + (ev.isDefault ? ' ★' : '');
    const opt = document.createElement('option');
    opt.value = ev.id; opt.textContent = txt;
    sel.appendChild(opt);
  }
  if ([...sel.options].some(o => o.value === keep)) sel.value = keep;
  sel.value = sel.value || items[0].id;
  STATE.selected = sel.value;
  STATE.optimisticId = null;
  setManageDisabled(false);
  hydrateLinksAndQr();
}

/* [H10] Create Eventbook */
async function onCreate(){
  const payload = {
    name: DOM.evName().value.trim(),
    startDateISO: DOM.evDate().value || '',
    seedMode: DOM.seedMode().value,
    elimType: DOM.elimType().value
  };
  if (!payload.name){ TOAST.error('Name is required'); return; }

  TOAST.info('Creating…');
  try {
    const res = await rpc('createEventbook', payload);
    if (!res || res.ok === false) throw new Error('createEventbook failed');
    STATE.optimisticId = res.id || null;
    TOAST.info(res.idempotent ? 'Already existed — selected existing.' : 'Created!');
    DOM.evName().value = ''; DOM.evDate().value = '';
    STATE.etag = null;
    await swrEventsOnce();
  } catch (err) {
    TOAST.error('Create failed'); console.error(err);
  }
}

/* [H11] Manage Actions (default, archive, form — archive/default are optional server fns) */
function onChoose(){
  const sel = DOM.chooseEvent();
  STATE.selected = sel.value || null;
  setManageDisabled(!STATE.selected);
  hydrateLinksAndQr();
}
async function onMakeDefault(){
  if (!STATE.selected) return;
  try {
    if (!google?.script?.run?.setDefaultEvent) { TOAST.error('setDefaultEvent not available'); return; }
    await rpc('setDefaultEvent', STATE.selected);
    TOAST.info('Default set');
    STATE.etag=null; await swrEventsOnce();
  } catch (err) { TOAST.error('Failed'); console.error(err); }
}
async function onArchive(){
  if (!STATE.selected) return;
  if (!confirm('Archive this eventbook?')) return;
  try {
    if (!google?.script?.run?.archiveEvent) { TOAST.error('archiveEvent not available'); return; }
    await rpc('archiveEvent', STATE.selected);
    TOAST.info('Archived');
    STATE.etag=null; await swrEventsOnce();
  } catch (err) { TOAST.error('Failed'); console.error(err); }
}

/* [H12] Links & QR (strict: QR only when verified shortlink exists) */
async function hydrateLinksAndQr(){
  if (!STATE.selected){ clearLinks(); clearQr(); return; }
  try {
    const res = await rpc('getEventQuickLinks', STATE.selected);
    if (!res || res.ok === false) throw new Error('quicklinks failed');

    DOM.openPublic().href  = res.publicUrl || '';
    DOM.openDisplay().href = res.displayUrl || '';
    DOM.openPoster().href  = res.posterUrl  || res.workbookUrl || '';
    DOM.btnCopyLinks().disabled = !(res.publicUrl || res.displayUrl || res.posterUrl || res.workbookUrl);

    // STRICT QR: use verified endpoint if available else hide
    if (google?.script?.run?.getShareQrVerified) {
      const v = await rpc('getShareQrVerified', STATE.selected);
      if (!v || v.ok === false || !v.qrUrlVerified){ clearQr(); return; }
      DOM.qrImg().src = v.qrUrlVerified; DOM.qrImg().style.display = '';
      DOM.qrLink().href = v.qrUrlVerified; DOM.qrLink().textContent = 'Open QR';
    } else {
      clearQr();
    }
  } catch (err) {
    console.error(err); clearLinks(); clearQr();
  }
}

/* [H13] Diagnostics */
async function onSmoke(){
  DOM.diagOut().textContent = 'Running…';
  try {
    if (!google?.script?.run?.runSmokeSafe) { DOM.diagOut().textContent='No smoke endpoint'; return; }
    const res = await rpc('runSmokeSafe', { form:false });
    DOM.diagOut().textContent = JSON.stringify(res, null, 2);
    TOAST[res && res.ok ? 'info' : 'error'](res && res.ok ? 'Smoke OK' : 'Smoke failed');
    STATE.etag = null; await swrEventsOnce();
  } catch (err) {
    DOM.diagOut().textContent = String(err);
    TOAST.error('Smoke failed — see console'); console.error(err);
  }
}
async function onViewLogs(){
  DOM.diagOut().textContent = 'Loading logs…';
  try {
    if (!google?.script?.run?.getLogs) { DOM.diagOut().textContent='No logs endpoint'; return; }
    const res = await rpc('getLogs', 300);
    if (!res || res.ok === false){ TOAST.error('Log fetch error'); return; }
    DOM.diagOut().textContent = JSON.stringify(res.items || [], null, 2);
  } catch (err) { TOAST.error('Log fetch failed'); console.error(err); }
}
async function onClearLogs(){
  if (!confirm('Clear logs?')) return;
  try {
    if (!google?.script?.run?.clearLogs) { TOAST.error('No clear logs endpoint'); return; }
    await rpc('clearLogs');
    TOAST.info('Logs cleared'); onViewLogs();
  } catch (err) { TOAST.error('Clear failed'); console.error(err); }
}

/* [H14] Shortlink Hygiene (repair one / all)
   Implementation note: calling getEventQuickLinks() on the server refreshes the standard shortlinks
   (FORM, PUBLIC, DISPLAY, POSTER_SHEET, POSTER_IMG, POSTER_PAGE) to the current base URL. */
async function onRepairShortlinks(){
  if (!STATE.selected) return;
  try {
    TOAST.info('Repairing shortlinks…');
    await rpc('getEventQuickLinks', STATE.selected); // rehydrates standard shortlinks
    TOAST.info('Shortlinks repaired');
    await hydrateLinksAndQr();
  } catch (err) {
    TOAST.error('Repair failed'); console.error(err);
  }
}
async function onRepairAllShortlinks(){
  if (!STATE.events.length){ TOAST.error('No events'); return; }
  if (!confirm(`Repair shortlinks for ${STATE.events.length} event(s)?`)) return;
  try {
    TOAST.info('Repairing all shortlinks…');
    for (const ev of STATE.events){
      try { await rpc('getEventQuickLinks', ev.id); } catch (e) { console.warn('Repair failed for', ev.id, e); }
    }
    TOAST.info('All shortlinks repaired');
    await hydrateLinksAndQr();
  } catch (err) {
    TOAST.error('Bulk repair failed'); console.error(err);
  }
}

/* [H15] Utilities */
function setManageDisabled(disabled){
  DOM.btnMakeDefault().disabled = disabled;
  DOM.btnArchive().disabled = disabled;
  DOM.btnCopyLinks().disabled = disabled;
  DOM.btnRepairShort().disabled = disabled;
}
function clearLinks(){
  DOM.openPublic().removeAttribute('href');
  DOM.openDisplay().removeAttribute('href');
  DOM.openPoster().removeAttribute('href');
  DOM.btnCopyLinks().disabled = true;
}
function clearQr(){
  const img = DOM.qrImg(); img.removeAttribute('src'); img.style.display='none';
  const a = DOM.qrLink(); a.removeAttribute('href'); a.textContent='';
}
async function onCopyLinks(){
  const links = [
    ['Public',  DOM.openPublic().href || ''],
    ['Display', DOM.openDisplay().href || ''],
    ['Poster',  DOM.openPoster().href || '']
  ].filter(([,u])=>!!u);
  if (!links.length){ TOAST.error('No links to copy'); return; }
  const text = links.map(([k,u])=>`${k}: ${u}`).join('\n');
  try {
    await navigator.clipboard.writeText(text);
    TOAST.info('Links copied');
  } catch {
    // Fallback
    const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    TOAST.info('Links copied');
  }
}
  </script>
</body>
</html>