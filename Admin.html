<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title><?= appTitle ?> · Admin</title>
  <?!= include('Styles'); ?>
  <?!= include('NuSdk'); ?>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Admin</h1>
      <div class="meta">
        <small id="build">Build: <?= BUILD_ID ?></small>
      </div>
    </header>

    <!-- Control status banner (only on hard failure; auto-provision is default) -->
    <div id="ctrlBannerMount"></div>

    <section aria-labelledby="evt-head">
      <h2 id="evt-head">Event</h2>
      <div class="form-grid">
        <label for="chooseEvent" data-sync="" data-testid="event-select-label">
          Choose event
          <select id="chooseEvent" data-testid="event-select"></select>
        </label>

        <label for="evtSlug">
          Slug (read-only)
          <input id="evtSlug" type="text" readonly data-testid="event-slug" />
        </label>

        <label for="evtDate">
          Date (from source)
          <input id="evtDate" type="text" readonly data-testid="event-date" />
        </label>

        <label for="evtName">
          Name (from source)
          <input id="evtName" type="text" readonly data-testid="event-name" />
        </label>
      </div>

      <div class="actions row">
        <button class="btn" id="btnCreateEvent" data-testid="btn-create-event">Create/Ensure Event Workbook</button>
        <button class="btn" id="btnRefresh" data-testid="btn-refresh">Refresh</button>
      </div>
    </section>

    <section aria-labelledby="settings-head">
      <h2 id="settings-head">Settings</h2>
      <div class="form-grid">
        <label class="row" for="chkSignup">
          <input id="chkSignup" type="checkbox" data-testid="opt-include-signup" />
          Include signup
        </label>

        <label for="posterMode">
          Poster mode
          <select id="posterMode" data-testid="opt-poster-mode">
            <option value="image">Image Poster (QR allowed)</option>
            <option value="text">Text Poster (QR allowed)</option>
          </select>
        </label>

        <label class="row" for="chkCoach">
          <input id="chkCoach" type="checkbox" data-testid="opt-coachmarks" />
          Show coachmarks (onboarding nudges)
        </label>

        <div>
          <div class="muted" style="margin-bottom:6px;">Quick open</div>
          <div class="row gap">
            <button class="btn" id="btnOpenPoster" data-testid="btn-open-poster">Open Poster</button>
            <button class="btn" id="btnOpenPublic" data-testid="btn-open-public">Open Public</button>
            <button class="btn" id="btnOpenDisplay" data-testid="btn-open-display">Open Display</button>
          </div>
        </div>
      </div>
      <div class="actions row">
        <button class="btn btn-xl" id="btnSave" data-testid="btn-save">Save</button>
      </div>
    </section>

    <section aria-labelledby="linkstatus-head">
      <h2 id="linkstatus-head">Link status</h2>
      <p class="muted">We never show a QR unless verified. URL presence is yellow; verified QR is green.</p>
      <table class="table" data-testid="table-link-status">
        <thead>
          <tr>
            <th>Channel</th>
            <th>Status</th>
            <th>URL</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="linkStatusBody">
          <!-- rows injected -->
        </tbody>
      </table>
    </section>

    <section class="diag collapsed" id="diag" aria-labelledby="diag-head" data-testid="diagnostics">
      <div class="diag-head">
        <h2 id="diag-head">Diagnostics</h2>
        <div class="diag-actions">
          <label class="diag-checkbox row">
            <input type="checkbox" id="chkLiveLogs" checked data-testid="diag-live-logs" />
            Live logs
          </label>
          <button class="btn" id="btnClearLogs" data-testid="diag-clear">Clear</button>
          <button class="btn" id="btnToggleDiag" data-testid="diag-toggle">Expand</button>
        </div>
      </div>
      <div class="diag-body" id="diagBody" role="log" aria-live="polite"></div>
    </section>
  </div>

  <script>
  /* ===== Admin logic (v4.1.1a, auto-provision copy) ===== */
  const { rpc, retry, toast, esc } = NUSDK;

  const state = {
    events: [],
    currentId: '',
    settings: { includeSignup: false, posterMode: 'image', showCoach: true }
  };

  const els = {
    ctrlMount: document.getElementById('ctrlBannerMount'),
    choose: document.getElementById('chooseEvent'),
    lblChoose: document.querySelector('label[for="chooseEvent"]'),
    slug: document.getElementById('evtSlug'),
    date: document.getElementById('evtDate'),
    name: document.getElementById('evtName'),
    btnCreate: document.getElementById('btnCreateEvent'),
    btnRefresh: document.getElementById('btnRefresh'),
    chkSignup: document.getElementById('chkSignup'),
    posterMode: document.getElementById('posterMode'),
    chkCoach: document.getElementById('chkCoach'),
    btnSave: document.getElementById('btnSave'),
    btnOpenPoster: document.getElementById('btnOpenPoster'),
    btnOpenPublic: document.getElementById('btnOpenPublic'),
    btnOpenDisplay: document.getElementById('btnOpenDisplay'),
    linkTbody: document.getElementById('linkStatusBody'),
    diag: document.getElementById('diag'),
    diagBody: document.getElementById('diagBody'),
    btnClearLogs: document.getElementById('btnClearLogs'),
    btnToggleDiag: document.getElementById('btnToggleDiag'),
    chkLiveLogs: document.getElementById('chkLiveLogs'),
  };

  function log(msg, level){
    if (!els.chkLiveLogs.checked) return;
    const row = document.createElement('div');
    row.className = 'lvl-' + (level || 'info');
    row.textContent = new Date().toLocaleTimeString() + ' — ' + String(msg);
    els.diagBody.appendChild(row);
    els.diagBody.scrollTop = els.diagBody.scrollHeight;
  }

  function setDiagExpanded(expanded){
    els.diag.classList.toggle('collapsed', !expanded);
    els.btnToggleDiag.textContent = expanded ? 'Collapse' : 'Expand';
  }

  // Updated: only show banner on hard failure; otherwise stay silent (backend auto-provisions).
  async function preflightControlBanner(){
    try {
      const st = await rpc('getControlStatus');
      // Healthy path: template present AND control present with no missing tabs.
      const healthy = !!(st && st.templateId && st.present && (!st.missingTabs || st.missingTabs.length === 0) && !st.err);
      if (healthy) { els.ctrlMount.replaceChildren(); return; }

      // Try a self-heal silently; only show banner if it still isn’t healthy.
      try {
        const healed = await rpc('ensureControlWorkbook');
        if (healed?.ok) {
          // Re-check after heal
          const st2 = await rpc('getControlStatus');
          const healthy2 = !!(st2 && st2.templateId && st2.present && (!st2.missingTabs || st2.missingTabs.length === 0) && !st2.err);
          if (healthy2) { els.ctrlMount.replaceChildren(); return; }
        }
      } catch (_e) {}

      // Hard failure → show minimal, action-oriented banner
      const bar = document.createElement('div');
      bar.className = 'pfbar';
      bar.setAttribute('data-testid','ctrl-banner');
      const msg = (st && st.err) ? ('Error: ' + st.err) :
                  (!st?.templateId ? 'Template unavailable' :
                   (!st?.present ? 'Control workbook unavailable' :
                    'Control tabs missing: '+ (st.missingTabs||[]).join(', ')));
      bar.innerHTML = `
        <span class="pfpill pferr">Control issue</span>
        <span class="pfmsg">${esc(msg)}</span>
        <div style="display:flex;gap:8px;margin-left:auto;">
          <button class="pfbtn" data-testid="btn-repair">Repair now</button>
          <button class="pfbtn pfhide" title="Hide" data-testid="btn-hide-ctrl-banner">×</button>
        </div>
        <div class="pfdetails">
          <div class="pfrow"><span class="pfpill ${st?.templateId ? 'pfok':'pferr'}">Template ${st?.templateId ? 'configured':'missing'}</span></div>
          <div class="pfrow"><span class="pfpill ${st?.present && (!st.missingTabs || st.missingTabs.length===0) ? 'pfok':'pferr'}">
            Control ${st?.present ? (st.missingTabs && st.missingTabs.length ? 'incomplete' : 'ready') : 'missing'}</span>
          </div>
        </div>
      `;
      bar.querySelector('[data-testid="btn-repair"]').onclick = async () => {
        try {
          const r = await rpc('ensureControlWorkbook');
          if (r?.ok) {
            toast('Control repaired');
            els.ctrlMount.replaceChildren();
            await loadEvents();
          } else {
            toast.error(r?.error || 'Repair failed');
          }
        } catch(e){ toast.error('Repair error'); log('repair: '+(e.message||e),'error'); }
      };
      bar.querySelector('[data-testid="btn-hide-ctrl-banner"]').onclick = ()=> bar.remove();
      els.ctrlMount.replaceChildren(bar);
    } catch (e) {
      log('Control preflight failed: ' + (e.message || e), 'warn');
    }
  }

  async function loadEvents(){
    els.lblChoose?.setAttribute('data-sync','syncing');
    try{
      const r = await retry(()=> rpc('listEvents'), 3, [300,600,1200]);
      if (!r?.ok) throw new Error(r?.error || 'listEvents failed');
      state.events = r.events || [];
      els.choose.innerHTML = state.events.map(ev => `<option value="${esc(ev.id)}">${esc(ev.name)}</option>`).join('');
      if (!state.currentId && state.events.length) state.currentId = state.events[0].id;
      els.choose.value = state.currentId || '';
      populateEventMeta();
      await refreshLinkStatus();
    } catch(e){
      toast.error('Failed to load events');
      log('loadEvents: ' + (e.message || e), 'error');
    } finally {
      els.lblChoose?.removeAttribute('data-sync');
    }
  }

  function findCurrent(){
    return state.events.find(e => e.id === state.currentId) || null;
  }

  function populateEventMeta(){
    const ev = findCurrent();
    if (!ev) { els.slug.value=''; els.date.value=''; els.name.value=''; return; }
    els.slug.value = ev.slug || '';
    els.date.value = ev.startDateISO || '';
    els.name.value = ev.name || '';
  }

  async function saveSettings(){
    const ev = findCurrent();
    if (!ev) return toast.error('Pick an event first');
    const payload = {
      eventId: ev.id,
      includeSignup: !!els.chkSignup.checked,
      posterMode: els.posterMode.value || 'image',
      showCoach: !!els.chkCoach.checked
    };
    try {
      const r = await rpc('saveAdminSettings', payload);
      if (!r?.ok) throw new Error(r?.error || 'save failed');
      toast('Saved');
      log('Saved settings for ' + ev.id);
      await refreshLinkStatus();
    } catch(e){
      toast.error('Save failed');
      log('saveSettings: ' + (e.message || e), 'error');
    }
  }

  function openPoster(){
    const ev = findCurrent(); if (!ev) return;
    const mode = els.posterMode.value || 'image';
    window.open(`?p=poster&event=${encodeURIComponent(ev.slug||ev.id)}&mode=${encodeURIComponent(mode)}`, '_blank');
  }
  function openPublic(){
    const ev = findCurrent(); if (!ev) return;
    window.open(`?p=public&event=${encodeURIComponent(ev.slug||ev.id)}`, '_blank');
  }
  function openDisplay(){
    const ev = findCurrent(); if (!ev) return;
    window.open(`?p=display&event=${encodeURIComponent(ev.slug||ev.id)}`, '_blank');
  }

  function renderLinkRow(label, status, url, verifyAction){
    // status: 'absent' (red), 'url' (yellow), 'qr' (green)
    const badge = status === 'qr' ? '<span class="pfpill pfok">Verified QR</span>'
                 : status === 'url' ? '<span class="pfpill pfwarn">URL only</span>'
                 : '<span class="pfpill pferr">Absent</span>';
    const urlCell = url ? `<a href="${esc(url)}" target="_blank" rel="noopener">${esc(url)}</a>` : '<span class="muted">—</span>';
    const actBtn = (status === 'url' && verifyAction)
      ? `<button class="btn" data-action="${esc(verifyAction)}">Mark Verified</button>`
      : '<span class="muted">—</span>';
    return `<tr data-row="${esc(label)}" data-testid="row-${esc(label)}">
      <td>${esc(label)}</td>
      <td>${badge}</td>
      <td>${urlCell}</td>
      <td>${actBtn}</td>
    </tr>`;
  }

  async function refreshLinkStatus(){
    const ev = findCurrent(); if (!ev) return;
    try{
      const [sSignup, sPublic] = await Promise.all([
        rpc('getSignupQr', ev.id),  // use id to align with property keys
        rpc('getShareQr', ev.id)
      ]);
      const rows = [];
      // Signup
      if (sSignup?.ok === true) {
        const hasQR = !!sSignup.qrB64;
        rows.push(renderLinkRow('Signup', hasQR ? 'qr':'url', sSignup.url, 'verify-signup'));
      } else {
        rows.push(renderLinkRow('Signup', 'absent', '', ''));
      }
      // Public
      if (sPublic?.ok === true) {
        const hasQR = !!sPublic.qrB64;
        rows.push(renderLinkRow('Public', hasQR ? 'qr':'url', sPublic.url, 'verify-public'));
      } else {
        rows.push(renderLinkRow('Public', 'absent', '', ''));
      }
      els.linkTbody.innerHTML = rows.join('');
      // Wire verify buttons
      els.linkTbody.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.onclick = async () => {
          const act = btn.getAttribute('data-action');
          try{
            const opts = { public:false, signup:false };
            if (act === 'verify-public') opts.public = true;
            if (act === 'verify-signup') opts.signup = true;
            const r = await rpc('verifyEventLinks', ev.id, opts);
            if (!r?.ok) throw new Error(r?.error || 'verify failed');
            toast('Marked verified');
            await refreshLinkStatus();
          } catch(e){
            toast.error('Verify failed');
            log('verify: ' + (e.message || e), 'error');
          }
        };
      });
    } catch(e){
      log('refreshLinkStatus: ' + (e.message || e), 'error');
    }
  }

  // Wire UI
  els.btnSave.onclick = saveSettings;
  els.btnOpenPoster.onclick = openPoster;
  els.btnOpenPublic.onclick = openPublic;
  els.btnOpenDisplay.onclick = openDisplay;
  els.btnCreate.onclick = async ()=>{
    const ev = findCurrent(); if (!ev) return toast.error('Pick an event first');
    try{
      const payload = {
        id: ev.id, slug: ev.slug, name: ev.name, dateISO: ev.startDateISO,
        includeSignup: !!els.chkSignup.checked
      };
      const r = await rpc('createEventFromControl', payload);
      if (!r?.ok) throw new Error(r?.error || 'create failed');
      toast(r.created ? 'Event workbook created' : 'Event workbook ready');
      log('createEventFromControl ok: ' + JSON.stringify({ id:r.eventId, book:r.eventBookId }));
      await refreshLinkStatus();
    } catch(e){
      toast.error('Create failed');
      log('createEvent: ' + (e.message || e), 'error');
    }
  };
  els.btnRefresh.onclick = async ()=>{ await loadEvents(); };
  els.choose.onchange = async (e)=>{ state.currentId = e.target.value; populateEventMeta(); await refreshLinkStatus(); };
  els.btnClearLogs.onclick = ()=> els.diagBody.replaceChildren();
  els.btnToggleDiag.onclick = ()=> setDiagExpanded(els.diag.classList.contains('collapsed'));

  document.addEventListener('DOMContentLoaded', async ()=>{
    setDiagExpanded(false);
    await preflightControlBanner(); // usually silent; banner only on hard failure
    await loadEvents();
    toast('Admin ready');
  });
  </script>
</body>
</html>