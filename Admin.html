</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>
        <?= appTitle ?> ¬∑ Admin
    </title>
    <?!= include('Styles'); ?>
    <style>
        /* Admin-only small tweaks */
        .section-caption {
            margin-top: -6px;
            margin-bottom: 8px
        }

        .label-inline {
            font-size: .9rem;
            margin-left: 6px
        }

        .qrwrap {
            display: flex;
            gap: 14px;
            align-items: center;
            flex-wrap: wrap
        }

        .links a {
            margin-right: 10px
        }

        /* Busy overlay (page-local, mirrors other views) */
        #busy {
            position: fixed;
            inset: 0;
            display: none;
            place-items: center;
            z-index: 4000;
            background: rgba(0, 0, 0, .55);
        }

        #busy .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #busy .spinner {
            font-size: 1.6rem;
            line-height: 1;
            display: flex;
            gap: 8px;
        }

        #busy .msg {
            font-weight: 700;
        }
    </style>
</head>

<body>
    <header class="appbar">
        <div class="appbar__title">
            <?= appTitle ?> ¬∑ Admin
        </div>
    </header>

    <main class="container">

        <!-- Busy overlay -->
        <div id="busy" aria-live="polite">
            <div class="card">
                <div class="spinner">
                    <span class="mascot" data-kind="runner">üèÉ‚Äç‚ôÇÔ∏è</span>
                    <span class="mascot" data-kind="pitcher">ü•é</span>
                    <span class="mascot" data-kind="bocce">üß∂</span>
                </div>
                <div class="msg">Working‚Ä¶</div>
            </div>
        </div>

        <!-- Toast (Styles puts it top-center) -->
        <div id="toast" class="toast" style="display:none;" role="status" aria-live="polite"></div>

        <!-- CREATE EVENT -->
        <section class="card" aria-labelledby="createTitle">
            <h2 class="card__title" id="createTitle">Create Event</h2>

            <div class="grid grid--compact">
                <input id="evName" class="input" placeholder="Event name (e.g., Fall Weeklies)" autocomplete="off" />
                <input id="evDate" class="input" type="date" />
                <div class="row">
                    <label class="sr-only" for="evFlow">Flow</label>
                    <select id="evFlow" class="input" title="Flow">
                        <option value="SEASON_TOURNEY">Season ‚Üí Tournament</option>
                        <option value="TOURNEY_ONLY">Tournament only</option>
                    </select>

                    <label class="sr-only" for="evWeeks">Weeks</label>
                    <select id="evWeeks" class="input" title="Weeks">
                        <option value="">Weeks‚Ä¶</option>
                        <option>3</option>
                        <option>4</option>
                        <option selected>5</option>
                        <option>6</option>
                        <option>7</option>
                        <option>8</option>
                    </select>

                    <label class="sr-only" for="evElim">Elimination</label>
                    <select id="evElim" class="input" title="Elimination">
                        <option value="SINGLE" selected>Single Elimination</option>
                        <option value="DOUBLE">Double Elimination</option>
                    </select>

                    <label class="sr-only" for="evSeed">Seeding</label>
                    <select id="evSeed" class="input" title="Seeding">
                        <option value="RANDOM" selected>Random</option>
                        <option value="SEEDED">Seeded</option>
                    </select>

                    <button id="btnCreate" class="btn btn--primary tap-xl">Create</button>
                </div>
            </div>
            <p class="hint mt-1">Defaults: Flow = Season‚ÜíTournament, Weeks = 5, Elimination = Single, Seeding = Random.
            </p>
            <div id="createMsg" class="hint" role="status" aria-live="polite"></div>
        </section>

        <!-- MANAGE EVENT -->
        <section class="card" aria-labelledby="manageTitle">
            <h2 class="card__title" id="manageTitle">Manage Event</h2>

            <div class="row row--justify">
                <label class="sr-only" for="chooseEvent">Choose Event</label>
                <select id="chooseEvent" class="input input--select"
                    title="Choose Event (empty until you create one)"></select>
                <button id="btnRefreshEvents" class="btn btn--ghost btn--icon" title="Refresh"
                    aria-label="Refresh">‚Üª</button>
            </div>
            <p id="emptyTip" class="hint mt-1" style="display:none;">
                No events yet ‚Äî create one above to populate this menu.
            </p>

            <div id="eventMeta" class="mt-2"><!-- Filled by renderCurrent() --></div>

            <div class="actions">
                <button id="btnSetDefault" class="btn">Set Default</button>
                <button id="btnOpenPublic" class="btn">Open Public</button>
                <a id="aOpenTV" class="btn btn--ghost" target="_blank" rel="noopener">Open TV/Display</a>
                <button id="btnOpenSheets" class="btn">Open Sheets</button>
            </div>
        </section>

        <!-- SIGNUPS -->
        <section class="card" aria-labelledby="signupsTitle">
            <h2 class="card__title" id="signupsTitle">Signups</h2>
            <div class="row" style="align-items:flex-end;">
                <div>
                    <div id="signupCountTile" class="tile">0</div>
                    <div class="hint">Total signups</div>
                </div>
                <div>
                    <button id="btnCreateForm" class="btn">Create Signup Form</button>
                    <label class="label-inline"><input type="checkbox" id="optEmail"> Require Email</label>
                    <label class="label-inline"><input type="checkbox" id="optPhone"> Phone</label>
                    <label class="label-inline"><input type="checkbox" id="optNotes"> Notes</label>
                </div>
            </div>
            <div id="seedTools" class="row mt-1" style="display:none;">
                <button id="btnAddSeedCol" class="btn">Add/Update ‚ÄúSeed‚Äù Column</button>
                <span class="hint">For seeded brackets, add seeds in the Signups sheet (1..N).</span>
            </div>
        </section>

        <!-- SHARE -->
        <section class="card" aria-labelledby="shareTitle">
            <h2 class="card__title" id="shareTitle">Share</h2>
            <div class="qrwrap">
                <div>
                    <div id="qrPublic" class="qr muted" title="Public link QR"></div>
                    <div class="section-caption hint">Public QR</div>
                    <div class="row">
                        <button id="btnCopyPublic" class="btn btn--ghost">Copy Public Link</button>
                        <button id="btnCopyDisplay" class="btn btn--ghost">Copy Display Link</button>
                        <button id="btnCopyPoster" class="btn btn--ghost">Copy Poster Link</button>
                    </div>
                    <div id="publicUrl" class="hint" style="margin-top:6px;"></div>
                </div>
                <div>
                    <div id="qrForm" class="qr muted" title="Signup form QR"></div>
                    <div class="section-caption hint">Signup Form QR</div>
                    <div class="row">
                        <button id="btnCopyForm" class="btn btn--ghost">Copy Form Link</button>
                    </div>
                    <div id="formUrl" class="hint" style="margin-top:6px;"></div>
                </div>
            </div>
            <p class="hint mt-1">Public & TV pages auto-refresh. Share the QR or short link.</p>
        </section>

        <!-- SCHEDULE -->
        <section class="card" aria-labelledby="schedTitle">
            <h2 class="card__title" id="schedTitle">Schedule</h2>
            <div class="row">
                <label class="sr-only" for="weeksEdit">Weeks</label>
                <select id="weeksEdit" class="input" title="Weeks">
                    <option value="">Weeks‚Ä¶</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                    <option>6</option>
                    <option>7</option>
                    <option>8</option>
                </select>
                <button id="btnGenSchedule" class="btn">Generate Schedule</button>
                <span class="hint">Creates Week rows; courts/times/teams can be filled in Google Sheets.</span>
            </div>
        </section>

        <!-- BRACKETS -->
        <section class="card" aria-labelledby="brktTitle">
            <h2 class="card__title" id="brktTitle">Brackets</h2>
            <div class="row">
                <label class="sr-only" for="elimTypeEdit">Elimination</label>
                <select id="elimTypeEdit" class="input" title="Elimination">
                    <option value="SINGLE">Single Elimination</option>
                    <option value="DOUBLE">Double Elimination</option>
                </select>
                <label class="sr-only" for="seedModeEdit">Seeding</label>
                <select id="seedModeEdit" class="input" title="Seeding">
                    <option value="RANDOM">Random</option>
                    <option value="SEEDED">Seeded</option>
                </select>

                <button id="btnGenBrackets" class="btn">Generate / Reset</button>
                <button id="btnRefreshView" class="btn btn--icon" title="Refresh" aria-label="Refresh">‚Üª</button>
                <span id="brktStatus" class="hint"></span>
            </div>
            <p class="hint mt-1">If ‚ÄúSeeded‚Äù is chosen, ensure the Signups sheet has a contiguous 1..N ‚ÄúSeed‚Äù column.
            </p>
        </section>

        <!-- DiAGNOSTICS -->
        <section id="diagnostics">
            <h3>Diagnostics</h3>
            <div id="Diag Out"></div>

        <button id="btnRunAllSuites" class="btn">Run All Suites</button>

        <select id="histSuite" class="input input--select" style="max-width:180px">
          <option value="">(All suites)</option>
          <option>quick</option><option>full</option><option>create</option>
          <option>manage</option><option>signups</option><option>share</option>
          <option>schedule</option><option>brackets</option><option>allcards</option>
        </select>
        
        <select id="histLimit" class="input input--select" style="max-width:120px">
          <option value="50">Last 50</option>
          <option value="200" selected>Last 200</option>
          <option value="1000">Last 1000</option>
        </select>
            <div id="Diag History"></div>
        <button id="btnShowHistory" class="btn btn--ghost">History</button>
        <button id="btnExportTests" class="btn btn--ghost">Export CSV</button>
            <div id="Diag Trend"></div>        
        <select id="trendDays" class="input input--select" style="max-width:120px">
          <option value="7" selected>Trend 7d</option>
          <option value="30">Trend 30d</option>
          <option value="">All</option>
        </select>
        <button id="btnShowTrends" class="btn btn--ghost">Trends</button>
        
        <select id="perfDays" class="input input--select" style="max-width:120px">
          <option value="1">Perf 1d</option>
          <option value="7" selected>Perf 7d</option>
          <option value="30">Perf 30d</option>
          <option value="">All</option>
        </select>
        <button id="btnShowPerf" class="btn btn--ghost">Perf</button>
        
        <button id="btnShowFlaky" class="btn btn--ghost">Flaky</button>
        </section>        
        
    </main>

    <script>
        // ---------- Utilities ----------
        const $ = (s, p = document) => p.querySelector(s);
        const $all = (s, p = document) => Array.from(p.querySelectorAll(s));
        const fmt = (x) => (x == null ? '' : String(x));

        function toast(msg, ok = true) {
            const t = $('#toast');
            t.textContent = msg;
            t.style.display = 'block';
            t.className = 'toast ' + (ok ? 'ok' : 'danger');
            setTimeout(() => t.style.display = 'none', 2400);
        }

        function setBusy(on, message) {
            const ov = $('#busy');
            if (!ov) return;
            const msg = ov.querySelector('.msg');
            if (msg) msg.textContent = message || 'Working‚Ä¶';
            ov.style.display = on ? 'grid' : 'none';
            document.body.classList.toggle('is-busy', !!on);
        }

        function setQR(el, url) {
            if (!el) return;
            el.innerHTML = '';
            if (!url) { el.classList.add('muted'); el.title = 'No link yet'; return; }
            el.classList.remove('muted');
            const img = new Image();
            img.width = 160; img.height = 160; img.alt = 'QR';
            img.src = 'https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=' + encodeURIComponent(url);
            el.appendChild(img);
        }

        const STATE = { events: [], current: null, loading: false, links: null };

        // ---------- Load & Render ----------
        async function loadEvents(preselectId) {
            setBusy(true, 'Loading events‚Ä¶');
            const sel = $('#chooseEvent');
            const tip = $('#emptyTip');
            sel.innerHTML = '<option disabled>Loading‚Ä¶</option>';
            sel.title = 'Loading‚Ä¶';
            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(rows => {
                            STATE.events = rows || [];
                            sel.innerHTML = '';
                            if (!STATE.events.length) {
                                const o = document.createElement('option');
                                o.disabled = true;
                                o.textContent = '‚Äî No events ‚Äî';
                                sel.appendChild(o);
                                sel.disabled = true;
                                tip.style.display = 'block';
                                setCurrent(null);
                                resolve();
                                return;
                            }
                            tip.style.display = 'none';
                            sel.disabled = false;

                            STATE.events.forEach(e => {
                                const o = document.createElement('option');
                                o.value = e.eventId;
                                const dateStr = e.date || '';
                                const label = (e.name && e.name.trim()) ? e.name : (e.slug || e.sid || '(unnamed)');
                                o.textContent = `${label}${dateStr ? ' (' + dateStr + ')' : ''}${e.isDefault ? ' ‚òÖ' : ''}`;
                                o.title = `${label}${dateStr ? ' ‚Ä¢ ' + dateStr : ''}`;
                                sel.appendChild(o);
                            });

                            let chosen = null;
                            if (preselectId) chosen = STATE.events.find(e => e.eventId === preselectId);
                            if (!chosen) chosen = STATE.events.find(e => e.isDefault) || STATE.events[0] || null;

                            if (chosen) { sel.value = chosen.eventId; setCurrent(chosen.eventId); }
                            else { setCurrent(null); }
                            resolve();
                        })
                        .withFailureHandler(err => { reject(err); })
                        .getEvents();
                });
            } catch (err) {
                console.error('getEvents failed:', err);
                toast('Failed to load events', false);
                sel.innerHTML = '<option disabled>(load failed)</option>';
                setCurrent(null);
            } finally {
                setBusy(false);
            }
        }

        function setCurrent(eventId) {
            STATE.current = STATE.events.find(e => e.eventId === eventId) || null;
            renderCurrent();
            refreshShareLinks(); // keep Share section in sync
        }

        function renderCurrent() {
            const e = STATE.current;
            const meta = $('#eventMeta');
            const publicUrlEl = $('#publicUrl');
            const formUrlEl = $('#formUrl');

            if (!e) {
                meta.innerHTML = '<div class="empty">No event selected.</div>';
                setQR($('#qrPublic'), '');
                setQR($('#qrForm'), '');
                publicUrlEl.textContent = '';
                formUrlEl.textContent = '';
                $('#seedTools').style.display = 'none';
                $('#aOpenTV').removeAttribute('href');
                return;
            }

            const dateStr = e.date || '';
            const label = (e.name && e.name.trim()) ? e.name : (e.slug || e.sid || '(unnamed)');
            meta.innerHTML = `
                <div><strong>${label}</strong>${dateStr ? ' ‚Ä¢ ' + dateStr : ''} ${e.isDefault ? '‚òÖ' : ''}</div>
                <div class="hint">Flow: ${e.flow} ‚Ä¢ Elim: ${e.elimType} ‚Ä¢ Seed: ${e.seedMode}</div>
                <div class="hint">Signups: ${e.counts?.signups ?? 0}</div>
                `;

            // show seed tools hint only when seeded
            $('#seedTools').style.display = (e.seedMode === 'SEEDED') ? 'flex' : 'none';

            // Reset visible links until refreshShareLinks() fills in
            setQR($('#qrPublic'), '');
            setQR($('#qrForm'), '');
            publicUrlEl.textContent = '';
            formUrlEl.textContent = '';
            $('#aOpenTV').removeAttribute('href');
        }

        // ---------- Share / Links ----------
        function refreshShareLinks() {
            if (!STATE.current) { STATE.links = null; return; }
            setBusy(true, 'Preparing links‚Ä¶');
            google.script.run
                .withSuccessHandler(links => {
                    STATE.links = links || {};
                    const publicUrlEl = $('#publicUrl');
                    const formUrlEl = $('#formUrl');

                    // Prefer server-provided Base64 QR (faster, offline-safe); fallback to URL QR
                    if (links.qrPublicB64) {
                        const q = $('#qrPublic'); q.innerHTML = ''; q.classList.remove('muted');
                        const img = new Image(); img.width = 160; img.height = 160; img.alt = 'QR';
                        img.src = `data:image/png;base64,${links.qrPublicB64}`; q.appendChild(img);
                    } else { setQR($('#qrPublic'), links.publicUrl || ''); }

                    if (links.qrFormB64) {
                        const q2 = $('#qrForm'); q2.innerHTML = ''; q2.classList.remove('muted');
                        const img2 = new Image(); img2.width = 160; img2.height = 160; img2.alt = 'QR';
                        img2.src = `data:image/png;base64,${links.qrFormB64}`; q2.appendChild(img2);
                    } else { setQR($('#qrForm'), links.formUrl || ''); }

                    publicUrlEl.textContent = links.publicUrl || '';
                    formUrlEl.textContent = links.formUrl || '';
                    const tv = $('#aOpenTV'); if (tv) tv.href = links.displayUrl || '#';

                    // Copy buttons
                    $('#btnCopyPublic').onclick = async () => {
                        try { await navigator.clipboard.writeText(links.publicUrl || ''); toast('Public link copied'); }
                        catch { toast('Copy failed', false); }
                    };
                    $('#btnCopyDisplay').onclick = async () => {
                        try { await navigator.clipboard.writeText(links.displayUrl || ''); toast('Display link copied'); }
                        catch { toast('Copy failed', false); }
                    };
                    $('#btnCopyPoster').onclick = async () => {
                        try { await navigator.clipboard.writeText(links.posterUrl || ''); toast('Poster link copied'); }
                        catch { toast('Copy failed', false); }
                    };
                    $('#btnCopyForm').onclick = async () => {
                        try { await navigator.clipboard.writeText(links.formUrl || ''); toast('Form link copied'); }
                        catch { toast('Copy failed', false); }
                    };

                    setBusy(false);
                })
                .withFailureHandler(err => { console.error(err); toast('Link prep failed', false); setBusy(false); })
                .getShareLinks(STATE.current.eventId);
        }

        // ---------- Handlers ----------
        document.addEventListener('change', (ev) => {
            if (ev.target && ev.target.id === 'chooseEvent') {
                setCurrent(ev.target.value);
            }
        });

        // Create event
        $('#btnCreate').addEventListener('click', async () => {
            const payload = {
                name: $('#evName').value.trim(),
                date: $('#evDate').value, // Code.gs maps startDate/date to "startDate"
                flow: $('#evFlow').value,
                weeks: $('#evFlow').value === 'SEASON_TOURNEY' ? Number($('#evWeeks').value || 0) : 0,
                elimType: $('#evElim').value,
                seedMode: $('#evSeed').value
            };

            if (!payload.name || !payload.date) { toast('Name and date are required', false); return; }
            if (payload.flow === 'SEASON_TOURNEY' && !payload.weeks) { toast('Choose weeks for Season ‚Üí Tournament', false); return; }

            setBusy(true, 'Creating event‚Ä¶');
            try {
                const created = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(row => resolve(row))
                        .withFailureHandler(err => reject(err))
                        .createEvent(payload);
                });
                toast('Event created');
                // Clear fields
                $('#evName').value = ''; $('#evDate').value = '';
                // Reload and preselect the new eventId
                await loadEvents(created && created.eventId);
            } catch (err) {
                console.error(err);
                toast((err && err.message) || 'Create failed', false);
            } finally {
                setBusy(false);
            }
        });

        // toggle weeks field by flow choice
        const syncWeeksVisibility = () => {
            const show = $('#evFlow').value === 'SEASON_TOURNEY';
            $('#evWeeks').parentElement.style.display = show ? 'block' : 'none';
        };
        $('#evFlow').addEventListener('change', syncWeeksVisibility);
        syncWeeksVisibility();

        // Refresh list
        $('#btnRefreshEvents').addEventListener('click', () => loadEvents(STATE.current?.eventId));

        // Default
        $('#btnSetDefault').addEventListener('click', async () => {
            if (!STATE.current) return;
            const id = STATE.current.eventId;
            setBusy(true, 'Setting default‚Ä¶');
            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(() => resolve())
                        .withFailureHandler(err => reject(err))
                        .setDefaultEvent(id, true);
                });
                toast('Default updated');
                await loadEvents(id);
            } catch (err) {
                toast(err?.message || 'Failed to set default', false);
            } finally { setBusy(false); }
        });

        // Openers (use getShareLinks to resolve canonical URLs)
        $('#btnOpenPublic').addEventListener('click', () => {
            if (!STATE.current) return;
            setBusy(true, 'Opening‚Ä¶');
            google.script.run
                .withSuccessHandler(links => {
                    const url = links && links.publicUrl;
                    if (url) window.open(url, '_blank'); else toast('No public link yet', false);
                    setBusy(false);
                })
                .withFailureHandler(() => { toast('Failed to open public page', false); setBusy(false); })
                .getShareLinks(STATE.current.eventId);
        });

        $('#btnOpenSheets').addEventListener('click', () => {
            if (!STATE.current) return;
            setBusy(true, 'Opening Sheets‚Ä¶');
            google.script.run
                .withSuccessHandler((url) => { if (url) window.open(url, '_blank'); else toast('Sheet not found', false); setBusy(false); })
                .withFailureHandler((err) => { toast(err?.message || 'Open Sheets failed', false); setBusy(false); })
                .openSheetUrl(STATE.current.eventId);
        });

        // Signup Form creation
        $('#btnCreateForm').addEventListener('click', async () => {
            if (!STATE.current) return;
            const opts = {
                email: $('#optEmail').checked,
                phone: $('#optPhone').checked,
                notes: $('#optNotes').checked
            };
            setBusy(true, 'Creating form‚Ä¶');
            try {
                const res = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler((r) => resolve(r))
                        .withFailureHandler((err) => reject(err))
                        .buildSignupForm(STATE.current.eventId, opts);
                });
                toast('Signup form ready');
                // Reload event list so new formUrl populates; keep current selection
                await loadEvents(STATE.current.eventId);
                // Refresh Share block immediately to show QR + links
                refreshShareLinks();
            } catch (err) {
                toast(err?.message || 'Form creation failed', false);
            } finally { setBusy(false); }
        });

        // Seed column ensure
        $('#btnAddSeedCol').addEventListener('click', async () => {
            if (!STATE.current) return;
            setBusy(true, 'Ensuring seed column‚Ä¶');
            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(() => resolve())
                        .withFailureHandler((err) => reject(err))
                        .ensureSeedColumn(STATE.current.eventId);
                });
                toast('Seed column ensured');
            } catch (err) {
                toast(err?.message || 'Failed to add Seed column', false);
            } finally { setBusy(false); }
        });

        // Schedule scaffold
        $('#btnGenSchedule').addEventListener('click', async () => {
            if (!STATE.current) return;
            const w = Number($('#weeksEdit').value || STATE.current.weeks || 0);
            if (!w) { toast('Pick number of weeks', false); return; }
            setBusy(true, 'Generating schedule‚Ä¶');
            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(() => resolve())
                        .withFailureHandler((err) => reject(err))
                        .generateSchedule(STATE.current.eventId, w);
                });
                toast('Schedule scaffold generated');
                google.script.run.refreshPublicCache(STATE.current.eventId);
            } catch (err) {
                toast(err?.message || 'Failed to generate schedule', false);
            } finally { setBusy(false); }
        });

        // Brackets
        $('#elimTypeEdit').addEventListener('change', () => $('#brktStatus').textContent = '');
        $('#seedModeEdit').addEventListener('change', () => $('#brktStatus').textContent = '');

        $('#btnGenBrackets').addEventListener('click', async () => {
            if (!STATE.current) return;
            const opts = { elimType: $('#elimTypeEdit').value, seedMode: $('#seedModeEdit').value };
            setBusy(true, 'Generating bracket‚Ä¶');
            try {
                const res = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler((r) => resolve(r))
                        .withFailureHandler((err) => reject(err))
                        .generateBrackets(STATE.current.eventId, opts);
                });
                if (res && res.ok) {
                    toast('Bracket generated');
                    $('#brktStatus').textContent = `Mode: ${opts.elimType} ¬∑ Seeding: ${opts.seedMode}`;
                    google.script.run.refreshPublicCache(STATE.current.eventId);
                } else if (res && res.reason === 'missing_seeds') {
                    if (confirm('Seeds are missing. Open Sheets to add 1..N seeds? (Cancel to generate Random)')) {
                        $('#btnOpenSheets').click();
                    } else {
                        const r2 = await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler((x) => resolve(x))
                                .withFailureHandler((err) => reject(err))
                                .generateBrackets(STATE.current.eventId, { elimType: opts.elimType, seedMode: 'RANDOM' });
                        });
                        if (r2 && r2.ok) {
                            toast('Bracket generated (Random)');
                            $('#seedModeEdit').value = 'RANDOM';
                            $('#brktStatus').textContent = `Mode: ${opts.elimType} ¬∑ Seeding: RANDOM`;
                            google.script.run.refreshPublicCache(STATE.current.eventId);
                        } else {
                            toast('Failed to generate bracket', false);
                        }
                    }
                } else {
                    toast('Failed to generate bracket', false);
                }
            } catch (err) {
                toast(err?.message || 'Bracket generation failed', false);
            } finally { setBusy(false); }
        });

        $('#btnRefreshView').addEventListener('click', () => {
            if (!STATE.current) return;
            setBusy(true, 'Refreshing‚Ä¶');
            google.script.run
                .withSuccessHandler(() => { toast('Public cache refreshed'); setBusy(false); })
                .withFailureHandler(() => { toast('Refresh failed', false); setBusy(false); })
                .refreshPublicCache(STATE.current.eventId);
        });

        // Keep signup count tile fresh
        setInterval(() => {
            if (!STATE.current) return;
            google.script.run.withSuccessHandler((n) => {
                if (typeof n === 'number') $('#signupCountTile').textContent = n;
            }).getSignupCount(STATE.current.eventId);
        }, 15000);

        // Initial load
        document.addEventListener('DOMContentLoaded', () => loadEvents());
    </script>
</body>

</html>
