<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>
        <?= appTitle ?> ¬∑ Admin
    </title>
    <?!= include('Styles'); ?>
    <style>
        /* Admin-only small tweaks */
        .section-caption {
            margin-top: -6px;
            margin-bottom: 8px
        }

        .label-inline {
            font-size: .98rem;
            margin-left: 8px
        }

        .qrwrap {
            display: flex;
            gap: 14px;
            align-items: center;
            flex-wrap: wrap
        }

        .links a {
            margin-right: 10px
        }

        /* Busy overlay (page-local) */
        #busy {
            position: fixed;
            inset: 0;
            display: none;
            place-items: center;
            z-index: 4000;
            background: rgba(0, 0, 0, .55)
        }

        #busy .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 14px 40px rgba(0, 0, 0, .35)
        }

        #busy .spinner {
            font-size: 1.6rem;
            line-height: 1;
            display: flex;
            gap: 8px
        }

        #busy .msg {
            font-weight: 900;
            font-size: 1.2rem
        }

        /* Sticky CTA */
        #stickyCta.hidden {
            display: none !important
        }

        body.is-busy #stickyCta {
            display: none !important
        }

        #stickyCta .btn {
            min-height: 56px
        }

        #ctaRow2 .btn {
            flex: 1
        }
    </style>
</head>

<body>
    <header class="appbar">
        <div class="appbar__title">
            <?= appTitle ?> ¬∑ Admin
        </div>
    </header>

    <main class="container">
        <!-- Busy overlay -->
        <div id="busy" aria-live="polite">
            <div class="card">
                <div class="spinner">
                    <span class="mascot" data-kind="runner">üèÉ‚Äç‚ôÇÔ∏è</span>
                    <span class="mascot" data-kind="pitcher">ü•é</span>
                    <span class="mascot" data-kind="bocce">üß∂</span>
                </div>
                <div class="msg">Working‚Ä¶</div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="toast" style="display:none;" role="status" aria-live="polite"></div>

        <!-- CREATE EVENT -->
        <section class="card" aria-labelledby="createTitle">
            <h2 class="card__title" id="createTitle">Create Event</h2>
            <form id="createForm" class="grid grid--compact" novalidate>
                <input id="evName" class="input" placeholder="Event name (e.g., Fall Weeklies)" autocomplete="off"
                    required />
                <input id="evDate" class="input" type="date" required />
                <div class="row">
                    <label class="sr-only" for="evFlow">Flow</label>
                    <select id="evFlow" class="input" title="Flow" aria-describedby="flowHint">
                        <option value="SEASON_TOURNEY" selected>Season ‚Üí Tournament</option>
                        <option value="SEASON_ONLY">Season only</option>
                        <option value="TOURNEY_ONLY">Tournament only</option>
                        <option value="REGISTRATION">Signups only</option>
                    </select>

                    <label class="sr-only" for="evWeeks">Weeks</label>
                    <select id="evWeeks" class="input" title="Weeks (required for Season flows)">
                        <option value="">Weeks‚Ä¶</option>
                        <option>3</option>
                        <option>4</option>
                        <option selected>5</option>
                        <option>6</option>
                        <option>7</option>
                        <option>8</option>
                    </select>

                    <button id="btnFlowHelp" class="btn btn--icon" type="button" popovertarget="popFlowHelp"
                        aria-label="Flow help">?</button>

                    <label class="sr-only" for="evElim">Elimination</label>
                    <select id="evElim" class="input" title="Elimination">
                        <option value="SINGLE" selected>Single Elimination</option>
                        <option value="DOUBLE">Double Elimination</option>
                    </select>

                    <label class="sr-only" for="evSeed">Seeding</label>
                    <select id="evSeed" class="input" title="Seeding">
                        <option value="RANDOM" selected>Random</option>
                        <option value="SEEDED">Seeded</option>
                    </select>

                    <button id="btnCreate" type="button" class="btn btn--primary btn--xl">Create</button>
                </div>
                <p id="flowHint" class="hint mt-1">Season flows require Weeks; Tournament-only & Signups-only don‚Äôt.</p>
            </form>

            <!-- Flow Help Popover -->
            <div id="popFlowHelp" popover>
                <div class="popover-title">Event flows</div>
                <ul class="hint" style="margin:0 0 8px 16px;">
                    <li><b>Season ‚Üí Tournament</b>: schedule + standings, then bracket.</li>
                    <li><b>Season only</b>: schedule + standings, no bracket.</li>
                    <li><b>Tournament only</b>: bracket only (entrants from signups).</li>
                    <li><b>Signups only</b>: registration list only.</li>
                </ul>
                <div class="popover-actions">
                    <button popovertarget="popFlowHelp" popovertargetaction="hide" class="btn btn--ghost">Close</button>
                </div>
            </div>

            <p class="hint mt-1">Defaults: Flow = Season‚ÜíTournament, Weeks = 5, Elimination = Single, Seeding = Random.
            </p>
            <div id="createMsg" class="hint" role="status" aria-live="polite"></div>
        </section>

        <!-- MANAGE EVENT -->
        <section class="card" aria-labelledby="manageTitle">
            <h2 class="card__title" id="manageTitle">Manage Event</h2>
            <div class="row row--justify">
                <label class="sr-only" for="chooseEvent">Choose Event</label>
                <select id="chooseEvent" class="input input--select"
                    title="Choose Event (empty until you create one)"></select>
                <button id="btnRefreshEvents" class="btn btn--ghost btn--icon" title="Refresh"
                    aria-label="Refresh">‚Üª</button>
            </div>
            <p id="emptyTip" class="hint mt-1" style="display:none;">No events yet ‚Äî create one above to populate this
                menu.</p>
            <div id="eventMeta" class="mt-2"><!-- Filled by renderCurrent() --></div>
            <div class="actions">
                <button id="btnSetDefault" class="btn">Set Default</button>
                <button id="btnOpenPublic" class="btn">Open Public</button>
                <a id="aOpenTV" class="btn btn--ghost" target="_blank" rel="noopener">Open TV/Display</a>
                <button id="btnOpenSheets" class="btn">Open Sheets</button>
            </div>
        </section>

        <!-- SIGNUPS -->
        <section class="card" aria-labelledby="signupsTitle">
            <h2 class="card__title" id="signupsTitle">Signups</h2>
            <div class="row" style="align-items:flex-end;">
                <div>
                    <div id="signupCountTile" class="tile">0</div>
                    <div class="hint">Total signups</div>
                </div>
                <div>
                    <button id="btnCreateForm" class="btn">Create Signup Form</button>
                    <label class="label-inline"><input type="checkbox" id="optEmail"> Require Email</label>
                    <label class="label-inline"><input type="checkbox" id="optPhone"> Phone</label>
                    <label class="label-inline"><input type="checkbox" id="optNotes"> Notes</label>
                </div>
            </div>
            <div id="seedTools" class="row mt-1" style="display:none;">
                <button id="btnAddSeedCol" class="btn">Add/Update ‚ÄúSeed‚Äù Column</button>
                <span class="hint">For seeded brackets, add seeds in the Signups sheet (1..N).</span>
            </div>
        </section>

        <!-- SHARE -->
        <section class="card" aria-labelledby="shareTitle">
            <h2 class="card__title" id="shareTitle">Share</h2>
            <div class="qrwrap">
                <div>
                    <div id="qrPublic" class="qr muted" title="Public link QR"></div>
                    <div class="section-caption hint">Public QR</div>
                    <div class="row">
                        <button id="btnCopyPublic" class="btn btn--ghost">Copy Public Link</button>
                        <button id="btnCopyDisplay" class="btn btn--ghost">Copy Display Link</button>
                        <button id="btnCopyPoster" class="btn btn--ghost">Copy Poster Link</button>
                        <button id="btnShare" class="btn btn--primary">Share‚Ä¶</button>
                    </div>
                    <div id="publicUrl" class="hint" style="margin-top:6px;"></div>
                </div>
                <div>
                    <div id="qrForm" class="qr muted" title="Signup form QR"></div>
                    <div class="section-caption hint">Signup Form QR</div>
                    <div class="row"><button id="btnCopyForm" class="btn btn--ghost">Copy Form Link</button></div>
                    <div id="formUrl" class="hint" style="margin-top:6px;"></div>
                </div>
            </div>
            <p class="hint mt-1">Public & TV pages auto-refresh. Share the QR or short link.</p>
        </section>

        <!-- SCHEDULE -->
        <section class="card" aria-labelledby="schedTitle">
            <h2 class="card__title" id="schedTitle">Schedule</h2>
            <div class="row">
                <label class="sr-only" for="weeksEdit">Weeks</label>
                <select id="weeksEdit" class="input" title="Weeks">
                    <option value="">Weeks‚Ä¶</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                    <option>6</option>
                    <option>7</option>
                    <option>8</option>
                </select>
                <button id="btnGenSchedule" class="btn">Generate Schedule</button>
                <span class="hint">Creates Week rows; courts/times/teams can be filled in Google Sheets.</span>
            </div>
        </section>

        <!-- BRACKETS -->
        <section class="card" aria-labelledby="brktTitle">
            <h2 class="card__title" id="brktTitle">Brackets</h2>
            <div class="row">
                <label class="sr-only" for="elimTypeEdit">Elimination</label>
                <select id="elimTypeEdit" class="input" title="Elimination">
                    <option value="SINGLE">Single Elimination</option>
                    <option value="DOUBLE">Double Elimination</option>
                </select>
                <label class="sr-only" for="seedModeEdit">Seeding</label>
                <select id="seedModeEdit" class="input" title="Seeding">
                    <option value="RANDOM">Random</option>
                    <option value="SEEDED">Seeded</option>
                </select>
                <button id="btnGenBrackets" class="btn">Generate / Reset</button>
                <button id="btnRefreshView" class="btn btn--icon" title="Refresh" aria-label="Refresh">‚Üª</button>
                <span id="brktStatus" class="hint"></span>
            </div>
            <p class="hint mt-1">If ‚ÄúSeeded‚Äù is chosen, ensure the Signups sheet has a contiguous 1..N ‚ÄúSeed‚Äù column.
            </p>
        </section>

        <!-- DIAGNOSTICS -->
        <section class="card" aria-labelledby="diagTitle">
            <h2 class="card__title" id="diagTitle">Diagnostics</h2>
            <div class="row">
                <select id="diagSuite" class="input input--select" style="max-width:260px">
                    <option value="quick">Quick Checks</option>
                    <option value="full">Full QA Suite</option>
                    <option value="create">Create Card</option>
                    <option value="manage">Manage Card</option>
                    <option value="signups">Signups Card</option>
                    <option value="share">Share Card</option>
                    <option value="schedule">Schedule Card</option>
                    <option value="brackets">Brackets Card</option>
                    <option value="allcards">All Card Suites</option>
                </select>
                <button id="btnRunSuite" class="btn btn--ok">Run</button>
                <button id="btnSelfHeal" class="btn">Self-Heal</button>
                <button id="btnHardReset" class="btn btn--danger">Hard Reset Events</button>
                <button id="btnShowStatus" class="btn btn--ghost">Status</button>
                <button id="btnShowLogs" class="btn btn--ghost">Logs</button>
                <button id="btnCopyReport" class="btn btn--ghost">Copy JSON</button>
            </div>

            <div id="diagOut" class="mt-2 scroll-x">
                <button id="btnExportTests" class="btn btn--ghost">Export CSV</button>
                <button id="btnRunAllSuites" class="btn">Run All Suites</button>
                <table class="table" id="diagTable" aria-live="polite">
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- STICKY CTA (mobile) -->
        <div id="stickyCta" class="sticky-cta mobile-only hidden" role="group" aria-label="Quick actions">
            <button id="ctaOpenTV" class="btn btn--ghost btn-block">Open TV</button>
            <button id="ctaForm" class="btn btn--primary btn-block">Create Form</button>
            <div id="ctaRow2" class="row" style="margin-top:8px;">
                <button id="ctaSchedule" class="btn btn-block">Generate Schedule</button>
                <button id="ctaBracket" class="btn btn--ok btn-block">Generate Bracket</button>
            </div>
        </div>
    </main>

    <script>
        /* ---------- Logging helper (breadcrumb) ---------- */
        function logFn(fn, tag) {
            const msg = "this is coming from " + fn + (tag ? " ‚Üí " + tag : "");
            console.log(msg);
        }

        /* ---------- Utilities ---------- */
        const $ = (s, p = document) => p.querySelector(s);
        const $all = (s, p = document) => Array.from(p.querySelectorAll(s));
        const fmt = (x) => (x == null ? '' : String(x));
        const sleep = (ms) => new Promise(r => { logFn("sleep", "" + ms + "ms"); setTimeout(r, ms); });

        function gs(fn, ...args) {
            logFn("gs", fn + "(" + JSON.stringify(args).slice(0, 200) + (args.length > 0 ? " ‚Ä¶" : "") + ")");
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler((res) => { logFn("gs", fn + " success"); resolve(res); })
                    .withFailureHandler((err) => { logFn("gs", fn + " fail: " + (err && err.message || err)); reject(err); })
                [fn](...args);
            });
        }

        function toast(msg, ok = true) {
            logFn("toast", (ok ? "ok" : "danger") + " ‚Üí " + msg);
            const t = $('#toast'); if (!t) return;
            t.textContent = msg; t.style.display = 'block';
            t.className = 'toast ' + (ok ? 'ok' : 'danger');
            setTimeout(() => { logFn("toast", "hide"); t.style.display = 'none'; }, 2400);
        }

        function setBusy(on, message) {
            logFn("setBusy", (on ? "on" : "off") + (message ? " ‚Üí " + message : ""));
            const ov = $('#busy'); if (!ov) return;
            const msg = ov.querySelector('.msg'); if (msg && message) msg.textContent = message;
            ov.style.display = on ? 'grid' : 'none';
            document.body.classList.toggle('is-busy', !!on);
        }

        function setQR(el, url) {
            logFn("setQR", (el ? "#" + (el.id || "no-id") : "null") + " ‚Üí " + (url || "(empty)"));
            if (!el) return;
            el.innerHTML = '';
            if (!url) { el.classList.add('muted'); el.title = 'No link yet'; return; }
            el.classList.remove('muted');
            const img = new Image();
            img.width = 200; img.height = 200; img.alt = 'QR';
            img.src = 'https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=' + encodeURIComponent(url);
            el.appendChild(img);
        }

        const copyText = async (txt) => {
            logFn("copyText", (txt || "").slice(0, 64));
            try { await navigator.clipboard.writeText(txt); return true; } catch { return false; }
        };

        function debounceWithFlush(fn, wait = 220) {
            logFn("debounceWithFlush", "wait " + wait);
            let t = null, lastArgs = null;
            const wrapped = (...args) => {
                lastArgs = args;
                if (t) clearTimeout(t);
                t = setTimeout(() => { t = null; logFn("debounceWithFlush", "flush"); fn(...(lastArgs || [])); }, wait);
            };
            wrapped.flush = () => { if (t) { clearTimeout(t); t = null; logFn("debounceWithFlush", "manual flush"); fn(...(lastArgs || [])); } };
            return wrapped;
        }

        /* ---------- Boot identity ---------- */
        const URLQ = new URLSearchParams(location.search);
        const SERVER_SLUG = "<?= slug ?>";
        const BOOT_ID =
            (window.eventId && String(window.eventId).trim()) ||
            URLQ.get('eventId') || URLQ.get('event') || URLQ.get('slug') ||
            SERVER_SLUG || '';
        logFn("BOOT_ID", BOOT_ID || "(none)");

        /* ---------- State ---------- */
        const STATE = { events: [], current: null, loading: false, links: null };
        let _loadVer = 0;

        /* ---------- Load & Render ---------- */
        // --- helpers (add once, near top with other utils) ---
        function normEvent(raw) {
            if (!raw || typeof raw !== 'object') return null;
            const id = raw.eventId || raw.id || raw.sid || '';
            const name = (raw.name && raw.name.trim()) ? raw.name.trim() : '';
            const dateISO = raw.startDate || raw.dateISO || raw.date || '';
            const isDefault = !!raw.isDefault;
            const publicUrl = raw.publicUrl || raw.public || '';
            const displayUrl = raw.displayUrl || raw.display || '';
            const formUrl = raw.formUrl || '';
            return {
                eventId: id, name, startDate: dateISO, isDefault,
                publicUrl, displayUrl, formUrl, slug: raw.slug || raw.sid || '',
                flow: raw.flow || '', weeks: raw.weeks || 0, elimType: raw.elimType || '', seedMode: raw.seedMode || '',
                counts: raw.counts || { signups: 0 }, _raw: raw
            };
        }

        // one at a time + stale guard
        let __loadEventsInflight = 0;

        // --- REPLACE your entire loadEvents with this ---
        async function loadEvents(preselectId) {
            logFrom("loadEvents", "entry" + (preselectId ? " ‚Üí preselect " + preselectId : ""));
            if (STATE.loading) return;
            STATE.loading = true;
            const myKey = ++__loadEventsInflight;

            setBusy(true, "Loading events‚Ä¶");
            const sel = $("#chooseEvent");
            const tip = $("#emptyTip");

            // try getEventsSafe() first, fallback to getEvents()
            async function fetchEvents() {
                try { return await gs("getEventsSafe"); }
                catch { return await gs("getEvents"); }
            }

            try {
                const res = await fetchEvents();
                if (myKey !== __loadEventsInflight) return; // stale response

                // Accept both shapes: array or {ok,items}
                const rawList = Array.isArray(res) ? res : (Array.isArray(res?.items) ? res.items : []);
                logFrom("loadEvents", "rows " + rawList.length);

                const items = rawList.map(normEvent).filter(Boolean);
                STATE.events = items;

                if (sel) sel.innerHTML = "";

                if (!items.length) {
                    if (sel) {
                        const o = document.createElement("option");
                        o.disabled = true; o.textContent = "‚Äî No events ‚Äî";
                        sel.appendChild(o);
                        sel.disabled = true;
                    }
                    if (tip) tip.style.display = "block";
                    setCurrent(null);
                    logFrom("loadEvents", "no events");
                    return;
                }

                if (tip) tip.style.display = "none";
                if (sel) sel.disabled = false;

                // build options
                for (const e of items) {
                    const o = document.createElement("option");
                    o.value = e.eventId;
                    const label = e.name || e.slug || "(untitled event)";
                    const dateStr = e.startDate ? " (" + e.startDate + ")" : "";
                    o.textContent = label + dateStr + (e.isDefault ? " ‚òÖ" : "");
                    o.title = label + (e.startDate ? " ‚Ä¢ " + e.startDate : "");
                    sel && sel.appendChild(o);
                }

                // choose current
                let chosen = null;
                if (preselectId) chosen = items.find(e => e.eventId === preselectId);
                if (!chosen) chosen = items.find(e => e.isDefault) || items[0];

                if (chosen) {
                    if (sel) sel.value = chosen.eventId;
                    try { persistEventId(chosen.eventId, chosen.slug); } catch { }
                    setCurrent(chosen.eventId, true);
                } else {
                    setCurrent(null);
                }

            } catch (err) {
                console.error(err);
                logFrom("loadEvents", "getEvents* failed: " + (err?.message || err));
                toast(err?.message || "Failed to load events", false);
                if (sel) sel.innerHTML = "<option disabled>(load failed)</option>";
                setCurrent(null);
            } finally {
                if (myKey === __loadEventsInflight) { /* ok */ }
                STATE.loading = false;
                setBusy(false);
                logFrom("loadEvents", "finally exit");
            }
        }

        function setCurrent(eventId, immediate = false) {
            logFn("setCurrent", "entry ‚Üí " + eventId + (immediate ? " (immediate)" : ""));
            STATE.current = STATE.events.find(e => e.eventId === eventId) || null;
            logFn("setCurrent", "STATE.current " + (STATE.current ? (STATE.current.name || STATE.current.slug || STATE.current.eventId) : "(null)"));
            renderCurrent();
            updateStickyCta();
            refreshShareLinks();
            if (immediate && refreshShareLinks.flush) { logFn("setCurrent", "flush share links"); refreshShareLinks.flush(); }
        }

        function renderCurrent() {
            logFn("renderCurrent", "entry");
            const e = STATE.current;
            const meta = $('#eventMeta');
            const publicUrlEl = $('#publicUrl');
            const formUrlEl = $('#formUrl');

            if (!e) {
                logFn("renderCurrent", "no event selected");
                meta.innerHTML = '<div class="empty">No event selected.</div>';
                setQR($('#qrPublic'), ''); setQR($('#qrForm'), '');
                publicUrlEl.textContent = ''; formUrlEl.textContent = '';
                $('#seedTools').style.display = 'none';
                $('#aOpenTV').removeAttribute('href');
                return;
            }

            const dateStr = e.startDate || e.date || '';
            const label = (e.name && e.name.trim()) ? e.name : (e.slug || e.sid || '(unnamed)');
            logFn("renderCurrent", "draw " + label);

            meta.innerHTML = `
              <div><strong>${label}</strong>${dateStr ? ' ‚Ä¢ ' + dateStr : ''} ${e.isDefault ? '‚òÖ' : ''}</div>
              <div class="hint">Flow: ${e.flow} ‚Ä¢ Elim: ${e.elimType} ‚Ä¢ Seed: ${e.seedMode}</div>
              <div class="hint">Signups: ${e.counts?.signups ?? 0}</div>
              `;

            $('#seedTools').style.display = (e.seedMode === 'SEEDED') ? 'flex' : 'none';
            setQR($('#qrPublic'), ''); setQR($('#qrForm'), '');
            publicUrlEl.textContent = ''; formUrlEl.textContent = '';
            $('#aOpenTV').removeAttribute('href');
        }

        /* ---------- Share / Links ---------- */
        const _refreshShareLinksRaw = () => {
            logFrom("_refreshShareLinksRaw", "entry");
            if (!STATE.current || !STATE.current.eventId) {
                logFrom("_refreshShareLinksRaw", "no current");
                STATE.links = null;
                return;
            }

            // Local fallback first (so user sees something even if server fetch fails)
            const local = {
                publicUrl: STATE.current.publicUrl || "",
                displayUrl: STATE.current.displayUrl || "",
                formUrl: STATE.current.formUrl || "",
                posterUrl: STATE.current.posterUrl || ""
            };

            const apply = (links) => {
                const L = links || local;
                STATE.links = L;

                setQR($("#qrPublic"), L.publicUrl || "");
                setQR($("#qrForm"), L.formUrl || "");

                const publicUrlEl = $("#publicUrl");
                const formUrlEl = $("#formUrl");
                if (publicUrlEl) publicUrlEl.textContent = L.publicUrl || "";
                if (formUrlEl) formUrlEl.textContent = L.formUrl || "";

                const tv = $("#aOpenTV");
                if (tv) { if (L.displayUrl) tv.href = L.displayUrl; else tv.removeAttribute("href"); }
            };

            // show local immediately (no spinner delay)
            apply(local);

            // Try server for fresher/shortened links; if it fails, keep local without toasting red
            if (!STATE.loading) setBusy(true, "Preparing links‚Ä¶");
            gs("getShareLinks", STATE.current.eventId)
                .then(links => { apply(links || local); })
                .catch(err => {
                    logFrom("_refreshShareLinksRaw", "catch " + (err?.message || err));
                    // no toast("danger") here; we already applied local links
                })
                .finally(() => { if (!STATE.loading) setBusy(false); logFrom("_refreshShareLinksRaw", "finally"); });
        };

        /* ---------- Selection helpers ---------- */
        function selectEvent(id) {
            logFn("selectEvent", "entry ‚Üí " + id);
            const sel = document.getElementById('chooseEvent');
            if (sel) sel.value = id;
            setCurrent(id, true);
        }

        async function reloadEventsEnsure(newId, { tries = 3, baseDelay = 240 } = {}) {
            logFn("reloadEventsEnsure", "entry ‚Üí " + newId);
            for (let i = 0; i < tries; i++) {
                logFn("reloadEventsEnsure", "try " + (i + 1) + "/" + tries);
                await loadEvents(newId);
                if (STATE.events.some(e => e.eventId === newId)) { logFn("reloadEventsEnsure", "found, select"); selectEvent(newId); return true; }
                await sleep(baseDelay * Math.pow(1.6, i));
            }
            logFn("reloadEventsEnsure", "optimistic add");
            optimisticAddEvent({ eventId: newId });
            selectEvent(newId);
            return false;
        }

        function optimisticAddEvent(mini) {
            logFn("optimisticAddEvent", "entry ‚Üí " + JSON.stringify(mini));
            if (!mini || !mini.eventId) { logFn("optimisticAddEvent", "no mini/eventId"); return; }
            const exists = STATE.events.some(e => e.eventId === mini.eventId);
            if (exists) { logFn("optimisticAddEvent", "exists, select"); selectEvent(mini.eventId); return; }

            const item = {
                eventId: mini.eventId, sid: mini.sid || '', slug: mini.slug || '',
                name: mini.name || '', type: mini.type || '', status: mini.status || '',
                startDate: mini.startDate || '', endDate: mini.endDate || '',
                flow: mini.flow || '', weeks: mini.weeks || '',
                elimType: mini.elimType || '', seedMode: mini.seedMode || '',
                isDefault: false,
                publicUrl: mini.publicUrl || '', displayUrl: mini.displayUrl || '',
                adminUrl: mini.adminUrl || '', formUrl: mini.formUrl || '',
                signupSheet: mini.signupSheet || '', scheduleSheet: mini.scheduleSheet || '',
                bracketSheet: mini.bracketSheet || '', counts: { signups: 0 }
            };
            STATE.events.push(item);
            logFn("optimisticAddEvent", "pushed ‚Üí " + item.eventId);

            const sel = document.getElementById('chooseEvent');
            const tip = document.getElementById('emptyTip');
            if (sel) {
                if (tip) tip.style.display = 'none';
                sel.disabled = false;
                const o = document.createElement('option');
                const rawName = (item.name && item.name.trim()) ? item.name.trim() : '';
                const label = rawName || item.slug || item.sid || "(untitled event)"
                const dateStr = item.startDate || '';
                o.value = item.eventId;
                o.textContent = `${label}${dateStr ? ' (' + dateStr + ')' : ''}`;
                o.title = `${label}${dateStr ? ' ‚Ä¢ ' + dateStr : ''}`;
                sel.appendChild(o);
                sel.value = item.eventId;
            }
            setCurrent(item.eventId, true);
        }

        /* ---------- Sticky CTA ---------- */
        function updateStickyCta() {
            logFn("updateStickyCta", "entry");
            const bar = document.getElementById('stickyCta');
            if (!bar) { logFn("updateStickyCta", "no bar"); return; }
            const e = STATE.current, has = !!e;
            bar.classList.toggle('hidden', !has);
            if (!has) { logFn("updateStickyCta", "hidden (no current)"); return; }

            const bTV = document.getElementById('ctaOpenTV');
            const bForm = document.getElementById('ctaForm');
            const bSched = document.getElementById('ctaSchedule');
            const bBrkt = document.getElementById('ctaBracket');
            const row2 = document.getElementById('ctaRow2');

            if (bTV) bTV.onclick = () => { logFn("ctaOpenTV", "click"); document.getElementById('aOpenTV')?.click(); };

            const hasForm = !!(e.formUrl && String(e.formUrl).trim());
            if (bForm) {
                bForm.textContent = hasForm ? 'Open Form' : 'Create Form';
                bForm.classList.toggle('btn--primary', !hasForm);
                bForm.classList.toggle('btn--ghost', hasForm);
                bForm.onclick = () => {
                    logFn("ctaForm", "click");
                    hasForm ? window.open(e.formUrl, '_blank') : document.getElementById('btnCreateForm')?.click();
                };
            }

            const flow = e.flow;
            const showSched = flow === 'SEASON_ONLY' || flow === 'SEASON_TOURNEY';
            const showBrkt = flow === 'SEASON_TOURNEY' || flow === 'TOURNEY_ONLY';
            if (row2) row2.style.display = (showSched || showBrkt) ? '' : 'none';
            if (bSched) { bSched.style.display = showSched ? '' : 'none'; bSched.onclick = () => { logFn("ctaSchedule", "click"); document.getElementById('btnGenSchedule')?.click(); }; }
            if (bBrkt) { bBrkt.style.display = showBrkt ? '' : 'none'; bBrkt.onclick = () => { logFn("ctaBracket", "click"); document.getElementById('btnGenBrackets')?.click(); }; }
        }

        /* Hide CTA on mobile keyboard */
        (function watchViewport() {
            logFn("watchViewport", "init");
            if (!window.visualViewport) return;
            const baseH = window.visualViewport.height;
            window.visualViewport.addEventListener('resize', () => {
                const bar = document.getElementById('stickyCta'); if (!bar) return;
                const shrink = baseH - window.visualViewport.height;
                bar.classList.toggle('hidden', shrink > 120);
                logFn("watchViewport", "resize ‚Üí shrink " + shrink);
            });
        })();

        /* ---------- Create flow ---------- */
        async function createEventSmart(payload) {
            logFn("createEventSmart", "entry");
            try {
                return await gs('createEventVerified', payload);
            } catch (e) {
                const msg = (e && e.message) ? String(e.message) : String(e);
                if (/createEventVerified/i.test(msg) || /not found/i.test(msg) || /is not a function/i.test(msg)) {
                    console.warn('createEventVerified not available, falling back:', msg);
                    logFn("createEventSmart", "fallback to createEvent");
                    return await gs('createEvent', payload);
                }
                logFn("createEventSmart", "rethrow " + msg);
                throw e;
            }
        }
        function weeksRequiredFor(flow) { const r = (flow === 'SEASON_TOURNEY' || flow === 'SEASON_ONLY'); logFn("weeksRequiredFor", flow + " ‚Üí " + r); return r; }
        function syncWeeksVisibility() {
            logFn("syncWeeksVisibility", "entry");
            const show = weeksRequiredFor($('#evFlow').value);
            const weeks = $('#evWeeks');
            weeks.style.display = show ? '' : 'none';
            if (show) weeks.setAttribute('required', 'required');
            else { weeks.removeAttribute('required'); weeks.value = ''; }
        }

        /* ---------- Diagnostics table renderer ---------- */
        function renderDiagTable(report) {
            logFn("renderDiagTable", "entry");
            const tb = document.querySelector('#diagTable tbody'); tb.innerHTML = '';
            if (!report) { logFn("renderDiagTable", "no report"); return; }
            if (Array.isArray(report.results)) {
                for (const r of report.results) {
                    const tr = document.createElement('tr');
                    const td1 = document.createElement('td'); td1.textContent = r.name || '(suite)';
                    const td2 = document.createElement('td'); td2.textContent = r.ok ? 'PASS' : 'FAIL';
                    td2.style.fontWeight = '800'; td2.style.color = r.ok ? 'var(--ok)' : 'var(--danger)';
                    const td3 = document.createElement('td'); td3.textContent = JSON.stringify(r.meta || {});
                    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
                    tb.appendChild(tr);
                }
            } else {
                const tr = document.createElement('tr');
                const td1 = document.createElement('td'); td1.textContent = 'status';
                const td2 = document.createElement('td'); td2.textContent = report.ok ? 'OK' : 'ERR';
                const td3 = document.createElement('td'); td3.textContent = JSON.stringify(report);
                tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
                tb.appendChild(tr);
            }
        }

        /* ---------- Button handlers ---------- */
        async function onCreateClick() {
            logFn("onCreateClick", "entry");

            const flowVal = $('#evFlow').value;
            const needWeeks = flowVal === 'SEASON_TOURNEY' || flowVal === 'SEASON_ONLY';

            if (!$('#evName').checkValidity() || !$('#evDate').checkValidity() || (needWeeks && !$('#evWeeks').checkValidity())) {
                logFn("onCreateClick", "invalid inputs");
                $('#evName').reportValidity(); $('#evDate').reportValidity(); $('#evWeeks').reportValidity(); return;
            }
            const payload = {
                name: $('#evName').value.trim(),
                startDate: $('#evDate').value,
                flow: flowVal,
                weeks: needWeeks ? Number($('#evWeeks').value || 0) : 0,
                elimType: $('#evElim').value,
                seedMode: $('#evSeed').value
            };
            logFn("onCreateClick", "payload " + JSON.stringify(payload));

            const btn = $('#btnCreate');
            btn.disabled = true; setBusy(true, 'Creating event‚Ä¶'); toast('Creating event‚Ä¶');
            try {
                const created = await createEventSmart(payload);
                logFn("onCreateClick", "created " + JSON.stringify(created));
                optimisticAddEvent(created);
                toast('Event created. View Manage Events dropdown!');
                await reloadEventsEnsure(created.eventId, { tries: 6, baseDelay: 300 });
                if (refreshShareLinks.flush) { logFn("onCreateClick", "flush share links"); refreshShareLinks.flush(); }
                gs('refreshPublicCache', created.eventId);
                // reset
                $('#evName').value = ''; $('#evDate').value = ''; $('#evWeeks').value = '';
                $('#evElim').value = 'SINGLE'; $('#evSeed').value = 'RANDOM'; $('#evFlow').value = payload.flow;
                syncWeeksVisibility();
                document.getElementById('manageTitle')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (err) {
                logFn("onCreateClick", "catch " + (err && err.message || err));
                console.error('Create failed:', err);
                toast((err && err.message) || 'Create failed', false);
            } finally {
                btn.disabled = false; setBusy(false);
                logFn("onCreateClick", "finally exit");
            }
        }

        async function runSelectedSuite() {
            logFn("runSelectedSuite", "entry");
            setBusy(true, 'Running‚Ä¶');
            try {
                const sel = document.getElementById('diagSuite').value;
                let rep = null;
                if (sel === 'quick') rep = await gs('runQuickChecks');
                else if (sel === 'full') rep = await gs('runQaSuite');
                else if (sel === 'create') rep = await gs('runTestsCreateCard');
                else if (sel === 'manage') rep = await gs('runTestsManageCard');
                else if (sel === 'signups') rep = await gs('runTestsSignupsCard');
                else if (sel === 'share') rep = await gs('runTestsShareCard');
                else if (sel === 'schedule') rep = await gs('runTestsScheduleCard');
                else if (sel === 'brackets') rep = await gs('runTestsBracketsCard');
                else if (sel === 'allcards') rep = await gs('runAllCardTests');
                renderDiagTable(rep); window.__lastDiagReport = rep;
                toast(rep.ok ? 'Suite PASS' : 'Suite ATTENTION', rep.ok);
            } catch (e) { logFn("runSelectedSuite", "catch " + (e?.message || e)); console.error(e); toast('Suite failed', false); }
            finally { setBusy(false); logFn("runSelectedSuite", "finally exit"); }
        }

        async function runSelfHealUI() {
            logFn("runSelfHealUI", "entry");
            setBusy(true, 'Self-healing‚Ä¶');
            try {
                const rep = await gs('selfHeal');
                renderDiagTable(rep); window.__lastDiagReport = rep;
                toast(rep.ok ? 'Self-heal: OK' : 'Self-heal: ATTENTION', rep.ok);
                await loadEvents(STATE.current?.eventId);
                if (STATE.current && refreshShareLinks.flush) { logFn("runSelfHealUI", "flush share links"); refreshShareLinks.flush(); }
            } catch (e) { logFn("runSelfHealUI", "catch " + (e?.message || e)); console.error(e); toast('Self-heal failed', false); }
            finally { setBusy(false); logFn("runSelfHealUI", "finally exit"); }
        }

        async function runHardResetUI() {
            logFn("runHardResetUI", "entry");
            if (!confirm('This will back up the current Events sheet and create a fresh one.\nProceed?')) { logFn("runHardResetUI", "cancel"); return; }
            setBusy(true, 'Hard reset‚Ä¶');
            try {
                const rep = await gs('hardResetEventsSheet');
                renderDiagTable(rep); window.__lastDiagReport = rep;
                toast('Events sheet reset', true);
                await loadEvents();
            } catch (e) { logFn("runHardResetUI", "catch " + (e?.message || e)); console.error(e); toast('Hard reset failed', false); }
            finally { setBusy(false); logFn("runHardResetUI", "finally exit"); }
        }

        async function showStatusUI() {
            logFn("showStatusUI", "entry");
            setBusy(true, 'Status‚Ä¶');
            try { const s = await gs('getStatus'); renderDiagTable(s); window.__lastDiagReport = s; }
            catch (e) { logFn("showStatusUI", "catch " + (e?.message || e)); console.error(e); toast('Status failed', false); }
            finally { setBusy(false); logFn("showStatusUI", "finally exit"); }
        }

        async function showLogsUI() {
            logFn("showLogsUI", "entry");
            setBusy(true, 'Logs‚Ä¶');
            try {
                const rows = await gs('getLogs', 100);
                const tb = document.querySelector('#diagTable tbody'); tb.innerHTML = '';
                for (const r of rows) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.ts}</td><td>${r.level}</td><td>${r.msg}</td><td>${typeof r.json === 'object' ? JSON.stringify(r.json) : r.json || ''}</td>`;
                    tb.appendChild(tr);
                }
                window.__lastDiagReport = rows;
            } catch (e) { logFn("showLogsUI", "catch " + (e?.message || e)); console.error(e); toast('Logs failed', false); }
            finally { setBusy(false); logFn("showLogsUI", "finally exit"); }
        }

        function copyReportUI() {
            logFn("copyReportUI", "entry");
            const data = window.__lastDiagReport || { info: 'No report yet' };
            const txt = JSON.stringify(data, null, 2);
            copyText(txt).then(ok => { logFn("copyReportUI", "copied? " + ok); toast(ok ? 'Report copied' : 'Copy failed', ok); });
        }

        /* ---------- Global event wiring (ONE place) ---------- */
        document.addEventListener('DOMContentLoaded', () => {
            logFn("DOMContentLoaded", "bind handlers");
            // helper
            const on = (id, type, fn) => {
                const el = document.getElementById(id);
                if (!el) { console.warn(`[bind] missing #${id}`); logFn("bind", "missing #" + id); return; }
                el.addEventListener(type, fn);
                logFn("bind", "ok #" + id + " ‚Üí " + type);
            };

            // initial state + visibility
            syncWeeksVisibility();
            loadEvents().then(() => { logFn("DOMContentLoaded", "loadEvents ready"); });

            // Create card
            on('btnCreate', 'click', onCreateClick);
            // FIX: Toggle the actual popover element, not the button
            on('btnFlowHelp', 'click', () => { logFn("btnFlowHelp", "toggle popover"); document.getElementById('popFlowHelp')?.togglePopover?.(); });
            // Live weeks visibility when Flow changes
            on('evFlow', 'change', syncWeeksVisibility);

            // Manage card
            on('chooseEvent', 'change', (ev) => { logFn("chooseEvent", "change " + ev.currentTarget.value); setCurrent(ev.currentTarget.value); });
            on('btnRefreshEvents', 'click', async (e) => {
                logFn("btnRefreshEvents", "click");
                const btn = e.currentTarget; if (STATE.loading) { logFn("btnRefreshEvents", "loading ‚Üí bail"); return; }
                btn.disabled = true;
                try { await loadEvents(STATE.current?.eventId); }
                catch (err) { console.error(err); toast(err?.message || 'Refresh failed', false); }
                finally { btn.disabled = false; }
            });
            on('btnSetDefault', 'click', async () => {
                logFn("btnSetDefault", "click");
                if (!STATE.current) return;
                setBusy(true, 'Setting default‚Ä¶');
                try { await gs('setDefaultEvent', STATE.current.eventId, true); toast('Default updated'); await loadEvents(STATE.current.eventId); }
                catch (err) { toast(err?.message || 'Failed to set default', false); }
                finally { setBusy(false); }
            });
            on('btnOpenPublic', 'click', () => {
                logFn("btnOpenPublic", "click");
                if (!STATE.current) return;
                setBusy(true, 'Opening‚Ä¶');
                gs('getShareLinks', STATE.current.eventId)
                    .then(links => { const url = links && links.publicUrl; if (url) window.open(url, '_blank'); else toast('No public link yet', false); })
                    .catch(() => toast('Failed to open public page', false))
                    .finally(() => setBusy(false));
            });
            on('btnOpenSheets', 'click', () => {
                logFn("btnOpenSheets", "click");
                if (!STATE.current) return;
                setBusy(true, 'Opening Sheets‚Ä¶');
                gs('openSheetUrl', STATE.current.eventId)
                    .then(url => { if (url) window.open(url, '_blank'); else toast('Sheet not found', false); })
                    .catch(err => toast(err?.message || 'Open Sheets failed', false))
                    .finally(() => setBusy(false));
            });

            // Signups
            on('btnCreateForm', 'click', async () => {
                logFn("btnCreateForm", "click");
                if (!STATE.current) return;
                const opts = { email: $('#optEmail').checked, phone: $('#optPhone').checked, notes: $('#optNotes').checked };
                setBusy(true, 'Creating form‚Ä¶');
                try {
                    await gs('buildSignupForm', STATE.current.eventId, opts);
                    toast('Signup form ready'); await loadEvents(STATE.current.eventId);
                    refreshShareLinks.flush?.(); updateStickyCta();
                } catch (err) { toast(err?.message || 'Form creation failed', false); }
                finally { setBusy(false); }
            });
            on('btnAddSeedCol', 'click', async () => {
                logFn("btnAddSeedCol", "click");
                if (!STATE.current) return;
                setBusy(true, 'Ensuring seed column‚Ä¶');
                try { await gs('ensureSeedColumn', STATE.current.eventId); toast('Seed column ensured'); }
                catch (err) { toast(err?.message || 'Failed to add Seed column', false); }
                finally { setBusy(false); }
            });

            // Schedule
            on('btnGenSchedule', 'click', async () => {
                logFn("btnGenSchedule", "click");
                if (!STATE.current) return;
                const w = Number($('#weeksEdit').value || STATE.current.weeks || 0);
                if (!w) { toast('Pick number of weeks', false); return; }
                setBusy(true, 'Generating schedule‚Ä¶');
                try { await gs('generateSchedule', STATE.current.eventId, w); toast('Schedule scaffold generated'); gs('refreshPublicCache', STATE.current.eventId); }
                catch (err) { toast(err?.message || 'Failed to generate schedule', false); }
                finally { setBusy(false); }
            });

            // Brackets
            on('elimTypeEdit', 'change', () => { logFn("elimTypeEdit", "change"); $('#brktStatus').textContent = ''; });
            on('seedModeEdit', 'change', () => { logFn("seedModeEdit", "change"); $('#brktStatus').textContent = ''; });
            on('btnGenBrackets', 'click', async () => {
                logFn("btnGenBrackets", "click");
                if (!STATE.current) return;
                const opts = { elimType: $('#elimTypeEdit').value, seedMode: $('#seedModeEdit').value };
                setBusy(true, 'Generating bracket‚Ä¶');
                try {
                    const res = await gs('generateBrackets', STATE.current.eventId, opts);
                    if (res && res.ok) {
                        toast('Bracket generated'); $('#brktStatus').textContent = `Mode: ${opts.elimType} ¬∑ Seeding: ${opts.seedMode}`;
                        gs('refreshPublicCache', STATE.current.eventId);
                    } else if (res && res.reason === 'missing_seeds') {
                        if (confirm('Seeds are missing. Open Sheets to add 1..N seeds? (Cancel to generate Random)')) {
                            $('#btnOpenSheets').click();
                        } else {
                            const r2 = await gs('generateBrackets', STATE.current.eventId, { elimType: opts.elimType, seedMode: 'RANDOM' });
                            if (r2 && r2.ok) {
                                toast('Bracket generated (Random)');
                                $('#seedModeEdit').value = 'RANDOM';
                                $('#brktStatus').textContent = `Mode: ${opts.elimType} ¬∑ Seeding: RANDOM`;
                                gs('refreshPublicCache', STATE.current.eventId);
                            } else {
                                toast('Failed to generate bracket', false);
                            }
                        }
                    } else {
                        toast('Failed to generate bracket', false);
                    }
                } catch (err) { toast(err?.message || 'Bracket generation failed', false); }
                finally { setBusy(false); }
            });
            on('btnRefreshView', 'click', () => {
                logFn("btnRefreshView", "click");
                if (!STATE.current) return;
                setBusy(true, 'Refreshing‚Ä¶');
                gs('refreshPublicCache', STATE.current.eventId)
                    .then(() => toast('Public cache refreshed'))
                    .catch(() => toast('Refresh failed', false))
                    .finally(() => setBusy(false));
            });

            // Diagnostics
            on('btnRunSuite', 'click', runSelectedSuite);
            on('btnSelfHeal', 'click', runSelfHealUI);
            on('btnHardReset', 'click', runHardResetUI);
            on('btnShowStatus', 'click', showStatusUI);
            on('btnShowLogs', 'click', showLogsUI);
            on('btnCopyReport', 'click', copyReportUI);

            // Keep signup count fresh
            setInterval(() => {
                logFn("signupCountInterval", "tick");
                if (!STATE.current) return;
                gs('getSignupCount', STATE.current.eventId)
                    .then(n => { if (typeof n === 'number') $('#signupCountTile').textContent = n; })
                    .catch(() => { /* ignore */ });
            }, 15000);
        });
    </script>
</body>

</html>
