<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> · Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <?!= include('Styles'); ?>
  <style>
    :root { --gap:12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 14px; }
    header h1 { margin: 0 0 2px; }
    small#build { color:#666 }
    .row { display:flex; gap: var(--gap); flex-wrap: wrap; align-items: flex-end; }
    .card { border:1px solid #ddd; border-radius:10px; padding:14px; margin:10px 0; background:#fff; }
    .muted { color:#666; }
    label { display:block; font-size:.9rem; margin:.2rem 0; }
    input, select, button { font-size:1rem; padding:.55rem .7rem; }
    button { cursor:pointer; }
    .links a { margin-right:10px; }
    .qrwrap{ display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .toast { position:fixed; right:10px; bottom:10px; background:#222; color:#fff; padding:10px 12px; border-radius:8px; display:none; z-index:9999; }
    .toast.show{ display:block; }
    pre.json { background:#f7f7f7; border:1px solid #e3e3e3; border-radius:8px; padding:10px; max-height:320px; overflow:auto; }
  </style>
</head>
<body>
  <main>
    <!-- =======================================================
         0) HEADER
    ======================================================== -->
    <header>
      <h1 data-testid="admin-title">NextUp Admin</h1>
      <small id="build">BUILD: <?= BUILD_ID ?></small>
    </header>

    <!-- =======================================================
         1) CREATE EVENTBOOK
    ======================================================== -->
    <section class="card" aria-label="Create Eventbook">
      <h3>Create Eventbook</h3>
      <div class="row">
        <div>
          <label for="evName">Name</label>
          <input id="evName" data-testid="ev-name" placeholder="e.g., Southside Bocce Weeklies"/>
        </div>
        <div>
          <label for="evDate">Start Date (ISO)</label>
          <input id="evDate" data-testid="ev-date" type="date"/>
        </div>
        <div>
          <label for="seedMode">Seeding</label>
          <select id="seedMode" data-testid="ev-seedmode">
            <option value="random">Random</option>
            <option value="seeded">Seeded</option>
          </select>
        </div>
        <div>
          <label for="elimType">Elimination</label>
          <select id="elimType" data-testid="ev-elimtype">
            <option value="single">Single</option>
            <option value="double">Double</option>
          </select>
        </div>
        <div>
          <button id="btnCreate" data-testid="btn-create">Create</button>
        </div>
      </div>
      <small class="muted">Idempotent on <em>slug + start date</em>.</small>
    </section>

    <!-- =======================================================
         2) MANAGE EVENTBOOKS
    ======================================================== -->
    <section class="card" aria-label="Manage Eventbooks">
      <h3>Manage Eventbooks</h3>
      <div class="row">
        <div style="min-width:280px">
          <label for="chooseEvent">Choose</label>
          <select id="chooseEvent" data-testid="select-event">
            <option value="">No events yet — create above</option>
          </select>
        </div>
        <div>
          <button id="btnMakeDefault" data-testid="btn-make-default" disabled>Make Default</button>
          <button id="btnArchive" data-testid="btn-archive" disabled>Archive</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="links">
          <a id="openPublic"  data-testid="link-public"  target="_blank" rel="noopener">Open Public</a>
          <a id="openDisplay" data-testid="link-display" target="_blank" rel="noopener">Open TV</a>
          <a id="openPoster"  data-testid="link-poster"  target="_blank" rel="noopener">Open Poster</a>
          <button id="btnCopyLinks" data-testid="btn-copy-links" disabled>Copy Links</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnConfigureForm" data-testid="btn-configure-form" disabled>Configure Signup Form</button>
      </div>

      <div class="qrwrap" style="margin-top:14px">
        <div><strong>Public QR</strong> <small class="muted">(shown only when verified)</small></div>
        <img id="qrImg" data-testid="img-qr" alt="QR" width="110" height="110" style="display:none;border:1px solid #ddd;border-radius:6px;"/>
        <a id="qrLink" data-testid="link-qr" target="_blank" rel="noopener"></a>
      </div>
    </section>

    <!-- =======================================================
         3) DIAGNOSTICS
    ======================================================== -->
    <section class="card" aria-label="Diagnostics">
      <h3>Diagnostics</h3>
      <div class="row">
        <button id="btnSmoke" data-testid="btn-smoke">Run Smoke</button>
        <button id="btnViewLogs" data-testid="btn-view-logs">View Logs</button>
        <button id="btnClearLogs" data-testid="btn-clear-logs">Clear Logs</button>
      </div>
      <div style="margin-top:10px">
        <pre id="diagOut" class="json" role="status" aria-live="polite" data-testid="diag-output">{}</pre>
      </div>
    </section>

    <div id="toast" class="toast" aria-live="polite" data-testid="toast"></div>
  </main>

  <script>
/* =======================================================
 * A) TOASTS (UI feedback)
 * ======================================================= */
const TOAST = {
  show(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2300); },
  info(msg){ this.show(msg); console.log('[INFO]', msg); },
  error(msg){ this.show(msg); console.error('[ERR]', msg); }
};

/* =======================================================
 * B) STATE & DOM REFS
 * ======================================================= */
const STATE = { etag:null, events:[], selected:null, links:null, optimisticId:null };

const DOM = {
  evName:         ()=>document.getElementById('evName'),
  evDate:         ()=>document.getElementById('evDate'),
  seedMode:       ()=>document.getElementById('seedMode'),
  elimType:       ()=>document.getElementById('elimType'),
  btnCreate:      ()=>document.getElementById('btnCreate'),
  chooseEvent:    ()=>document.getElementById('chooseEvent'),
  btnMakeDefault: ()=>document.getElementById('btnMakeDefault'),
  btnArchive:     ()=>document.getElementById('btnArchive'),
  btnCopyLinks:   ()=>document.getElementById('btnCopyLinks'),
  btnConfigureForm:()=>document.getElementById('btnConfigureForm'),
  openPublic:     ()=>document.getElementById('openPublic'),
  openDisplay:    ()=>document.getElementById('openDisplay'),
  openPoster:     ()=>document.getElementById('openPoster'),
  qrImg:          ()=>document.getElementById('qrImg'),
  qrLink:         ()=>document.getElementById('qrLink'),
  diagOut:        ()=>document.getElementById('diagOut')
};

/* =======================================================
 * C) RPC WRAPPER (defensive)
 * ======================================================= */
function rpc(fn, ...args){
  return new Promise((res, rej)=>{
    if(!window.google || !google.script || !google.script.run){
      const msg='google.script.run unavailable — open the deployed Web App URL';
      TOAST.error(msg); return rej(new Error(msg));
    }
    google.script.run
      .withSuccessHandler(res)
      .withFailureHandler(e=>rej(new Error(e?.message||String(e))))
      [fn](...args);
  });
}

/* =======================================================
 * D) BOOTSTRAP & WIRING
 * ======================================================= */
window.addEventListener('DOMContentLoaded', async () => {
  wireHandlers();
  await bootstrap();           // ensure Template + Control (self-heal)
  await swrEventsOnce();       // populate dropdown
});

function wireHandlers(){
  DOM.btnCreate().addEventListener('click', onCreate);
  DOM.chooseEvent().addEventListener('change', onChoose);
  DOM.btnMakeDefault().addEventListener('click', onMakeDefault);
  DOM.btnArchive().addEventListener('click', onArchive);
  DOM.btnCopyLinks().addEventListener('click', onCopyLinks);
  DOM.btnConfigureForm().addEventListener('click', onConfigureForm);

  document.getElementById('btnSmoke').addEventListener('click', onSmoke);
  document.getElementById('btnViewLogs').addEventListener('click', onViewLogs);
  document.getElementById('btnClearLogs').addEventListener('click', onClearLogs);
}

async function bootstrap(){
  try {
    // Prefer new bootstrap; fallback to ping() if not present
    if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.bootstrapControlAndTemplate) {
      await rpc('bootstrapControlAndTemplate');
    } else if (google?.script?.run?.ping) {
      await rpc('ping');
    }
  } catch (e) {
    TOAST.error('Bootstrap failed: ' + (e.message || e));
  }
}

/* =======================================================
 * E) EVENTS LIST (dropdown)
 * ======================================================= */
// Retry-once SWR to avoid rare null hiccups
async function swrEventsOnce(_retried){
  try {
    // Prefer newer listEvents(); fallback to legacy getEventsSafe(etag)
    let res;
    if (google?.script?.run?.listEvents) {
      res = await rpc('listEvents');
      if (!res || res.ok === false) throw new Error('listEvents failed');
      STATE.events = Array.isArray(res.events) ? res.events : [];
      STATE.etag = null;
    } else {
      res = await rpc('getEventsSafe', STATE.etag);
      if (!res || typeof res !== 'object') {
        if (!_retried) return swrEventsOnce(true);
        throw new Error('invalid response');
      }
      if (res.ok === false) throw new Error('events error');
      if (res.notModified) return;
      STATE.events = Array.isArray(res.items) ? res.items : [];
      STATE.etag   = res.etag || null;
    }
    paintDropdown(STATE.events);
  } catch (err) {
    TOAST.error('Events load failed'); console.error(err);
  }
}

function paintDropdown(items){
  const sel = DOM.chooseEvent();
  const keep = STATE.optimisticId || sel.value;
  sel.innerHTML = '';
  if (!items.length){
    sel.innerHTML = '<option value="">No events yet — create above</option>';
    setManageDisabled(true); clearLinks(); clearQr(); STATE.optimisticId=null; return;
  }
  for (const ev of items){
    const label = (ev.name && String(ev.name).trim()) || ev.slug || ev.id || '(unnamed)';
    const txt = label + (ev.startDateISO ? ` (${ev.startDateISO})` : '') + (ev.isDefault ? ' ★' : '');
    const opt = document.createElement('option');
    opt.value = ev.id; opt.textContent = txt;
    sel.appendChild(opt);
  }
  if ([...sel.options].some(o => o.value === keep)) sel.value = keep;
  sel.value = sel.value || items[0].id;
  STATE.selected = sel.value;
  STATE.optimisticId = null;
  setManageDisabled(false);
  hydrateLinksAndQr();
}

/* =======================================================
 * F) CREATE EVENTBOOK
 * ======================================================= */
async function onCreate(){
  const payload = {
    name: DOM.evName().value.trim(),
    startDateISO: DOM.evDate().value || '',
    seedMode: DOM.seedMode().value,
    elimType: DOM.elimType().value
  };
  if (!payload.name){ TOAST.error('Name is required'); return; }

  TOAST.info('Creating…');
  try {
    // Prefer newer createEventFromControl; fallback to createEventbook
    let res;
    if (google?.script?.run?.createEventFromControl) {
      const id = Utilities?.getUuid ? Utilities.getUuid() : ('ev_' + Date.now()); // harmless; will be ignored server-side if not expected
      res = await rpc('createEventFromControl', {
        id,
        name: payload.name,
        slug: payload.name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''),
        dateISO: payload.startDateISO,
        includeSignup: true
      });
      if (!res || res.ok === false) throw new Error('createEventFromControl failed');
      STATE.optimisticId = res.eventId || res.id || null;
    } else {
      res = await rpc('createEventbook', payload);
      if (!res || res.ok === false) throw new Error('createEventbook failed');
      STATE.optimisticId = res.id || null;
    }

    TOAST.info(res.idempotent ? 'Already existed — selected existing.' : 'Created!');
    DOM.evName().value = ''; DOM.evDate().value = '';
    STATE.etag = null;
    await swrEventsOnce();
  } catch (err) {
    TOAST.error('Create failed'); console.error(err);
  }
}

/* =======================================================
 * G) MANAGE ACTIONS (select, default, archive, form)
 * ======================================================= */
function onChoose(){
  const sel = DOM.chooseEvent();
  STATE.selected = sel.value || null;
  setManageDisabled(!STATE.selected);
  hydrateLinksAndQr();
}

async function onMakeDefault(){
  if (!STATE.selected) return;
  try {
    await rpc('setDefaultEvent', STATE.selected);
    TOAST.info('Default set');
    STATE.etag=null; await swrEventsOnce();
  } catch (err) { TOAST.error('Failed'); console.error(err); }
}

async function onArchive(){
  if (!STATE.selected) return;
  if (!confirm('Archive this eventbook?')) return;
  try {
    await rpc('archiveEvent', STATE.selected);
    TOAST.info('Archived');
    STATE.etag=null; await swrEventsOnce();
  } catch (err) { TOAST.error('Failed'); console.error(err); }
}

async function onConfigureForm(){
  if (!STATE.selected) return;
  TOAST.info('Configuring form…');
  try {
    const res = await rpc('configureSignupForm', STATE.selected);
    if (!res || res.ok === false){ TOAST.error('Form setup failed'); return; }
    TOAST.info(res.idempotent ? 'Form already linked' : 'Form created');
    if (res.formUrl) window.open(res.formUrl, '_blank');
  } catch (err) { TOAST.error('Form setup failed'); console.error(err); }
}

/* =======================================================
 * H) LINKS & QR (strict invariant: only show QR when verified)
 * ======================================================= */
async function hydrateLinksAndQr(){
  if (!STATE.selected){ clearLinks(); clearQr(); return; }
  try {
    // Prefer newer quicklinks; fallback to legacy getShareLinks
    let res;
    if (google?.script?.run?.getEventQuickLinks) {
      res = await rpc('getEventQuickLinks', STATE.selected);
      if (!res || res.ok === false) throw new Error('quicklinks failed');
      DOM.openPublic().href  = res.publicUrl || '';
      DOM.openDisplay().href = res.displayUrl || '';
      DOM.openPoster().href  = res.posterUrl  || '';
      DOM.btnCopyLinks().disabled = !(res.publicUrl || res.displayUrl || res.posterUrl);
    } else {
      res = await rpc('getShareLinks', STATE.selected);
      if (!res || res.ok === false) throw new Error('sharelinks failed');
      STATE.links = res;
      DOM.openPublic().href  = res.publicUrl || '';
      DOM.openDisplay().href = res.displayUrl || '';
      DOM.openPoster().href  = res.posterUrl  || '';
      DOM.btnCopyLinks().disabled = false;
    }

    // Strict QR rule: show only when verified
    if (google?.script?.run?.getShareQr && google?.script?.run?.verifyEventSafe) {
      const v = await rpc('verifyEventSafe', STATE.selected);
      if (!v || v.ok === false || !v.verified) { clearQr(); return; }
      const q = await rpc('getShareQr', STATE.selected);
      if (!q || q.ok === false || !q.qrUrl){ clearQr(); return; }
      DOM.qrImg().src = q.qrUrl; DOM.qrImg().style.display = '';
      DOM.qrLink().href = q.qrUrl; DOM.qrLink().textContent = 'Open QR';
    } else {
      // If those endpoints don’t exist, keep invariant: no QR
      clearQr();
    }
  } catch (err) {
    console.error(err); clearLinks(); clearQr();
  }
}

/* =======================================================
 * I) DIAGNOSTICS (smoke, logs)
 * ======================================================= */
async function onSmoke(){
  DOM.diagOut().textContent = 'Running…';
  try {
    const res = await rpc('runSmokeSafe', { form:false });
    DOM.diagOut().textContent = JSON.stringify(res, null, 2);
    TOAST[res && res.ok ? 'info' : 'error'](res && res.ok ? 'Smoke OK' : 'Smoke failed');
    STATE.etag = null; await swrEventsOnce();
  } catch (err) {
    DOM.diagOut().textContent = String(err);
    TOAST.error('Smoke failed — see console'); console.error(err);
  }
}

async function onViewLogs(){
  DOM.diagOut().textContent = 'Loading logs…';
  try {
    const res = await rpc('getLogs', 300);
    if (!res || res.ok === false){ TOAST.error('Log fetch error'); return; }
    DOM.diagOut().textContent = JSON.stringify(res.items || [], null, 2);
  } catch (err) { TOAST.error('Log fetch failed'); console.error(err); }
}

async function onClearLogs(){
  if (!confirm('Clear logs?')) return;
  try {
    await rpc('clearLogs');
    TOAST.info('Logs cleared'); onViewLogs();
  } catch (err) { TOAST.error('Clear failed'); console.error(err); }
}

/* =======================================================
 * J) UTILITIES (enable/disable, clear)
 * ======================================================= */
function setManageDisabled(disabled){
  DOM.btnMakeDefault().disabled = disabled;
  DOM.btnArchive().disabled = disabled;
  DOM.btnCopyLinks().disabled = disabled;
  DOM.btnConfigureForm().disabled = disabled;
}
function clearLinks(){
  DOM.openPublic().removeAttribute('href');
  DOM.openDisplay().removeAttribute('href');
  DOM.openPoster().removeAttribute('href');
  DOM.btnCopyLinks().disabled = true;
}
function clearQr(){
  const img = DOM.qrImg(); img.removeAttribute('src'); img.style.display='none';
  const a = DOM.qrLink(); a.removeAttribute('href'); a.textContent='';
}
  </script>
</body>
</html>