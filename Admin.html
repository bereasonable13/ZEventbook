<!doctype html>
<html lang="en" >

<head>
    <meta charset="utf-8">
    <title>
        <?= appTitle || 'NextUp' ?>
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <style>
        :root {
            --bg: #ffffff;
            --fg: #0b1324;
            --muted: #6a7280;
            --card: #f6f8fb;
            --line: #e7edf5;
            --ok: #16a34a;
            --warn: #f59e0b;
            --err: #ef4444;
            --link: #2563eb;
            --btn: #111827;
            --btnfg: #ffffff;
        }

        html[data-theme="dark"] {
            --bg: #0b1020;
            --fg: #e6ecff;
            --muted: #9fb1d1;
            --card: #151b2e;
            --line: #263251;
            --ok: #22c55e;
            --warn: #fbbf24;
            --err: #f87171;
            --link: #93c5fd;
            --btn: #1f2937;
            --btnfg: #e6ecff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--bg);
            color: var(--fg);
        }

        a {
            color: var(--link);
            text-decoration: none;
        }

        .appbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--line);
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 10;
        }

        .title {
            font-weight: 700;
            letter-spacing: .2px;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .wrap {
            padding: 16px;
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(12, 1fr);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 14px;
            grid-column: span 12;
        }

        .card-title {
            font-weight: 700;
            margin-bottom: 8px;
        }

        @media(min-width:960px) {
            .span-6 {
                grid-column: span 6;
            }

            .span-4 {
                grid-column: span 4;
            }

            .span-8 {
                grid-column: span 8;
            }
        }

        label {
            font-size: 12px;
            color: var(--muted);
        }

        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: var(--bg);
            color: var(--fg);
            font-size: 16px;
        }

        button.btn {
            padding: 12px 14px;
            min-height: 44px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: var(--btn);
            color: var(--btnfg);
            cursor: pointer;
        }

        button.btn[disabled] {
            opacity: .5;
            cursor: not-allowed;
        }

        .btn-ghost {
            background: transparent;
            color: var(--fg);
        }

        .kpi {
            font-weight: 700;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .table th,
        .table td {
            border-top: 1px solid var(--line);
            padding: 6px 8px;
            vertical-align: top;
        }

        .muted {
            color: var(--muted);
        }

        .pill {
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(0, 0, 0, .06);
        }

        /* Toast */
        #toastHost {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 14px;
            display: flex;
            justify-content: center;
            pointer-events: none;
            z-index: 99;
        }

        .toast {
            background: var(--card);
            color: var(--fg);
            border: 1px solid var(--line);
            padding: 10px 12px;
            border-radius: 10px;
            box-shadow: 0 8px 28px rgba(0, 0, 0, .18);
            pointer-events: auto;
        }

        .toast.ok {
            border-color: var(--ok);
        }

        .toast.err {
            border-color: var(--err);
        }

        .toast.info {
            border-color: var(--warn);
        }

        /* Events Cache Badge */
        #eventsCacheBadge {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(0, 0, 0, .06);
        }

        #eventsCacheBadge .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #aaa;
        }

        #eventsCacheBadge .panel {
            position: absolute;
            top: 120%;
            right: 0;
            width: min(92vw, 420px);
            background: var(--bg);
            color: var(--fg);
            border: 1px solid var(--line);
            border-radius: 12px;
            box-shadow: 0 10px 28px rgba(0, 0, 0, .18);
            padding: 12px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(6px);
            transition: .15s ease;
            z-index: 50;
        }

        #eventsCacheBadge:hover .panel {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .grid2 {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 8px;
        }

        .mono {
            font-family: ui-monospace, Menlo, Consolas, monospace;
            word-break: break-all;
        }

        /* Status ribbons */
        .ribbon {
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, .06);
            font-size: 13px;
        }
    </style>
</head>

<body>
    <header class="appbar">
        <div class="row">
            <div class="title">NextUp ¬∑ Admin</div>
            <div id="eventsCacheBadge" aria-live="polite">
                <span class="dot" id="ecbDot" title="green=fresh, amber=304, red=error"></span>
                <span class="muted">Events Cache</span>
                <div class="panel">
                    <div class="grid2">
                        <div>ETag</div>
                        <div class="mono" id="ecbEtag">‚Äî</div>
                        <div>Last</div>
                        <div id="ecbLast">‚Äî</div>
                        <div>Age</div>
                        <div id="ecbAge">‚Äî</div>
                        <div>Last Result</div>
                        <div id="ecbKind">‚Äî</div>
                    </div>
                    <div style="margin-top:8px; border-top:1px solid var(--line); padding-top:8px" class="muted">
                        <div><b>ETag</b> is the server‚Äôs fingerprint of Events. If your ETag matches, the server may
                            return <b>304</b> and the UI keeps its list.</div>
                        <div><b>Never-blank rule</b>: after writes, if a fetch comes back empty, we keep the last good
                            list and retry with backoff.</div>
                    </div>
                    <div class="row" style="margin-top:8px; flex-wrap:wrap">
                        <button type="button" class="btn btn-ghost" id="btnForceReval">Force revalidate</button>
                        <button type="button" class="btn btn-ghost" id="btnCopyDiag">Copy diagnostics</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <button class="btn btn-ghost" id="themeToggle" aria-label="Toggle theme">üåì</button>
        </div>
    </header>

    <div class="wrap">
        <!-- Create -->
        <section class="card span-6">
            <div class="card-title">Create Event</div>
            <div class="row" style="flex-wrap:wrap">
                <div class="col" style="flex:1 1 220px; min-width:220px">
                    <label>Event Name</label>
                    <input type="text" id="inpName" placeholder="e.g., Fall Open 2025">
                </div>
                <div class="col" style="width:200px">
                    <label>Start Date</label>
                    <input type="date" id="inpDate">
                </div>
                <div class="col" style="width:160px">
                    <label>Seed Mode</label>
                    <select id="inpSeed">
                        <option value="random">random</option>
                        <option value="seeded">seeded</option>
                    </select>
                </div>
                <div class="col" style="width:160px">
                    <label>Elimination</label>
                    <select id="inpElim">
                        <option value="none">none</option>
                        <option value="single">single</option>
                        <option value="double">double</option>
                    </select>
                </div>
            </div>
            <div class="row" style="margin-top:10px">
                <button class="btn" id="btnCreateEvent">Create</button>
                <div class="ribbon" id="createStatus">Ready</div>
            </div>
        </section>

        <!-- Manage -->
        <section class="card span-6">
            <div class="card-title">Manage Event</div>
            <div class="col" style="gap:6px">
                <label>Choose</label>
                <select id="chooseEvent"></select>
            </div>
            <div class="row" style="flex-wrap:wrap; margin-top:10px">
                <button class="btn" id="btnOpenWorkbook" disabled>Open Workbook</button>
                <button class="btn" id="btnOpenAdmin" disabled>Open Admin</button>
                <button class="btn" id="btnOpenDisplay" disabled>Open Display</button>
                <button class="btn" id="btnOpenPublic" disabled>Open Public</button>
                <button class="btn" id="btnOpenPoster" disabled>Open Poster</button>
                <button class="btn btn-ghost" id="btnCopyLink" disabled>Copy Link</button>
            </div>

            <div class="card" style="margin-top:12px">
                <div class="card-title">Form</div>
                <div class="row" style="flex-wrap:wrap">
                    <input type="text" id="inpForm" placeholder="Paste Google Form URL or ID"
                        style="flex:1 1 280px; min-width:240px">
                    <button class="btn" id="btnSaveForm" disabled>Save Form</button>
                    <a id="lnkFormView" class="btn btn-ghost" target="_blank" rel="noopener" style="display:none">View
                        Form</a>
                    <a id="lnkFormEdit" class="btn btn-ghost" target="_blank" rel="noopener" style="display:none">Edit
                        Form</a>
                </div>
            </div>
        </section>

        <!-- Diagnostics -->
        <section class="card span-8">
            <div class="card-title">Diagnostics</div>
            <div class="row" style="flex-wrap:wrap; gap:8px">
                <button class="btn btn-ghost" id="dxPing">Ping</button>
                <button class="btn btn-ghost" id="dxIdentity">Identity</button>
                <button class="btn btn-ghost" id="dxProps">Props</button>
                <button class="btn btn-ghost" id="dxControl">Control</button>
                <button class="btn btn-ghost" id="dxIdx">Events Index</button>
                <button class="btn btn-ghost" id="dxEcho">Echo</button>
                <button class="btn btn-ghost" id="dxCreateArchive">Create‚ÜíArchive</button>
            </div>
            <pre id="dxOut"
                style="margin-top:10px; max-height:38vh; overflow:auto; background:var(--bg); border:1px solid var(--line); border-radius:10px; padding:10px;">‚Äî</pre>
        </section>

        <!-- Server Test Runner -->
        <section class="card span-4">
            <div class="card-title">Server Test Runner</div>
            <div class="row" style="flex-wrap:wrap; gap:8px">
                <button class="btn" id="btnRunSmoke">Run Smoke</button>
                <button class="btn" id="btnRunDaily">Run Daily</button>
                <button class="btn" id="btnRunFull">Run Full</button>
                <button class="btn btn-ghost" id="btnCopyReport">Copy JSON</button>
                <button class="btn btn-ghost" id="btnLogReport">Log to Sheet</button>
            </div>
            <div id="testSummary" class="kpi" style="margin-top:8px"></div>
            <table class="table" style="margin-top:8px">
                <thead>
                    <tr>
                        <th>Suite</th>
                        <th>Test</th>
                        <th>OK</th>
                        <th>ms</th>
                        <th>Error</th>
                    </tr>
                </thead>
                <tbody id="testTbody"></tbody>
            </table>
        </section>

        <!-- UI Tests (Client) -->
        <section class="card span-12" id="uiTestsCard">
            <div class="card-title">UI Tests (Client-Side)</div>
            <div class="row" style="flex-wrap:wrap; gap:8px">
                <button class="btn" id="btnUiSmoke">Run UI Smoke</button>
                <button class="btn" id="btnUiFull">Run UI Full</button>
                <button class="btn btn-ghost" id="btnUiCopy">Copy Report</button>
            </div>
            <div id="uiTestSummary" class="kpi" style="margin-top:8px"></div>
            <table class="table" style="margin-top:8px">
                <thead>
                    <tr>
                        <th>Test</th>
                        <th>OK</th>
                        <th>ms</th>
                        <th>Detail</th>
                    </tr>
                </thead>
                <tbody id="uiTestBody"></tbody>
            </table>
        </section>
    </div>

    <!-- Toast host -->
    <div id="toastHost" data-toast-host></div>

    <script>
        /******** Theme ********/
        (() => {
            const key = 'nu.theme';
            function apply(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem(key, t); }
            document.getElementById('themeToggle').addEventListener('click', () => {
                const cur = document.documentElement.getAttribute('data-theme') || 'light';
                apply(cur === 'light' ? 'dark' : 'light');
            });
            apply(localStorage.getItem(key) || 'light');
        })();

        /******** Toast ********/
        function toast(msg, kind) {
            const host = document.getElementById('toastHost');
            const el = document.createElement('div');
            el.className = 'toast ' + (kind || 'ok');
            el.textContent = msg;
            host.appendChild(el);
            setTimeout(() => { el.remove(); }, 2600);
        }

        /******** State + Cache badge ********/
        const STATE = { etag: null, items: [], lastFetch: 0, lastKind: 'idle', lastWriteAt: 0, loading: false, poller: null };
        function setDot(kind) { document.getElementById('ecbDot').style.background = ({ fresh: '#16a34a', notmod: '#f59e0b', error: '#ef4444', idle: '#aaa' })[kind] || '#aaa'; }
        function updBadge() {
            const age = STATE.lastFetch ? ((Date.now() - STATE.lastFetch) / 1000 | 0) + 's' : '‚Äî';
            document.getElementById('ecbEtag').textContent = STATE.etag || '‚Äî';
            document.getElementById('ecbLast').textContent = STATE.lastFetch ? new Date(STATE.lastFetch).toLocaleString() : '‚Äî';
            document.getElementById('ecbAge').textContent = age;
            document.getElementById('ecbKind').textContent = STATE.lastKind;
            setDot(STATE.lastKind === 'fresh' ? 'fresh' : STATE.lastKind === 'notmod' ? 'notmod' : STATE.lastKind === 'error' ? 'error' : 'idle');
        }

        /******** Render ********/
        function labelOf(ev) {
            const n = (ev.name || ev.slug || ev.id || '(unnamed)').toString().trim();
            const d = (ev.startDateISO || '').toString().slice(0, 10);
            return d ? `${n} (${d})` : n;
        }
        function renderEvents(items) {
            // Keep selection if possible
            const sel = document.getElementById('chooseEvent');
            const prev = sel.value;
            sel.innerHTML = '';
            items.forEach(ev => {
                const opt = document.createElement('option');
                opt.value = ev.id; opt.textContent = (ev.isDefault ? '‚òÖ ' : '') + labelOf(ev);
                opt.dataset.ssUrl = ev.eventSpreadsheetUrl || '';
                sel.appendChild(opt);
            });
            if (items.length && items.some(e => e.id === prev)) sel.value = prev;
            enableManageButtons();
        }
        function enableManageButtons() {
            const sel = document.getElementById('chooseEvent');
            const id = sel.value || '';
            const ev = STATE.items.find(e => e.id === id);
            const has = !!ev;
            const hasWB = !!(ev && ev.eventSpreadsheetUrl);
            const set = (id, on) => { const b = document.getElementById(id); if (b) b.disabled = !on; };
            set('btnOpenWorkbook', hasWB);
            set('btnOpenAdmin', has);
            set('btnOpenDisplay', has);
            set('btnOpenPublic', has);
            set('btnOpenPoster', has);
            set('btnCopyLink', has);
            set('btnSaveForm', has);
            // Form links
            if (ev && ev.formId) {
                const view = `https://docs.google.com/forms/d/${ev.formId}/viewform`;
                const edit = `https://docs.google.com/forms/d/${ev.formId}/edit`;
                const l1 = document.getElementById('lnkFormView');
                const l2 = document.getElementById('lnkFormEdit');
                l1.href = view; l1.style.display = 'inline-flex';
                l2.href = edit; l2.style.display = 'inline-flex';
            } else {
                document.getElementById('lnkFormView').style.display = 'none';
                document.getElementById('lnkFormEdit').style.display = 'none';
            }
        }

        /******** Poller (single instance) ********/
        function schedulePoll(ms) { if (STATE.poller) clearTimeout(STATE.poller); STATE.poller = setTimeout(loadEvents, ms || 0); }
        function loadEvents(options) {
            if (STATE.loading) return;
            STATE.loading = true;
            google.script.run
                .withSuccessHandler(res => {
                    STATE.loading = false;
                    if (!res || !res.ok) { STATE.lastKind = 'error'; STATE.lastFetch = Date.now(); updBadge(); return; }
                    STATE.etag = res.etag || STATE.etag;
                    STATE.lastFetch = Date.now();
                    if (res.status === 304) {
                        STATE.lastKind = 'notmod'; updBadge();
                        // Do not re-render; keep the UI; schedule next poll
                        schedulePoll(3000);
                        return;
                    }
                    const items = Array.isArray(res.items) ? res.items : [];
                    // Never-blank rule: if we recently wrote and got empty, keep old and retry
                    if (STATE.lastWriteAt && (Date.now() - STATE.lastWriteAt < 5000) && items.length === 0 && STATE.items.length) {
                        STATE.lastKind = 'notmod'; updBadge(); schedulePoll(1200); return;
                    }
                    STATE.items = items;
                    STATE.lastKind = 'fresh'; updBadge();
                    renderEvents(items);
                    schedulePoll(3000);
                })
                .withFailureHandler(err => {
                    STATE.loading = false;
                    STATE.lastKind = 'error'; STATE.lastFetch = Date.now(); updBadge();
                    console.error(err); toast('Failed to load events', 'err'); schedulePoll(2000);
                })
                .getEventsSafe(STATE.etag);
        }

        /******** Create flow ********/
        async function onCreate() {
            const btn = document.getElementById('btnCreateEvent');
            const name = document.getElementById('inpName').value.trim();
            const date = document.getElementById('inpDate').value.trim();
            const seed = document.getElementById('inpSeed').value;
            const elim = document.getElementById('inpElim').value;
            if (!name || !date) { toast('Name and Date required', 'err'); return; }
            btn.disabled = true; document.getElementById('createStatus').textContent = 'Creating‚Ä¶';
            STATE.lastWriteAt = Date.now();
            google.script.run
                .withSuccessHandler(res => {
                    btn.disabled = false;
                    if (!res || !res.ok) { toast('Create failed', 'err'); document.getElementById('createStatus').textContent = 'Failed'; return; }
                    toast('Event created', 'ok'); document.getElementById('createStatus').textContent = 'Created';
                    // Optimistic insert stub (keeps dropdown non-empty)
                    STATE.items = [{ id: res.id, name, slug: name.toLowerCase(), startDateISO: date, eventSpreadsheetUrl: '', formId: '', isDefault: false }].concat(STATE.items);
                    renderEvents(STATE.items);
                    schedulePoll(400); // reconcile soon
                })
                .withFailureHandler(err => {
                    btn.disabled = false; document.getElementById('createStatus').textContent = 'Failed';
                    console.error(err); toast('Create failed', 'err');
                })
                .createEvent({ name, startDateISO: date, seedMode: seed, elimType: elim });
        }

        /******** Quick links ********/
        function withSelectedEvent(fn) {
            const sel = document.getElementById('chooseEvent'); const id = sel.value;
            if (!id) { toast('Pick an event', 'err'); return; }
            const ev = STATE.items.find(e => e.id === id); fn(ev, id);
        }
        function openLink(which) {
            withSelectedEvent((ev) => {
                // Prefer workbook for "Open Workbook"
                if (which === 'workbook' && ev.eventSpreadsheetUrl) { window.open(ev.eventSpreadsheetUrl, '_blank'); return; }
                google.script.run
                    .withSuccessHandler(r => {
                        if (!r || !r.ok) { toast('No links', 'err'); return; }
                        const map = {
                            admin: r.adminUrl, display: r.displayUrl, public: r.publicUrl, poster: r.posterPageUrl
                        };
                        const url = which === 'admin' ? map.admin : which === 'display' ? map.display : which === 'public' ? map.public : which === 'poster' ? map.poster : ev.eventSpreadsheetUrl;
                        if (url) window.open(url, '_blank'); else toast('Link unavailable', 'err');
                    })
                    .withFailureHandler(e => { console.error(e); toast('Failed to fetch links', 'err'); })
                    .getEventQuickLinks(ev.id);
            });
        }
        function copySelectedLink() {
            withSelectedEvent((ev) => {
                google.script.run
                    .withSuccessHandler(r => {
                        const url = r?.publicUrl || '';
                        if (!url) { toast('No public link', 'err'); return; }
                        navigator.clipboard?.writeText(url).then(() => toast('Copied public link', 'ok')).catch(() => toast('Copy failed', 'err'));
                    })
                    .withFailureHandler(e => { console.error(e); toast('Failed', 'err'); })
                    .getEventQuickLinks(ev.id);
            });
        }

        /******** Form save ********/
        function saveForm() {
            const s = document.getElementById('inpForm').value.trim();
            withSelectedEvent((ev) => {
                google.script.run
                    .withSuccessHandler(r => {
                        if (r?.ok) { toast('Form saved', 'ok'); loadEvents(); }
                        else toast('Save failed', 'err');
                    })
                    .withFailureHandler(e => { console.error(e); toast('Save failed', 'err'); })
                    .setEventFormId(ev.id, s);
            });
        }

        /******** Diagnostics ********/
        (function diag() {
            const out = () => document.getElementById('dxOut');
            function show(x) { out().textContent = (typeof x === 'string') ? x : JSON.stringify(x, null, 2); }
            function bind(id, fn) {
                const el = document.getElementById(id); if (!el) return; el.addEventListener('click', () => {
                    show('Running ' + fn + ' ‚Ä¶');
                    google.script.run.withSuccessHandler(show).withFailureHandler(e => show({ ok: false, err: String(e) }))[fn]();
                });
            }
            bind('dxPing', 'dx_ping'); bind('dxIdentity', 'dx_identity'); bind('dxProps', 'dx_props'); bind('dxControl', 'dx_control'); bind('dxIdx', 'dx_events_index');
            document.getElementById('dxEcho')?.addEventListener('click', () => {
                google.script.run.withSuccessHandler(show).withFailureHandler(e => show({ ok: false, err: String(e) })).dx_echo({ client: Date.now(), rnd: Math.random().toString(36).slice(2, 7) });
            });
            document.getElementById('dxCreateArchive')?.addEventListener('click', () => {
                google.script.run.withSuccessHandler(show).withFailureHandler(e => show({ ok: false, err: String(e) })).dx_create_archive_cycle();
            });
        })();

        /******** Server Test Runner ********/
        (function tests() {
            let LAST = null;
            function render(rep) {
                LAST = rep;
                const tb = document.getElementById('testTbody'); tb.innerHTML = '';
                const flat = rep.flat || [];
                const total = flat.length, pass = flat.filter(x => x.ok).length, fail = total - pass;
                document.getElementById('testSummary').textContent = `${rep.mode.toUpperCase()} ‚Ä¢ ${rep.ok ? '‚úÖ PASS' : '‚ùå FAIL'} ‚Ä¢ ${pass}/${total} passed ‚Ä¢ ${rep.ms} ms`;
                flat.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.suite}</td><td>${r.name}</td><td>${r.ok ? '‚úÖ' : '‚ùå'}</td><td>${r.ms}</td><td><pre style="white-space:pre-wrap;margin:0">${r.err ? (r.err.msg || JSON.stringify(r.err)) || ''}</pre></td>`;
                    tb.appendChild(tr);
                });
            }
            function run(mode) {
                toast('Running ' + mode + '‚Ä¶', 'info');
                google.script.run.withSuccessHandler(r => { render(r); toast('Done', 'ok'); }).withFailureHandler(e => toast('Runner failed', 'err')).run_test_suite(mode);
            }
            document.getElementById('btnRunSmoke').addEventListener('click', () => run('smoke'));
            document.getElementById('btnRunDaily').addEventListener('click', () => run('daily'));
            document.getElementById('btnRunFull').addEventListener('click', () => run('full'));
            document.getElementById('btnCopyReport').addEventListener('click', () => {
                if (!LAST) return toast('No report', 'err');
                const text = JSON.stringify(LAST, null, 2);
                navigator.clipboard?.writeText(text).then(() => toast('Copied', 'ok')).catch(() => toast('Copy failed', 'err'));
            });
            document.getElementById('btnLogReport').addEventListener('click', () => {
                if (!LAST) return toast('No report', 'err');
                google.script.run.withSuccessHandler(r => toast(r?.ok ? 'Logged' : 'Log failed', r?.ok ? 'ok' : 'err')).withFailureHandler(e => toast('Log failed', 'err')).log_test_report(LAST);
            });
        })();

        /******** Cache badge actions ********/
        document.getElementById('btnForceReval').addEventListener('click', () => loadEvents({ force: true }));
        document.getElementById('btnCopyDiag').addEventListener('click', () => {
            const payload = { etag: STATE.etag, lastFetch: STATE.lastFetch, lastKind: STATE.lastKind, count: STATE.items.length };
            const text = JSON.stringify(payload, null, 2);
            navigator.clipboard?.writeText(text).then(() => toast('Diagnostics copied', 'ok')).catch(() => toast('Copy failed', 'err'));
        });

        /******** Buttons wiring ********/
        document.getElementById('btnCreateEvent').addEventListener('click', onCreate);
        document.getElementById('chooseEvent').addEventListener('change', enableManageButtons);
        document.getElementById('btnOpenWorkbook').addEventListener('click', () => openLink('workbook'));
        document.getElementById('btnOpenAdmin').addEventListener('click', () => openLink('admin'));
        document.getElementById('btnOpenDisplay').addEventListener('click', () => openLink('display'));
        document.getElementById('btnOpenPublic').addEventListener('click', () => openLink('public'));
        document.getElementById('btnOpenPoster').addEventListener('click', () => openLink('poster'));
        document.getElementById('btnCopyLink').addEventListener('click', copySelectedLink);
        document.getElementById('btnSaveForm').addEventListener('click', saveForm);

        /******** UI Tests (client) incl. DOM coverage smoke ********/
        (function uiTests() {
            const T = {
                now: () => performance.now(), sleep: (ms) => new Promise(r => setTimeout(r, ms)),
                ok(c, m, x) { if (!c) throw { __assert: true, msg: m, ctx: x }; }, ge(a, b, m) { if (!(a >= b)) throw { __assert: true, msg: m, ctx: { a, b } }; }
            };
            function presence(id) { return !!document.getElementById(id); }
            function minHeightOk(id, min = 44) { const el = document.getElementById(id); if (!el) return false; return (el.getBoundingClientRect().height >= min); }

            async function suiteSmoke() {
                const cases = [];
                cases.push({
                    name: 'DOM coverage (IDs present)', fn: async () => {
                        const must = ['themeToggle', 'chooseEvent', 'btnCreateEvent', 'btnOpenWorkbook', 'btnOpenAdmin', 'btnOpenDisplay', 'btnOpenPublic', 'btnOpenPoster', 'btnCopyLink', 'btnSaveForm'];
                        const missing = must.filter(id => !presence(id));
                        T.ok(missing.length === 0, 'Missing DOM ids', { missing });
                    }
                });
                cases.push({
                    name: 'Tap targets ‚â•44px', fn: async () => {
                        const ids = ['btnCreateEvent', 'btnOpenWorkbook', 'btnOpenAdmin', 'btnOpenDisplay', 'btnOpenPublic', 'btnOpenPoster'];
                        const small = ids.filter(id => !minHeightOk(id, 44));
                        T.ok(small.length === 0, 'Buttons too small', { small });
                    }
                });
                cases.push({
                    name: 'Viewport meta present', fn: async () => {
                        const ok = !!document.querySelector('meta[name="viewport"]');
                        T.ok(ok, 'No viewport meta');
                    }
                });
                cases.push({ name: 'Toast host exists', fn: async () => { T.ok(!!document.querySelector('[data-toast-host]'), 'No toast host'); } });
                return run('ui_smoke', cases);
            }
            async function suiteFull() {
                const cases = [];
                cases.push({
                    name: 'Create button disables/enables (mock)', fn: async () => {
                        const btn = document.getElementById('btnCreateEvent'); T.ok(btn, 'No create btn');
                        const orig = google.script.run.createEvent;
                        // mock minimal success
                        google.script.run.createEvent = (payload) => ({ withSuccessHandler(h) { setTimeout(() => h({ ok: true, id: 'MOCK' }), 200); return this; }, withFailureHandler() { return this; } });
                        btn.click(); await T.sleep(60); T.ok(btn.disabled, 'Not disabled'); await T.sleep(260); T.ok(!btn.disabled, 'Not re-enabled');
                        google.script.run.createEvent = orig;
                    }
                });
                return run('ui_full', cases);
            }
            function run(name, list) {
                const out = { suite: name, cases: [], ms: 0, ok: true }; const t0 = performance.now();
                return list.reduce((p, tc) => p.then(async () => {
                    const r = { name: tc.name, ok: true, ms: 0, err: null }; const s = performance.now();
                    try { await tc.fn(); } catch (e) { r.ok = false; r.err = (e && e.__assert) ? e : { msg: String(e) }; out.ok = false; }
                    r.ms = performance.now() - s; out.cases.push(r);
                }), Promise.resolve()).then(() => { out.ms = performance.now() - t0; render(out); return out; });
            }
            function render(rep) {
                const body = document.getElementById('uiTestBody'); body.innerHTML = ''; const flat = rep.cases;
                const total = flat.length, fail = flat.filter(x => !x.ok).length;
                document.getElementById('uiTestSummary').textContent = `${rep.suite.toUpperCase()} ‚Ä¢ ${fail ? '‚ùå FAIL' : '‚úÖ PASS'} ‚Ä¢ ${total - fail}/${total} passed ‚Ä¢ ${rep.ms.toFixed(0)} ms`;
                flat.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.name}</td><td>${r.ok ? '‚úÖ' : '‚ùå'}</td><td>${r.ms.toFixed(0)}</td><td><pre style="margin:0;white-space:pre-wrap">${r.err ? (r.err.msg || JSON.stringify(r.err)) || ''}</pre></td>`;
                    body.appendChild(tr);
                });
            }
            document.getElementById('btnUiSmoke').addEventListener('click', () => suiteSmoke().then(() => toast('UI smoke done', 'ok')));
            document.getElementById('btnUiFull').addEventListener('click', () => suiteFull().then(() => toast('UI full done', 'ok')));
            document.getElementById('btnUiCopy').addEventListener('click', () => {
                const table = document.getElementById('uiTestBody'); const rows = [...table.querySelectorAll('tr')].map(tr => [...tr.children].map(td => td.textContent));
                const text = JSON.stringify(rows); navigator.clipboard?.writeText(text).then(() => toast('UI report copied', 'ok')).catch(() => toast('Copy failed', 'err'));
            });
            // Expose minimal hooks if desired
            window.renderEvents = window.renderEvents || function (items) { /* replaced above */ };
        })();

        /******** Boot ********/
        window.addEventListener('DOMContentLoaded', () => { loadEvents(); });
    </script>
</body>

</html>
