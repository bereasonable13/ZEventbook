<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> · Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <?!= include('Styles'); ?>
  <style>
    :root { --gap:12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 14px; }
    header h1 { margin: 0 0 2px; }
    small#build { color:#666 }
    .row { display:flex; gap: var(--gap); flex-wrap: wrap; align-items: flex-end; }
    .card { border:1px solid #ddd; border-radius:10px; padding:14px; margin:10px 0; }
    .muted { color:#666; }
    label { display:block; font-size:.9rem; margin:.2rem 0; }
    input, select, button { font-size:1rem; padding:.55rem .7rem; }
    button { cursor:pointer; }
    .links a { margin-right:10px; }
    .qrwrap{ display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .toast { position:fixed; right:10px; bottom:10px; background:#222; color:#fff; padding:10px 12px; border-radius:8px; display:none; z-index:9999; }
    .toast.show{ display:block; }
    pre.json { background:#f7f7f7; border:1px solid #e3e3e3; border-radius:8px; padding:10px; max-height:320px; overflow:auto; }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>NextUp Admin</h1>
      <small id="build">BUILD: <?= BUILD_ID ?></small>
    </header>

    <!-- Create Eventbook -->
    <section class="card" aria-label="Create Eventbook">
      <h3>Create Eventbook</h3>
      <div class="row">
        <div>
          <label>Name</label>
          <input id="evName" placeholder="e.g., Southside Bocce Weeklies"/>
        </div>
        <div>
          <label>Start Date (ISO)</label>
          <input id="evDate" type="date"/>
        </div>
        <div>
          <label>Seeding</label>
          <select id="seedMode">
            <option value="random">Random</option>
            <option value="seeded">Seeded</option>
          </select>
        </div>
        <div>
          <label>Elimination</label>
          <select id="elimType">
            <option value="single">Single</option>
            <option value="double">Double</option>
          </select>
        </div>
        <div>
          <button id="btnCreate">Create</button>
        </div>
      </div>
      <small class="muted">Idempotent on <em>slug + start date</em>.</small>
    </section>

    <!-- Manage Eventbooks -->
    <section class="card" aria-label="Manage Eventbooks">
      <h3>Manage Eventbooks</h3>
      <div class="row">
        <div style="min-width:280px">
          <label>Choose</label>
          <select id="chooseEvent">
            <option value="">No events yet — create above</option>
          </select>
        </div>
        <div>
          <button id="btnMakeDefault" disabled>Make Default</button>
          <button id="btnArchive" disabled>Archive</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="links">
          <a id="openPublic" target="_blank" rel="noopener">Open Public</a>
          <a id="openDisplay" target="_blank" rel="noopener">Open TV</a>
          <a id="openPoster"  target="_blank" rel="noopener">Open Poster</a>
          <button id="btnCopyLinks" disabled>Copy Links</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnConfigureForm" disabled>Configure Signup Form</button>
      </div>

      <div class="qrwrap" style="margin-top:14px">
        <div><strong>Public QR</strong> <small class="muted">(shown only when verified)</small></div>
        <img id="qrImg" alt="QR" width="110" height="110" style="display:none;border:1px solid #ddd;border-radius:6px;"/>
        <a id="qrLink" target="_blank" rel="noopener"></a>
      </div>
    </section>

    <!-- Diagnostics -->
    <section class="card" aria-label="Diagnostics">
      <h3>Diagnostics</h3>
      <div class="row">
        <button id="btnSmoke">Run Smoke</button>
        <button id="btnViewLogs">View Logs</button>
        <button id="btnClearLogs">Clear Logs</button>
      </div>
      <div style="margin-top:10px">
        <pre id="diagOut" class="json" aria-live="polite">{}</pre>
      </div>
    </section>

    <div id="toast" class="toast"></div>
  </main>

  <script>
  /* ---------------- Toasts ---------------- */
  const TOAST = {
    show(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2300); },
    info(msg){ this.show(msg); console.log('[INFO]', msg); },
    error(msg){ this.show(msg); console.error('[ERR]', msg); }
  };

  const STATE = { etag:null, events:[], selected:null, links:null, optimisticId:null };

  window.addEventListener('DOMContentLoaded', () => {
    boot();
    document.getElementById('btnCreate').addEventListener('click', onCreate);
    document.getElementById('chooseEvent').addEventListener('change', onChoose);
    document.getElementById('btnMakeDefault').addEventListener('click', onMakeDefault);
    document.getElementById('btnArchive').addEventListener('click', onArchive);
    document.getElementById('btnCopyLinks').addEventListener('click', onCopyLinks);
    document.getElementById('btnConfigureForm').addEventListener('click', onConfigureForm);

    document.getElementById('btnSmoke').addEventListener('click', onSmoke);
    document.getElementById('btnViewLogs').addEventListener('click', onViewLogs);
    document.getElementById('btnClearLogs').addEventListener('click', onClearLogs);
  });

  function boot(){
    google.script.run
      .withSuccessHandler(() => swrEventsOnce())
      .withFailureHandler(err => { TOAST.error('Bootstrap failed'); console.error(err); swrEventsOnce(); })
      .ping();
  }

  /* Retry-once SWR to avoid rare null hiccups */
  function swrEventsOnce(_retried){
    google.script.run
      .withSuccessHandler(res => {
        if (!res || typeof res !== 'object'){
          if (!_retried){ console.warn('Retrying events after invalid response'); return swrEventsOnce(true); }
          return TOAST.error('Events: invalid response');
        }
        if (res.ok === false) return TOAST.error('Events error');
        if (res.notModified) return;
        STATE.events = Array.isArray(res.items) ? res.items : [];
        STATE.etag   = res.etag || null;
        paintDropdown(STATE.events);
      })
      .withFailureHandler(err => { TOAST.error('Events load failed'); console.error(err); })
      .getEventsSafe(STATE.etag);
  }

  function paintDropdown(items){
    const sel = document.getElementById('chooseEvent');
    const keep = STATE.optimisticId || sel.value;
    sel.innerHTML = '';
    if (!items.length){
      sel.innerHTML = '<option value="">No events yet — create above</option>';
      setManageDisabled(true); clearLinks(); clearQr(); STATE.optimisticId=null; return;
    }
    for (const ev of items){
      const label = (ev.name && String(ev.name).trim()) || ev.slug || ev.id || '(unnamed)';
      const txt = label + (ev.startDateISO ? ` (${ev.startDateISO})` : '') + (ev.isDefault ? ' ★' : '');
      const opt = document.createElement('option');
      opt.value = ev.id; opt.textContent = txt;
      sel.appendChild(opt);
    }
    if ([...sel.options].some(o => o.value === keep)) sel.value = keep;
    sel.value = sel.value || items[0].id;
    STATE.selected = sel.value;
    STATE.optimisticId = null;
    setManageDisabled(false);
    hydrateLinksAndQr();
  }

  function onCreate(){
    const payload = {
      name: document.getElementById('evName').value.trim(),
      startDateISO: document.getElementById('evDate').value || '',
      seedMode: document.getElementById('seedMode').value,
      elimType: document.getElementById('elimType').value
    };
    if (!payload.name){ TOAST.error('Name is required'); return; }

    TOAST.info('Creating…');
    google.script.run
      .withSuccessHandler(res => {
        if (!res || res.ok === false){ TOAST.error('Create failed'); return; }
        TOAST.info(res.idempotent ? 'Already existed — selected existing.' : 'Created!');

        // Clear form on success
        document.getElementById('evName').value = '';
        document.getElementById('evDate').value = '';

        // Optimistically remember new id so dropdown selects it after refresh
        if (res.id) STATE.optimisticId = res.id;

        // Force reload of events
        STATE.etag = null; swrEventsOnce();
      })
      .withFailureHandler(err => { TOAST.error('Create failed'); console.error(err); })
      .createEventbook(payload);
  }

  function onChoose(){
    const sel = document.getElementById('chooseEvent');
    STATE.selected = sel.value || null;
    setManageDisabled(!STATE.selected);
    hydrateLinksAndQr();
  }

  function hydrateLinksAndQr(){
    if (!STATE.selected){ clearLinks(); clearQr(); return; }

    google.script.run
      .withSuccessHandler(res => {
        if (!res || res.ok === false){ clearLinks(); return; }
        STATE.links = res;
        document.getElementById('openPublic').href  = res.publicUrl;
        document.getElementById('openDisplay').href = res.displayUrl;
        document.getElementById('openPoster').href  = res.posterUrl;
        document.getElementById('btnCopyLinks').disabled = false;

        google.script.run
          .withSuccessHandler(v => {
            if (!v || v.ok === false || !v.verified){ clearQr(); return; }
            google.script.run
              .withSuccessHandler(q => {
                if (!q || q.ok === false || !q.qrUrl){ clearQr(); return; }
                const img = document.getElementById('qrImg'); img.src = q.qrUrl; img.style.display = '';
                const a = document.getElementById('qrLink'); a.href = q.qrUrl; a.textContent = 'Open QR';
              })
              .withFailureHandler(_ => clearQr())
              .getShareQr(STATE.selected);
          })
          .withFailureHandler(_ => clearQr())
          .verifyEventSafe(STATE.selected);
      })
      .withFailureHandler(err => { console.error(err); clearLinks(); clearQr(); })
      .getShareLinks(STATE.selected);
  }

  function onMakeDefault(){
    if (!STATE.selected) return;
    google.script.run
      .withSuccessHandler(_ => { TOAST.info('Default set'); STATE.etag=null; swrEventsOnce(); })
      .withFailureHandler(err => { TOAST.error('Failed'); console.error(err); })
      .setDefaultEvent(STATE.selected);
  }

  function onArchive(){
    if (!STATE.selected) return;
    if (!confirm('Archive this eventbook?')) return;
    google.script.run
      .withSuccessHandler(_ => { TOAST.info('Archived'); STATE.etag=null; swrEventsOnce(); })
      .withFailureHandler(err => { TOAST.error('Failed'); console.error(err); })
      .archiveEvent(STATE.selected);
  }

  function onConfigureForm(){
    if (!STATE.selected) return;
    TOAST.info('Configuring form…');
    google.script.run
      .withSuccessHandler(res => {
        if (!res || res.ok === false){ TOAST.error('Form setup failed'); return; }
        TOAST.info(res.idempotent ? 'Form already linked' : 'Form created');
        if (res.formUrl) window.open(res.formUrl, '_blank');
      })
      .withFailureHandler(err => { TOAST.error('Form setup failed'); console.error(err); })
      .configureSignupForm(STATE.selected);
  }

  function onCopyLinks(){
    if (!STATE.links) return;
    const txt = `Public: ${STATE.links.publicUrl}\nDisplay: ${STATE.links.displayUrl}\nPoster: ${STATE.links.posterUrl}`;
    navigator.clipboard.writeText(txt).then(()=>TOAST.info('Links copied'));
  }

  function setManageDisabled(disabled){
    document.getElementById('btnMakeDefault').disabled = disabled;
    document.getElementById('btnArchive').disabled = disabled;
    document.getElementById('btnCopyLinks').disabled = disabled;
    document.getElementById('btnConfigureForm').disabled = disabled;
  }
  function clearLinks(){
    document.getElementById('openPublic').removeAttribute('href');
    document.getElementById('openDisplay').removeAttribute('href');
    document.getElementById('openPoster').removeAttribute('href');
    document.getElementById('btnCopyLinks').disabled = true;
  }
  function clearQr(){
    const img = document.getElementById('qrImg'); img.removeAttribute('src'); img.style.display='none';
    const a = document.getElementById('qrLink'); a.removeAttribute('href'); a.textContent='';
  }

  /* ---------------- Diagnostics ---------------- */
  function onSmoke(){
    document.getElementById('diagOut').textContent = 'Running…';
    google.script.run
      .withSuccessHandler(res => {
        document.getElementById('diagOut').textContent = JSON.stringify(res, null, 2);
        TOAST[res.ok ? 'info' : 'error'](res.ok ? 'Smoke OK' : 'Smoke failed');
        STATE.etag = null; swrEventsOnce();
      })
      .withFailureHandler(err => {
        document.getElementById('diagOut').textContent = String(err);
        TOAST.error('Smoke failed — see console'); console.error(err);
      })
      .runSmokeSafe({ form: false });
  }
  function onViewLogs(){
    document.getElementById('diagOut').textContent = 'Loading logs…';
    google.script.run
      .withSuccessHandler(res => {
        if (!res || res.ok === false){ TOAST.error('Log fetch error'); return; }
        document.getElementById('diagOut').textContent = JSON.stringify(res.items || [], null, 2);
      })
      .withFailureHandler(err => { TOAST.error('Log fetch failed'); console.error(err); })
      .getLogs(300);
  }
  function onClearLogs(){
    if (!confirm('Clear logs?')) return;
    google.script.run
      .withSuccessHandler(_ => { TOAST.info('Logs cleared'); onViewLogs(); })
      .withFailureHandler(err => { TOAST.error('Clear failed'); console.error(err); })
      .clearLogs();
  }
  </script>
</body>
</html>