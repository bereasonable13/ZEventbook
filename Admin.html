<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>
        <?= appTitle ?> · Admin
    </title>
    <?!= include('Styles'); ?>
    <style>
        .badge--active {
            background: var(--ink-700);
            color: white;
        }

        .kpi {
            font-size: 1.15rem;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <header class="appbar">
        <div class="appbar__title">
            <?= appTitle ?> · Admin
        </div>
    </header>

    <main class="container">

        <!-- ===================== CREATE EVENT (LEAN WIZARD) ===================== -->
        <section class="card" id="eventWizard" aria-labelledby="wizTitle">
            <h2 class="card__title" id="wizTitle">Create Event (Lean Wizard)</h2>

            <!-- Stepper -->
            <div class="row gap-sm" id="wizSteps" style="margin-bottom:.5rem;">
                <span class="badge" data-step="1">1. Basics</span>
                <span class="badge" data-step="2">2. Roster Source</span>
                <span class="badge" data-step="3">3. Structure</span>
                <span class="badge" data-step="4">4. Confirm</span>
            </div>

            <!-- Step 1 -->
            <div class="card card--sub" data-wiz-step="1">
                <label class="label">Event Name</label>
                <input id="wizName" class="input input--xl" placeholder="e.g., Southside Bocce Fall League" />

                <label class="label">Start Date</label>
                <input id="wizDate" class="input input--xl" type="date" />

                <label class="label">Format</label>
                <select id="wizFormat" class="select select--xl">
                    <option value="league" selected>League (default)</option>
                    <option value="tournament">Tournament</option>
                    <option value="other">Party / Other</option>
                </select>

                <div class="row gap-sm" style="margin-top:.75rem;">
                    <button class="btn btn--primary btn-xl" id="btnStep1Next">Next</button>
                </div>
            </div>

            <!-- Step 2 -->
            <div class="card card--sub" data-wiz-step="2" hidden>
                <div class="hint">Recommended:</div>
                <label class="radio">
                    <input type="radio" name="wizSource" value="signup" checked />
                    <span><strong>Players sign up by scanning a QR code</strong> (recommended)</span>
                </label>

                <details style="margin-top:.5rem;">
                    <summary>Other options</summary>
                    <div class="stack gap-sm" style="margin-top:.5rem;">

                        <!-- Import option (CSV or Google Sheet URL) -->
                        <label class="radio">
                            <input type="radio" name="wizSource" value="import" />
                            <span>Import a roster (CSV / Google Sheet URL)</span>
                        </label>
                        <div id="wizImportWrap" class="card card--sub" hidden>
                            <label class="label">Paste CSV (one team/player per line)</label>
                            <textarea id="wizImportCsv" class="input" rows="5"
                                placeholder="Team A&#10;Team B&#10;Team C"></textarea>

                            <div class="hint" style="margin:.5rem 0">— or —</div>

                            <label class="label">Google Sheet URL (first non-empty sheet/column)</label>
                            <input id="wizImportSheetUrl" class="input"
                                placeholder="https://docs.google.com/spreadsheets/d/…/edit#gid=0" />
                            <div class="hint">We’ll read names from the first filled column. Ensure the web app’s
                                account can open the Sheet.</div>
                        </div>

                        <!-- Manual option -->
                        <label class="radio">
                            <input type="radio" name="wizSource" value="manual" />
                            <span>Enter teams/players manually</span>
                        </label>
                        <div id="wizManualWrap" class="card card--sub" hidden>
                            <label class="label">Manual entries (one per line)</label>
                            <textarea id="wizManualList" class="input" rows="5"
                                placeholder="Team A&#10;Team B&#10;Team C"></textarea>
                        </div>
                    </div>
                </details>

                <div class="row gap-sm" style="margin-top:.75rem;">
                    <button class="btn btn--ghost btn-xl" id="btnStep2Back">Back</button>
                    <button class="btn btn--primary btn-xl" id="btnStep2Next">Next</button>
                </div>
            </div>

            <!-- Step 3 -->
            <div class="card card--sub" data-wiz-step="3" hidden>
                <label class="radio">
                    <input type="radio" name="wizStructure" value="schedule" checked />
                    <span><strong>Auto-generate schedule</strong> (default)</span>
                </label>

                <label class="checkbox" style="margin-left:1.75rem;">
                    <input type="checkbox" id="wizAddTourney" />
                    <span>Add Tournament/Playoffs after schedule</span>
                </label>

                <details style="margin-top:.5rem;">
                    <summary>Advanced: Roster only (no games)</summary>
                    <div class="card card--sub" style="margin-top:.5rem;">
                        <label class="radio">
                            <input type="radio" name="wizStructure" value="roster-only" />
                            <span>Roster only (RSVP / waitlist / clinic)</span>
                        </label>
                    </div>
                </details>

                <div class="row gap-sm" style="margin-top:.75rem;">
                    <button class="btn btn--ghost btn-xl" id="btnStep3Back">Back</button>
                    <button class="btn btn--primary btn-xl" id="btnStep3Next">Next</button>
                </div>
            </div>

            <!-- Step 4 -->
            <div class="card card--sub" data-wiz-step="4" hidden>
                <div id="wizSummary" class="stack"></div>

                <!-- Import preview (only shown when source = import) -->
                <div id="wizImportPreview" class="card card--sub" style="margin-top:.5rem; display:none;">
                    <div class="row" style="justify-content:space-between; align-items:center;">
                        <h3 class="card__title" style="margin:0;">Import Preview</h3>
                        <button class="btn btn--ghost" id="btnRecheckImport" type="button">Re-validate</button>
                    </div>
                    <div id="wizImportPreviewMsg" class="hint">Validating…</div>
                    <div id="wizImportPreviewCount" class="kpi" style="margin-top:.25rem;"></div>
                    <details style="margin-top:.25rem;">
                        <summary>Show sample</summary>
                        <ul id="wizImportPreviewList" class="list" style="margin:.5rem 0 0;"></ul>
                    </details>
                </div>

                <div class="row gap-sm" style="margin-top:.75rem;">
                    <button class="btn btn--ghost btn-xl" id="btnStep4Back">Back</button>
                    <button class="btn btn--primary btn-xl" id="btnCreateEvent">Create Event</button>
                </div>

                <div id="wizResult" class="stack" style="margin-top:1rem;" hidden>
                    <div class="kpi">Event Created</div>
                    <div id="wizEventId" class="hint"></div>
                    <div id="wizQrWrap" class="row gap-sm" style="align-items:flex-start;"></div>
                </div>
            </div>
        </section>

    </main>

    <script>
        (() => {
            // --- State ---
            const state = {
                step: 1,
                name: "",
                dateISO: "",
                format: "league",
                source: "signup", // signup | import | manual
                importCsv: "",
                sheetUrl: "",
                manualList: "",
                structure: "schedule", // schedule | roster-only
                addTourney: false
            };

            // --- DOM helpers ---
            const $ = (s, r = document) => r.querySelector(s);
            const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
            const setStep = (n) => {
                state.step = n;
                $$('[data-wiz-step]').forEach(el => el.hidden = (+el.dataset.wizStep !== n));
                $$('#wizSteps .badge').forEach(b => b.classList.toggle('badge--active', +b.dataset.step === n));
            };
            const toISO = (v) => {
                try {
                    if (!v) return "";
                    const d = new Date(v + "T00:00:00");
                    return isNaN(d.getTime()) ? "" : d.toISOString().slice(0, 10);
                } catch { return ""; }
            };

            // Helpers for import preview
            function parseCsvClient(text) {
                if (!text) return [];
                return text.split(/\r?\n/).map(s => (s || '').trim()).filter(Boolean);
            }
            function dedupe(list) {
                const seen = new Set(); const out = [];
                for (const n of list) if (n && !seen.has(n)) { seen.add(n); out.push(n); }
                return out;
            }

            const summarize = () => {
                const lines = [];
                lines.push(`<div><strong>Name:</strong> ${state.name}</div>`);
                lines.push(`<div><strong>Date:</strong> ${state.dateISO || "—"}</div>`);
                lines.push(`<div><strong>Format:</strong> ${state.format}</div>`);
                lines.push(`<div><strong>Roster Source:</strong> ${state.source}</div>`);
                const struct = state.structure === 'roster-only'
                    ? 'Roster only'
                    : 'Schedule' + (state.addTourney ? ' + Tournament' : '');
                lines.push(`<div><strong>Structure:</strong> ${struct}</div>`);
                $('#wizSummary').innerHTML = lines.join('');
            };
            
            
            <script>
// --- tiny helpers (only define if missing) ---
if (typeof pct === 'undefined') {
  window.pct = (n,d)=> d? Math.round((100*n)/d) : 0;
}
if (typeof renderPassBar === 'undefined') {
  window.renderPassBar = function(el, total, passed) {
    el.innerHTML='';
    total=Number(total||0); passed=Number(passed||0);
    const failed=Math.max(0,total-passed);
    const w=260,h=16; const pW= total? Math.round(w*(passed/total)) : 0; const fW=w-pW;
    const svg = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" role="img" aria-label="Pass rate">
      <rect x="0" y="0" width="${w}" height="${h}" fill="#eee" rx="4" ry="4"/>
      <rect x="0" y="0" width="${pW}" height="${h}" fill="#27ae60" rx="4" ry="4"/>
      ${fW? `<rect x="${pW}" y="0" width="${fW}" height="${h}" fill="#e74c3c" rx="4" ry="4"/>` : '' }
      <text x="${w-4}" y="${h-4}" text-anchor="end" font-size="11" fill="#333">${pct(passed,total)}%</text>
    </svg>`;
    el.insertAdjacentHTML('beforeend', svg);
  };
}

// --- UNIVERSAL DIAGNOSTIC RENDERER ---
window.renderDiagTable = function(report) {
  const host = document.getElementById('diagOut');
  if (!host) return;
  host.innerHTML = '';

  // Normalize shapes
  const isAllCards = report && Array.isArray(report.results) && report.results.length &&
                     report.results[0] && typeof report.results[0].name === 'string' &&
                     Array.isArray(report.results[0].results);

  const isSuiteRun = report && Array.isArray(report.results) &&
                     !isAllCards;

  // Header strip + pass bar
  const top = document.createElement('div');
  top.className = 'row';
  top.style.alignItems = 'center';
  const totals = (function() {
    if (report && report.totals) return report.totals;
    if (isSuiteRun) {
      const total = report.results.length;
      const passed = report.results.filter(t=>t.ok).length;
      return { total, passed, failed: total - passed };
    }
    if (isAllCards) {
      const total = report.results.reduce((a,s)=>a + (s.results ? s.results.length : 0), 0);
      const passed = report.results.reduce((a,s)=>a + (s.results ? s.results.filter(t=>t.ok).length : 0), 0);
      return { total, passed, failed: total - passed };
    }
    return { total: 0, passed: 0, failed: 0 };
  })();

  top.innerHTML = `
    <div class="hint">
      Total <b>${totals.total}</b> •
      Passed <b style="color:var(--ok)">${totals.passed}</b> •
      Failed <b style="color:var(--danger)">${totals.failed}</b>
    </div>
    <div id="passbar" style="margin-left:12px;"></div>
  `;
  host.appendChild(top);
  renderPassBar(top.querySelector('#passbar'), totals.total, totals.passed);

  // Shape 1: All-cards (multiple suites in one payload)
  if (isAllCards) {
    // Summary table by suite
    const sum = document.createElement('table');
    sum.className = 'table';
    sum.innerHTML = `<thead>
        <tr><th>Suite</th><th>OK</th><th>Tests</th><th>Passed</th><th>Failed</th></tr>
      </thead><tbody></tbody>`;
    const sbody = sum.querySelector('tbody');
    report.results.forEach(s=>{
      const total = (s.results||[]).length;
      const passed = (s.results||[]).filter(t=>t.ok).length;
      const failed = total - passed;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.name}</td>
        <td style="font-weight:800;color:${s.ok?'var(--ok)':'var(--danger)'}">${s.ok?'PASS':'FAIL'}</td>
        <td>${total}</td><td>${passed}</td><td>${failed}</td>`;
      sbody.appendChild(tr);
    });
    host.appendChild(sum);

    // Flatten tests for details
    const flat = [];
    report.results.forEach(s=>{
      (s.results||[]).forEach(t=> flat.push({ suite:s.name, ...t }));
    });

    const tb = document.createElement('table');
    tb.className = 'table';
    tb.innerHTML = `<thead>
      <tr><th>Suite</th><th>Test</th><th>OK</th><th>ms</th><th>Meta</th></tr>
    </thead><tbody></tbody>`;
    const body = tb.querySelector('tbody');
    flat.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.suite}</td>
        <td>${r.name}</td>
        <td style="font-weight:800;color:${r.ok?'var(--ok)':'var(--danger)'}">${r.ok?'PASS':'FAIL'}</td>
        <td>${r.ms||''}</td>
        <td><code>${(typeof r.meta==='object'? JSON.stringify(r.meta): (r.meta||'')).toString().slice(0,200)}</code></td>
      `;
      body.appendChild(tr);
    });
    host.appendChild(tb);
    return;
  }

  // Shape 2: Single suite run (report.results is list of tests)
  if (isSuiteRun) {
    const tb = document.createElement('table');
    tb.className = 'table';
    tb.innerHTML = `<thead>
      <tr><th>#</th><th>Test</th><th>OK</th><th>ms</th><th>Meta</th></tr>
    </thead><tbody></tbody>`;
    const body = tb.querySelector('tbody');
    report.results.forEach((r, i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${r.name}</td>
        <td style="font-weight:800;color:${r.ok?'var(--ok)':'var(--danger)'}">${r.ok?'PASS':'FAIL'}</td>
        <td>${r.ms||''}</td>
        <td><code>${(typeof r.meta==='object'? JSON.stringify(r.meta): (r.meta||'')).toString().slice(0,200)}</code></td>
      `;
      body.appendChild(tr);
    });
    host.appendChild(tb);
    return;
  }

  // Fallback: show JSON for unknown shapes
      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(report, null, 2);
      host.appendChild(pre);
  };


            // Step 1
            $('#btnStep1Next').addEventListener('click', () => {
                state.name = $('#wizName').value.trim();
                state.dateISO = toISO($('#wizDate').value);
                state.format = $('#wizFormat').value || 'league';
                if (!state.name) { alert('Please enter an event name.'); return; }
                setStep(2);
            });

            // Source radios + conditional blocks
            $$('input[name="wizSource"]').forEach(r => {
                r.addEventListener('change', (e) => {
                    const v = e.target.value;
                    state.source = v;
                    $('#wizImportWrap').hidden = v !== 'import';
                    if ($('#wizManualWrap')) $('#wizManualWrap').hidden = v !== 'manual';
                });
            });

            $('#btnStep2Back').addEventListener('click', () => setStep(1));
            $('#btnStep2Next').addEventListener('click', () => {
                if (state.source === 'import') {
                    state.importCsv = ($('#wizImportCsv')?.value || '').trim();
                    state.sheetUrl = ($('#wizImportSheetUrl')?.value || '').trim();
                    if (!state.importCsv && !state.sheetUrl) {
                        if (!confirm('No CSV or Sheet URL provided. Continue anyway?')) return;
                    }
                }
                if (state.source === 'manual') {
                    state.manualList = ($('#wizManualList')?.value || '').trim();
                }
                setStep(3);
            });

            // Structure
            $$('input[name="wizStructure"]').forEach(r => {
                r.addEventListener('change', (e) => {
                    state.structure = e.target.value;
                    if (state.structure === 'roster-only') {
                        $('#wizAddTourney').checked = false;
                        $('#wizAddTourney').disabled = true;
                    } else {
                        $('#wizAddTourney').disabled = false;
                    }
                });
            });
            $('#wizAddTourney').addEventListener('change', (e) => {
                state.addTourney = !!e.target.checked;
            });

            $('#btnStep3Back').addEventListener('click', () => setStep(2));
            $('#btnStep3Next').addEventListener('click', () => {
                summarize();
                setStep(4);
                runImportPreview(); // kicks off preview if source = 'import'
            });
            $('#btnStep4Back').addEventListener('click', () => setStep(3));

            // Import preview (Step 4)
            async function runImportPreview() {
                const wrap = $('#wizImportPreview');
                const msg = $('#wizImportPreviewMsg');
                const cnt = $('#wizImportPreviewCount');
                const ul = $('#wizImportPreviewList');

                if (state.source !== 'import') { wrap.style.display = 'none'; return; }
                wrap.style.display = '';
                msg.textContent = 'Validating…';
                cnt.textContent = '';
                ul.innerHTML = '';

                let combined = parseCsvClient(state.importCsv);

                if (state.sheetUrl && window.google?.script?.run?.ingestSheet) {
                    try {
                        const sheetRes = await new Promise((resolve, reject) => {
                            google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).ingestSheet(state.sheetUrl);
                        });
                        if (sheetRes && sheetRes.ok && Array.isArray(sheetRes.teams)) {
                            combined = combined.concat(sheetRes.teams);
                        } else {
                            const err = (sheetRes && sheetRes.error) || 'Unknown error reading Sheet.';
                            msg.textContent = 'Sheet warning: ' + err + ' (CSV will still be used if provided)';
                        }
                    } catch (e) {
                        msg.textContent = 'Sheet error: ' + (e && e.message ? e.message : e);
                    }
                }

                const finalList = dedupe(combined.map(s => String(s || '').trim()).filter(Boolean));
                const n = finalList.length;

                if (n === 0) {
                    cnt.textContent = '0 names detected';
                    if (!state.importCsv && !state.sheetUrl) {
                        msg.textContent = 'Provide CSV lines and/or a Google Sheet URL to import.';
                    } else {
                        msg.textContent = 'Nothing found. Check CSV lines and/or the Sheet’s first column.';
                    }
                    return;
                }

                msg.textContent = 'Looks good.';
                cnt.textContent = `${n} name${n === 1 ? '' : 's'} will be imported`;

                const sample = finalList.slice(0, 10);
                ul.innerHTML = '';
                for (const name of sample) {
                    const li = document.createElement('li');
                    li.textContent = name;
                    ul.appendChild(li);
                }
            }

            $('#btnRecheckImport')?.addEventListener('click', runImportPreview);

            // Create Event
            $('#btnCreateEvent').addEventListener('click', () => {
                const btn = $('#btnCreateEvent');
                btn.disabled = true;

                // Map UI -> server payload (aligns with your Code.gs createEvent)
                const payload = {
                    name: state.name,
                    startDate: state.dateISO, // Code.gs expects startDate/date
                    flow: (state.structure === 'roster-only') ? 'REGISTRATION'
                        : (state.addTourney ? 'SEASON_TOURNEY' : 'SEASON_ONLY'),
                    elimType: 'SINGLE', // default; user can adjust later in Admin
                    seedMode: 'RANDOM', // default; can be changed
                    source: state.source // signup | import | manual
                };

                if (state.source === 'import') {
                    if (state.importCsv) payload.importCsv = state.importCsv;
                    if (state.sheetUrl) payload.sheetUrl = state.sheetUrl;
                }
                if (state.source === 'manual' && state.manualList) {
                    payload.importCsv = state.manualList; // reuse server importer path if desired
                    payload.source = 'import';
                }

                const done = (res) => {
                    btn.disabled = false;
                    if (!res || !res.eventId) { alert('CreateEvent returned no eventId.'); return; }
                    $('#wizResult').hidden = false;
                    $('#wizEventId').textContent = `Event ID: ${res.eventId}`;

                    if (window.google?.script?.run?.getShareQr) {
                        google.script.run
                            .withSuccessHandler(({ url, qrB64 } = {}) => {
                                const wrap = $('#wizQrWrap');
                                wrap.innerHTML = '';
                                if (qrB64) {
                                    const img = document.createElement('img');
                                    img.alt = 'Public QR';
                                    img.src = `data:image/png;base64,${qrB64}`;
                                    img.style.maxWidth = '160px';
                                    wrap.appendChild(img);
                                }
                                if (url) {
                                    const a = document.createElement('a');
                                    a.href = url; a.target = '_blank'; a.rel = 'noopener';
                                    a.textContent = 'Open Public Page';
                                    a.className = 'btn btn--ghost';
                                    wrap.appendChild(a);
                                }
                            })
                            .withFailureHandler(err => { console.error(err); })
                            .getShareQr(res.eventId);
                    }
                };

                if (window.google?.script?.run?.createEvent) {
                    google.script.run.withSuccessHandler(done).withFailureHandler(e => {
                        console.error(e); alert('Failed to create event. Check Logs.');
                        btn.disabled = false;
                    }).createEvent(payload);
                } else {
                    console.log('Mock createEvent payload:', payload);
                    done({ eventId: 'TEST-EVENT-ID' });
                }
            });

            // Init
            setStep(1);
        })();
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>
        <?= appTitle ?> · Admin
    </title>
    <?!= include('Styles'); ?>
    <style>
        /* Admin-only small tweaks */
        .section-caption {
            margin-top: -6px;
            margin-bottom: 8px
        }

        .label-inline {
            font-size: .9rem;
            margin-left: 6px
        }

        .qrwrap {
            display: flex;
            gap: 14px;
            align-items: center;
            flex-wrap: wrap
        }

        .links a {
            margin-right: 10px
        }

        /* Busy overlay (page-local, mirrors other views) */
        #busy {
            position: fixed;
            inset: 0;
            display: none;
            place-items: center;
            z-index: 4000;
            background: rgba(0, 0, 0, .55);
        }

        #busy .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #busy .spinner {
            font-size: 1.6rem;
            line-height: 1;
            display: flex;
            gap: 8px;
        }

        #busy .msg {
            font-weight: 700;
        }
    </style>
</head>

<body>
    <header class="appbar">
        <div class="appbar__title">
            <?= appTitle ?> · Admin
        </div>
    </header>

    <main class="container">

        <!-- Busy overlay -->
        <div id="busy" aria-live="polite">
            <div class="card">
                <div class="spinner">
                    <span class="mascot" data-kind="runner">🏃‍♂️</span>
                    <span class="mascot" data-kind="pitcher">🥎</span>
                    <span class="mascot" data-kind="bocce">🧶</span>
                </div>
                <div class="msg">Working…</div>
            </div>
        </div>

        <!-- Toast (Styles puts it top-center) -->
        <div id="toast" class="toast" style="display:none;" role="status" aria-live="polite"></div>

        <!-- CREATE EVENT -->
        <section class="card" aria-labelledby="createTitle">
            <h2 class="card__title" id="createTitle">Create Event</h2>

            <div class="grid grid--compact">
                <input id="evName" class="input" placeholder="Event name (e.g., Fall Weeklies)" autocomplete="off" />
                <input id="evDate" class="input" type="date" />
                <div class="row">
                    <label class="sr-only" for="evFlow">Flow</label>
                    <select id="evFlow" class="input" title="Flow">
                        <option value="SEASON_TOURNEY">Season → Tournament</option>
                        <option value="TOURNEY_ONLY">Tournament only</option>
                    </select>

                    <label class="sr-only" for="evWeeks">Weeks</label>
                    <select id="evWeeks" class="input" title="Weeks">
                        <option value="">Weeks…</option>
                        <option>3</option>
                        <option>4</option>
                        <option selected>5</option>
                        <option>6</option>
                        <option>7</option>
                        <option>8</option>
                    </select>

                    <label class="sr-only" for="evElim">Elimination</label>
                    <select id="evElim" class="input" title="Elimination">
                        <option value="SINGLE" selected>Single Elimination</option>
                        <option value="DOUBLE">Double Elimination</option>
                    </select>

                    <label class="sr-only" for="evSeed">Seeding</label>
                    <select id="evSeed" class="input" title="Seeding">
                        <option value="RANDOM" selected>Random</option>
                        <option value="SEEDED">Seeded</option>
                    </select>

                    <button id="btnCreate" class="btn btn--primary tap-xl">Create</button>
                </div>
            </div>
            <p class="hint mt-1">Defaults: Flow = Season→Tournament, Weeks = 5, Elimination = Single, Seeding = Random.
            </p>
            <div id="createMsg" class="hint" role="status" aria-live="polite"></div>
        </section>

        <!-- MANAGE EVENT -->
        <section class="card" aria-labelledby="manageTitle">
            <h2 class="card__title" id="manageTitle">Manage Event</h2>

            <div class="row row--justify">
                <label class="sr-only" for="chooseEvent">Choose Event</label>
                <select id="chooseEvent" class="input input--select"
                    title="Choose Event (empty until you create one)"></select>
                <button id="btnRefreshEvents" class="btn btn--ghost btn--icon" title="Refresh"
                    aria-label="Refresh">↻</button>
            </div>
            <p id="emptyTip" class="hint mt-1" style="display:none;">
                No events yet — create one above to populate this menu.
            </p>

            <div id="eventMeta" class="mt-2"><!-- Filled by renderCurrent() --></div>

            <div class="actions">
                <button id="btnSetDefault" class="btn">Set Default</button>
                <button id="btnOpenPublic" class="btn">Open Public</button>
                <a id="aOpenTV" class="btn btn--ghost" target="_blank" rel="noopener">Open TV/Display</a>
                <button id="btnOpenSheets" class="btn">Open Sheets</button>
            </div>
        </section>

        <!-- SIGNUPS -->
        <section class="card" aria-labelledby="signupsTitle">
            <h2 class="card__title" id="signupsTitle">Signups</h2>
            <div class="row" style="align-items:flex-end;">
                <div>
                    <div id="signupCountTile" class="tile">0</div>
                    <div class="hint">Total signups</div>
                </div>
                <div>
                    <button id="btnCreateForm" class="btn">Create Signup Form</button>
                    <label class="label-inline"><input type="checkbox" id="optEmail"> Require Email</label>
                    <label class="label-inline"><input type="checkbox" id="optPhone"> Phone</label>
                    <label class="label-inline"><input type="checkbox" id="optNotes"> Notes</label>
                </div>
            </div>
            <div id="seedTools" class="row mt-1" style="display:none;">
                <button id="btnAddSeedCol" class="btn">Add/Update “Seed” Column</button>
                <span class="hint">For seeded brackets, add seeds in the Signups sheet (1..N).</span>
            </div>
        </section>

        <!-- SHARE -->
        <section class="card" aria-labelledby="shareTitle">
            <h2 class="card__title" id="shareTitle">Share</h2>
            <div class="qrwrap">
                <div>
                    <div id="qrPublic" class="qr muted" title="Public link QR"></div>
                    <div class="section-caption hint">Public QR</div>
                    <div class="row">
                        <button id="btnCopyPublic" class="btn btn--ghost">Copy Public Link</button>
                        <button id="btnCopyDisplay" class="btn btn--ghost">Copy Display Link</button>
                        <button id="btnCopyPoster" class="btn btn--ghost">Copy Poster Link</button>
                    </div>
                    <div id="publicUrl" class="hint" style="margin-top:6px;"></div>
                </div>
                <div>
                    <div id="qrForm" class="qr muted" title="Signup form QR"></div>
                    <div class="section-caption hint">Signup Form QR</div>
                    <div class="row">
                        <button id="btnCopyForm" class="btn btn--ghost">Copy Form Link</button>
                    </div>
                    <div id="formUrl" class="hint" style="margin-top:6px;"></div>
                </div>
            </div>
            <p class="hint mt-1">Public & TV pages auto-refresh. Share the QR or short link.</p>
        </section>

        <!-- SCHEDULE -->
        <section class="card" aria-labelledby="schedTitle">
            <h2 class="card__title" id="schedTitle">Schedule</h2>
            <div class="row">
                <label class="sr-only" for="weeksEdit">Weeks</label>
                <select id="weeksEdit" class="input" title="Weeks">
                    <option value="">Weeks…</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                    <option>6</option>
                    <option>7</option>
                    <option>8</option>
                </select>
                <button id="btnGenSchedule" class="btn">Generate Schedule</button>
                <span class="hint">Creates Week rows; courts/times/teams can be filled in Google Sheets.</span>
            </div>
        </section>

        <!-- BRACKETS -->
        <section class="card" aria-labelledby="brktTitle">
            <h2 class="card__title" id="brktTitle">Brackets</h2>
            <div class="row">
                <label class="sr-only" for="elimTypeEdit">Elimination</label>
                <select id="elimTypeEdit" class="input" title="Elimination">
                    <option value="SINGLE">Single Elimination</option>
                    <option value="DOUBLE">Double Elimination</option>
                </select>
                <label class="sr-only" for="seedModeEdit">Seeding</label>
                <select id="seedModeEdit" class="input" title="Seeding">
                    <option value="RANDOM">Random</option>
                    <option value="SEEDED">Seeded</option>
                </select>

                <button id="btnGenBrackets" class="btn">Generate / Reset</button>
                <button id="btnRefreshView" class="btn btn--icon" title="Refresh" aria-label="Refresh">↻</button>
                <span id="brktStatus" class="hint"></span>
            </div>
            <p class="hint mt-1">If “Seeded” is chosen, ensure the Signups sheet has a contiguous 1..N “Seed” column.
            </p>
        </section>
        
        <button id="btnRunAllSuites" class="btn">Run All Suites</button>

        <select id="histSuite" class="input input--select" style="max-width:180px">
          <option value="">(All suites)</option>
          <option>quick</option><option>full</option><option>create</option>
          <option>manage</option><option>signups</option><option>share</option>
          <option>schedule</option><option>brackets</option><option>allcards</option>
        </select>
        
        <select id="histLimit" class="input input--select" style="max-width:120px">
          <option value="50">Last 50</option>
          <option value="200" selected>Last 200</option>
          <option value="1000">Last 1000</option>
        </select>
        <button id="btnShowHistory" class="btn btn--ghost">History</button>
        <button id="btnExportTests" class="btn btn--ghost">Export CSV</button>
        
        <select id="trendDays" class="input input--select" style="max-width:120px">
          <option value="7" selected>Trend 7d</option>
          <option value="30">Trend 30d</option>
          <option value="">All</option>
        </select>
        <button id="btnShowTrends" class="btn btn--ghost">Trends</button>
        
        <select id="perfDays" class="input input--select" style="max-width:120px">
          <option value="1">Perf 1d</option>
          <option value="7" selected>Perf 7d</option>
          <option value="30">Perf 30d</option>
          <option value="">All</option>
        </select>
        <button id="btnShowPerf" class="btn btn--ghost">Perf</button>
        
        <button id="btnShowFlaky" class="btn btn--ghost">Flaky</button>
        
    </main>

    <script>
        // ---------- Utilities ----------
        const $ = (s, p = document) => p.querySelector(s);
        const $all = (s, p = document) => Array.from(p.querySelectorAll(s));
        const fmt = (x) => (x == null ? '' : String(x));

        function toast(msg, ok = true) {
            const t = $('#toast');
            t.textContent = msg;
            t.style.display = 'block';
            t.className = 'toast ' + (ok ? 'ok' : 'danger');
            setTimeout(() => t.style.display = 'none', 2400);
        }

        function setBusy(on, message) {
            const ov = $('#busy');
            if (!ov) return;
            const msg = ov.querySelector('.msg');
            if (msg) msg.textContent = message || 'Working…';
            ov.style.display = on ? 'grid' : 'none';
            document.body.classList.toggle('is-busy', !!on);
        }

        function setQR(el, url) {
            if (!el) return;
            el.innerHTML = '';
            if (!url) { el.classList.add('muted'); el.title = 'No link yet'; return; }
            el.classList.remove('muted');
            const img = new Image();
            img.width = 160; img.height = 160; img.alt = 'QR';
            img.src = 'https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=' + encodeURIComponent(url);
            el.appendChild(img);
        }

        const STATE = { events: [], current: null, loading: false, links: null };

        // ---------- Load & Render ----------
        async function loadEvents(preselectId) {
            setBusy(true, 'Loading events…');
            const sel = $('#chooseEvent');
            const tip = $('#emptyTip');
            sel.innerHTML = '<option disabled>Loading…</option>';
            sel.title = 'Loading…';
            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(rows => {
                            STATE.events = rows || [];
                            sel.innerHTML = '';
                            if (!STATE.events.length) {
                                const o = document.createElement('option');
                                o.disabled = true;
                                o.textContent = '— No events —';
                                sel.appendChild(o);
                                sel.disabled = true;
                                tip.style.display = 'block';
                                setCurrent(null);
                                resolve();
                                return;
                            }
                            tip.style.display = 'none';
                            sel.disabled = false;

                            STATE.events.forEach(e => {
                                const o = document.createElement('option');
                                o.value = e.eventId;
                                const dateStr = e.date || '';
                                const label = (e.name && e.name.trim()) ? e.name : (e.slug || e.sid || '(unnamed)');
                                o.textContent = `${label}${dateStr ? ' (' + dateStr + ')' : ''}${e.isDefault ? ' ★' : ''}`;
                                o.title = `${label}${dateStr ? ' • ' + dateStr : ''}`;
                                sel.appendChild(o);
                            });

                            let chosen = null;
                            if (preselectId) chosen = STATE.events.find(e => e.eventId === preselectId);
                            if (!chosen) chosen = STATE.events.find(e => e.isDefault) || STATE.events[0] || null;

                            if (chosen) { sel.value = chosen.eventId; setCurrent(chosen.eventId); }
                            else { setCurrent(null); }
                            resolve();
                        })
                        .withFailureHandler(err => { reject(err); })
                        .getEvents();
                });
            } catch (err) {
                console.error('getEvents failed:', err);
                toast('Failed to load events', false);
                sel.innerHTML = '<option disabled>(load failed)</option>';
                setCurrent(null);
            } finally {
                setBusy(false);
            }
        }

        function setCurrent(eventId) {
            STATE.current = STATE.events.find(e => e.eventId === eventId) || null;
            renderCurrent();
            refreshShareLinks(); // keep Share section in sync
        }

        function renderCurrent() {
            const e = STATE.current;
            const meta = $('#eventMeta');
            const publicUrlEl = $('#publicUrl');
            const formUrlEl = $('#formUrl');

            if (!e) {
                meta.innerHTML = '<div class="empty">No event selected.</div>';
                setQR($('#qrPublic'), '');
                setQR($('#qrForm'), '');
                publicUrlEl.textContent = '';
                formUrlEl.textContent = '';
                $('#seedTools').style.display = 'none';
                $('#aOpenTV').removeAttribute('href');
                return;
            }

            const dateStr = e.date || '';
            const label = (e.name && e.name.trim()) ? e.name : (e.slug || e.sid || '(unnamed)');
            meta.innerHTML = `
<div><strong>${label}</strong>${dateStr ? ' • ' + dateStr : ''} ${e.isDefault ? '★' : ''}</div>
<div class="hint">Flow: ${e.flow} • Elim: ${e.elimType} • Seed: ${e.seedMode}</div>
<div class="hint">Signups: ${e.counts?.signups ?? 0}</div>
`;

            // show seed tools hint only when seeded
            $('#seedTools').style.display = (e.seedMode === 'SEEDED') ? 'flex' : 'none';

            // Reset visible links until refreshShareLinks() fills in
            setQR($('#qrPublic'), '');
            setQR($('#qrForm'), '');
            publicUrlEl.textContent = '';
            formUrlEl.textContent = '';
            $('#aOpenTV').removeAttribute('href');
        }

        // ---------- Share / Links ----------
        function refreshShareLinks() {
            if (!STATE.current) { STATE.links = null; return; }
            setBusy(true, 'Preparing links…');
            google.script.run
                .withSuccessHandler(links => {
                    STATE.links = links || {};
                    const publicUrlEl = $('#publicUrl');
                    const formUrlEl = $('#formUrl');

                    // Prefer server-provided Base64 QR (faster, offline-safe); fallback to URL QR
                    if (links.qrPublicB64) {
                        const q = $('#qrPublic'); q.innerHTML = ''; q.classList.remove('muted');
                        const img = new Image(); img.width = 160; img.height = 160; img.alt = 'QR';
                        img.src = `data:image/png;base64,${links.qrPublicB64}`; q.appendChild(img);
                    } else { setQR($('#qrPublic'), links.publicUrl || ''); }

                    if (links.qrFormB64) {
                        const q2 = $('#qrForm'); q2.innerHTML = ''; q2.classList.remove('muted');
                        const img2 = new Image(); img2.width = 160; img2.height = 160; img2.alt = 'QR';
                        img2.src = `data:image/png;base64,${links.qrFormB64}`; q2.appendChild(img2);
                    } else { setQR($('#qrForm'), links.formUrl || ''); }

                    publicUrlEl.textContent = links.publicUrl || '';
                    formUrlEl.textContent = links.formUrl || '';
                    const tv = $('#aOpenTV'); if (tv) tv.href = links.displayUrl || '#';

                    // Copy buttons
                    $('#btnCopyPublic').onclick = async () => {
                        try { await navigator.clipboard.writeText(links.publicUrl || ''); toast('Public link copied'); }
                        catch { toast('Copy failed', false); }
                    };
                    $('#btnCopyDisplay').onclick = async () => {
                        try { await navigator.clipboard.writeText(links.displayUrl || ''); toast('Display link copied'); }
                        catch { toast('Copy failed', false); }
                    };
                    $('#btnCopyPoster').onclick = async () => {
                        try { await navigator.clipboard.writeText(links.posterUrl || ''); toast('Poster link copied'); }
                        catch { toast('Copy failed', false); }
                    };
                    $('#btnCopyForm').onclick = async () => {
                        try { await navigator.clipboard.writeText(links.formUrl || ''); toast('Form link copied'); }
                        catch { toast('Copy failed', false); }
                    };

                    setBusy(false);
                })
                .withFailureHandler(err => { console.error(err); toast('Link prep failed', false); setBusy(false); })
                .getShareLinks(STATE.current.eventId);
        }

        // ---------- Handlers ----------
        document.addEventListener('change', (ev) => {
            if (ev.target && ev.target.id === 'chooseEvent') {
                setCurrent(ev.target.value);
            }
        });

        // Create event
        $('#btnCreate').addEventListener('click', async () => {
            const payload = {
                name: $('#evName').value.trim(),
                date: $('#evDate').value, // Code.gs maps startDate/date to "startDate"
                flow: $('#evFlow').value,
                weeks: $('#evFlow').value === 'SEASON_TOURNEY' ? Number($('#evWeeks').value || 0) : 0,
                elimType: $('#evElim').value,
                seedMode: $('#evSeed').value
            };

            if (!payload.name || !payload.date) { toast('Name and date are required', false); return; }
            if (payload.flow === 'SEASON_TOURNEY' && !payload.weeks) { toast('Choose weeks for Season → Tournament', false); return; }

            setBusy(true, 'Creating event…');
            try {
                const created = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(row => resolve(row))
                        .withFailureHandler(err => reject(err))
                        .createEvent(payload);
                });
                toast('Event created');
                // Clear fields
                $('#evName').value = ''; $('#evDate').value = '';
                // Reload and preselect the new eventId
                await loadEvents(created && created.eventId);
            } catch (err) {
                console.error(err);
                toast((err && err.message) || 'Create failed', false);
            } finally {
                setBusy(false);
            }
        });

        // toggle weeks field by flow choice
        const syncWeeksVisibility = () => {
            const show = $('#evFlow').value === 'SEASON_TOURNEY';
            $('#evWeeks').parentElement.style.display = show ? 'block' : 'none';
        };
        $('#evFlow').addEventListener('change', syncWeeksVisibility);
        syncWeeksVisibility();

        // Refresh list
        $('#btnRefreshEvents').addEventListener('click', () => loadEvents(STATE.current?.eventId));

        // Default
        $('#btnSetDefault').addEventListener('click', async () => {
            if (!STATE.current) return;
            const id = STATE.current.eventId;
            setBusy(true, 'Setting default…');
            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(() => resolve())
                        .withFailureHandler(err => reject(err))
                        .setDefaultEvent(id, true);
                });
                toast('Default updated');
                await loadEvents(id);
            } catch (err) {
                toast(err?.message || 'Failed to set default', false);
            } finally { setBusy(false); }
        });

        // Openers (use getShareLinks to resolve canonical URLs)
        $('#btnOpenPublic').addEventListener('click', () => {
            if (!STATE.current) return;
            setBusy(true, 'Opening…');
            google.script.run
                .withSuccessHandler(links => {
                    const url = links && links.publicUrl;
                    if (url) window.open(url, '_blank'); else toast('No public link yet', false);
                    setBusy(false);
                })
                .withFailureHandler(() => { toast('Failed to open public page', false); setBusy(false); })
                .getShareLinks(STATE.current.eventId);
        });

        $('#btnOpenSheets').addEventListener('click', () => {
            if (!STATE.current) return;
            setBusy(true, 'Opening Sheets…');
            google.script.run
                .withSuccessHandler((url) => { if (url) window.open(url, '_blank'); else toast('Sheet not found', false); setBusy(false); })
                .withFailureHandler((err) => { toast(err?.message || 'Open Sheets failed', false); setBusy(false); })
                .openSheetUrl(STATE.current.eventId);
        });

        // Signup Form creation
        $('#btnCreateForm').addEventListener('click', async () => {
            if (!STATE.current) return;
            const opts = {
                email: $('#optEmail').checked,
                phone: $('#optPhone').checked,
                notes: $('#optNotes').checked
            };
            setBusy(true, 'Creating form…');
            try {
                const res = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler((r) => resolve(r))
                        .withFailureHandler((err) => reject(err))
                        .buildSignupForm(STATE.current.eventId, opts);
                });
                toast('Signup form ready');
                // Reload event list so new formUrl populates; keep current selection
                await loadEvents(STATE.current.eventId);
                // Refresh Share block immediately to show QR + links
                refreshShareLinks();
            } catch (err) {
                toast(err?.message || 'Form creation failed', false);
            } finally { setBusy(false); }
        });

        // Seed column ensure
        $('#btnAddSeedCol').addEventListener('click', async () => {
            if (!STATE.current) return;
            setBusy(true, 'Ensuring seed column…');
            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(() => resolve())
                        .withFailureHandler((err) => reject(err))
                        .ensureSeedColumn(STATE.current.eventId);
                });
                toast('Seed column ensured');
            } catch (err) {
                toast(err?.message || 'Failed to add Seed column', false);
            } finally { setBusy(false); }
        });

        // Schedule scaffold
        $('#btnGenSchedule').addEventListener('click', async () => {
            if (!STATE.current) return;
            const w = Number($('#weeksEdit').value || STATE.current.weeks || 0);
            if (!w) { toast('Pick number of weeks', false); return; }
            setBusy(true, 'Generating schedule…');
            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(() => resolve())
                        .withFailureHandler((err) => reject(err))
                        .generateSchedule(STATE.current.eventId, w);
                });
                toast('Schedule scaffold generated');
                google.script.run.refreshPublicCache(STATE.current.eventId);
            } catch (err) {
                toast(err?.message || 'Failed to generate schedule', false);
            } finally { setBusy(false); }
        });

        // Brackets
        $('#elimTypeEdit').addEventListener('change', () => $('#brktStatus').textContent = '');
        $('#seedModeEdit').addEventListener('change', () => $('#brktStatus').textContent = '');

        $('#btnGenBrackets').addEventListener('click', async () => {
            if (!STATE.current) return;
            const opts = { elimType: $('#elimTypeEdit').value, seedMode: $('#seedModeEdit').value };
            setBusy(true, 'Generating bracket…');
            try {
                const res = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler((r) => resolve(r))
                        .withFailureHandler((err) => reject(err))
                        .generateBrackets(STATE.current.eventId, opts);
                });
                if (res && res.ok) {
                    toast('Bracket generated');
                    $('#brktStatus').textContent = `Mode: ${opts.elimType} · Seeding: ${opts.seedMode}`;
                    google.script.run.refreshPublicCache(STATE.current.eventId);
                } else if (res && res.reason === 'missing_seeds') {
                    if (confirm('Seeds are missing. Open Sheets to add 1..N seeds? (Cancel to generate Random)')) {
                        $('#btnOpenSheets').click();
                    } else {
                        const r2 = await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler((x) => resolve(x))
                                .withFailureHandler((err) => reject(err))
                                .generateBrackets(STATE.current.eventId, { elimType: opts.elimType, seedMode: 'RANDOM' });
                        });
                        if (r2 && r2.ok) {
                            toast('Bracket generated (Random)');
                            $('#seedModeEdit').value = 'RANDOM';
                            $('#brktStatus').textContent = `Mode: ${opts.elimType} · Seeding: RANDOM`;
                            google.script.run.refreshPublicCache(STATE.current.eventId);
                        } else {
                            toast('Failed to generate bracket', false);
                        }
                    }
                } else {
                    toast('Failed to generate bracket', false);
                }
            } catch (err) {
                toast(err?.message || 'Bracket generation failed', false);
            } finally { setBusy(false); }
        });

        $('#btnRefreshView').addEventListener('click', () => {
            if (!STATE.current) return;
            setBusy(true, 'Refreshing…');
            google.script.run
                .withSuccessHandler(() => { toast('Public cache refreshed'); setBusy(false); })
                .withFailureHandler(() => { toast('Refresh failed', false); setBusy(false); })
                .refreshPublicCache(STATE.current.eventId);
        });

        // Keep signup count tile fresh
        setInterval(() => {
            if (!STATE.current) return;
            google.script.run.withSuccessHandler((n) => {
                if (typeof n === 'number') $('#signupCountTile').textContent = n;
            }).getSignupCount(STATE.current.eventId);
        }, 15000);

        // Initial load
        document.addEventListener('DOMContentLoaded', () => loadEvents());
    </script>
</body>

</html>