<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> Â· Health Check</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <?!= include('Styles'); ?>
  <?!= include('NUSDK'); ?>
</head>
<body>
  <div class="container">
    <header>
      <h1>System Health</h1>
      <small class="muted">Build: <?= BUILD_ID ?></small>
    </header>
    
    <section class="card">
      <div class="row">
        <div class="col">
          <h2>Overall Status: <span id="overall-status" class="status">Checking...</span></h2>
        </div>
        <div class="col-auto">
          <button id="btn-refresh" class="btn-secondary">Refresh Now</button>
        </div>
      </div>
      
      <p class="muted" id="last-checked" style="margin-top: 10px;">
        Last checked: Never
      </p>
    </section>
    
    <section class="card">
      <h2>Component Health</h2>
      <div id="health-details">
        <p class="muted">Loading health data...</p>
      </div>
    </section>
    
    <section class="card">
      <h2>Quick Actions</h2>
      <div class="row">
        <button onclick="window.location.href='?page=admin'" class="btn-secondary">Admin</button>
        <button onclick="window.location.href='?page=test'" class="btn-secondary">Run Tests</button>
        <button onclick="window.location.href='?page=health'" class="btn-secondary">Refresh Health</button>
      </div>
    </section>
  </div>

<script>
async function checkHealth() {
  const statusEl = document.getElementById('overall-status');
  const detailsEl = document.getElementById('health-details');
  const lastCheckedEl = document.getElementById('last-checked');
  
  statusEl.textContent = 'Checking...';
  statusEl.className = 'status';
  
  try {
    const health = await NU.rpc('healthCheck');
    
    // Update overall status
    statusEl.textContent = health.overall.toUpperCase();
    statusEl.className = 'status status-' + health.overall;
    
    // Show details
    detailsEl.innerHTML = '';
    
    Object.entries(health.checks).forEach(([name, check]) => {
      const div = document.createElement('div');
      div.className = 'health-check-item';
      div.style.padding = '15px';
      div.style.marginBottom = '10px';
      div.style.border = '1px solid var(--border-color)';
      div.style.borderRadius = '8px';
      div.style.backgroundColor = 'var(--bg-surface)';
      
      const status = check.status || 'unknown';
      const statusClass = status === 'healthy' ? 'status-healthy' : 
                         status === 'degraded' || status === 'warning' ? 'status-warning' : 
                         'status-error';
      
      let details = '';
      if (check.latency) details += ` <span class="muted">(${check.latency}ms)</span>`;
      if (check.value) details += ` <span class="muted">${check.value}</span>`;
      if (check.utilization) details += ` <span class="muted">Utilization: ${check.utilization}</span>`;
      if (check.used !== undefined) details += ` <span class="muted">${check.used}/${check.available} used</span>`;
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong style="text-transform: capitalize;">${name}</strong>${details}
          </div>
          <span class="status ${statusClass}">${status.toUpperCase()}</span>
        </div>
        ${check.error ? `<div style="color: var(--danger); margin-top: 8px; font-size: 14px;">${check.error}</div>` : ''}
      `;
      
      detailsEl.appendChild(div);
    });
    
    // Update timestamp
    lastCheckedEl.textContent = 'Last checked: ' + new Date(health.timestamp).toLocaleString();
    
  } catch (err) {
    statusEl.textContent = 'ERROR';
    statusEl.className = 'status status-error';
    detailsEl.innerHTML = `<p style="color: var(--danger);">Failed to check health: ${err}</p>`;
    lastCheckedEl.textContent = 'Last checked: Failed';
  }
}

document.getElementById('btn-refresh').onclick = checkHealth;

// Initial check
checkHealth();

// Auto-refresh every 30 seconds
setInterval(checkHealth, 30000);
</script>

<style>
.status {
  font-weight: 600;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 14px;
}

.status-healthy {
  color: #4caf50;
  background: rgba(76, 175, 80, 0.1);
}

.status-degraded,
.status-warning {
  color: #ff9800;
  background: rgba(255, 152, 0, 0.1);
}

.status-error,
.status-unhealthy {
  color: #f44336;
  background: rgba(244, 67, 54, 0.1);
}

.status-unknown {
  color: #9e9e9e;
  background: rgba(158, 158, 158, 0.1);
}

.health-check-item {
  transition: transform 0.2s, box-shadow 0.2s;
}

.health-check-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
</style>
</body>
</html>