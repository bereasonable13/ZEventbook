<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title><?= appTitle ?> Â· Public</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <?!= include('Styles'); ?>
  <?!= include('NUSDK'); ?>
</head>
<body>

<div class="container">
  <header>
    <h1 id="event-name">Loading Event...</h1>
    <p id="event-date" class="muted"></p>
  </header>

  <section class="card">
    <h2>Join the Event</h2>
    <div id="qr-section">
      <div id="qr-status" class="status-verifying">Verifying...</div>
      <div id="qr-container" style="display:none; text-align:center;">
        <img id="qr-image" alt="Event QR Code" style="max-width:300px;" />
        <p class="muted">Scan or use the link below</p>
      </div>
    </div>

    <div id="link-section" style="margin-top:20px;">
      <label>Event Link</label>
      <div class="link-display">
        <input type="text" id="event-link" readonly />
        <button onclick="copyLink()">Copy</button>
      </div>
    </div>
  </section>

  <section class="card" id="signup-section" style="display:none;">
    <h2>Sign Up</h2>
    <a id="signup-link" href="#" target="_blank" class="btn-primary">Go to Sign-Up Form</a>
  </section>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const eventId = urlParams.get('eventId');

async function loadPublicPage() {
  if (!eventId) {
    document.getElementById('event-name').textContent = 'No event selected';
    return;
  }

  try {
    // Load event bundle
    const bundle = await NU.rpc('getPublicBundle', eventId);
    
    // Check for rate limit
    if (bundle.code === 429) {
      document.getElementById('event-name').textContent = 'Please wait a moment and refresh';
      document.getElementById('event-date').textContent = 'Too many requests - try again in ' + (bundle.retryAfter || 60) + ' seconds';
      return;
    }
    
    if (bundle.error) {
      document.getElementById('event-name').textContent = 'Event not found';
      return;
    }

    document.getElementById('event-name').textContent = bundle.event.name;
    document.getElementById('event-date').textContent = new Date(bundle.event.startDateISO).toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    // Set event link
    document.getElementById('event-link').value = window.location.href;

    // Load QR code
    await loadQRCode();

    // Load signup links
    await loadSignupLinks();

  } catch (err) {
    console.error('Public page error:', err);
    document.getElementById('event-name').textContent = 'Error loading event';
  }
}

async function loadQRCode() {
  try {
    const qr = await NU.rpc('getShareQrVerified', eventId);
    
    // Check for rate limit
    if (qr.code === 429) {
      document.getElementById('qr-status').textContent = 'Please wait and refresh';
      document.getElementById('qr-status').className = 'status-error';
      return;
    }
    
    if (qr.status === 'READY') {
      document.getElementById('qr-image').src = qr.qrCodeUrl;
      document.getElementById('qr-container').style.display = 'block';
      document.getElementById('qr-status').style.display = 'none';
    } else if (qr.status === 'VERIFYING') {
      document.getElementById('qr-status').textContent = 'QR code not ready yet';
      document.getElementById('qr-status').className = 'status-verifying';
    } else {
      document.getElementById('qr-status').textContent = 'QR code unavailable';
      document.getElementById('qr-status').className = 'status-error';
    }
  } catch (err) {
    console.error('QR load error:', err);
    document.getElementById('qr-status').textContent = 'Error loading QR';
    document.getElementById('qr-status').className = 'status-error';
  }
}

async function loadSignupLinks() {
  try {
    const links = await NU.rpc('getEventQuickLinks', eventId);
    
    // Check for rate limit
    if (links.code === 429) {
      return; // Silent fail for signup links
    }
    
    if (links.error || !links.links.signupUrl) {
      return; // No signup form configured
    }

    document.getElementById('signup-link').href = links.links.signupUrl;
    document.getElementById('signup-section').style.display = 'block';

  } catch (err) {
    console.error('Signup links error:', err);
  }
}

function copyLink() {
  const input = document.getElementById('event-link');
  input.select();
  document.execCommand('copy');
  alert('Link copied to clipboard!');
}

window.addEventListener('DOMContentLoaded', loadPublicPage);
</script>

<style>
.status-verifying {
  color: #ff9800;
  font-weight: 600;
  padding: 10px;
  text-align: center;
}

.status-ready {
  color: #4caf50;
  font-weight: 600;
}

.status-error {
  color: #f44336;
  font-weight: 600;
  padding: 10px;
  text-align: center;
}

.link-display {
  display: flex;
  gap: 8px;
}

.link-display input {
  flex: 1;
}
</style>

</body>
</html>